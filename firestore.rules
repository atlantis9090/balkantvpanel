rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== YARDIMCI FONKSİYONLAR =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // ===== MAIL KOLEKSİYONU =====
    match /mail/{document=**} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAdmin();
    }
    
    // ===== GÜVENLİ KONFİGÜRASYON =====
    match /secure_config/{document=**} {
      allow read, write: if false;
    }

    // ===== IPTV KULLANICILARI =====
    match /artifacts/{appId}/public/data/iptv_users/{userId} {
      // TEKİL OKUMA: Giriş yapan kullanıcı kendi belgesini okuyabilir (login için gerekli)
      allow get: if isAuthenticated();
      // LİSTE SORGUSU: Sadece admin tüm kullanıcıları listeleyebilir
      allow list: if isAdmin();
      // Kullanıcı kendi belgesini kısmen güncelleyebilir
      allow update: if isAuthenticated() 
        && request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['lastLoginDate', 'dismissedMessages', 'sessionToken']);
      // Oluşturma ve silme sadece admin
      allow create, delete: if isAdmin();
      // Admin tam yazma yetkisi
      allow update: if isAdmin();
    }
    
    // ===== YENİLEME TALEPLERİ =====
    match /artifacts/{appId}/public/data/renewal_requests/{requestId} {
      // Okuma sadece admin
      allow read: if isAdmin();
      // Giriş yapmış kullanıcılar talep oluşturabilir
      allow create: if isAuthenticated();
      // Güncelleme ve silme sadece admin
      allow update, delete: if isAdmin();
    }
    
    // ===== YENİ HESAP TALEPLERİ =====
    match /artifacts/{appId}/public/data/new_account_requests/{requestId} {
      // Okuma sadece admin
      allow read: if isAdmin();
      // Giriş yapmış kullanıcılar talep oluşturabilir
      allow create: if isAuthenticated();
      // Güncelleme ve silme sadece admin
      allow update, delete: if isAdmin();
    }
    
    // ===== MESAJLAR (Broadcast) =====
    match /artifacts/{appId}/public/data/messages/{messageId} {
      // Herkes okuyabilir (duyurular)
      allow read: if isAuthenticated();
      // Sadece admin yazabilir
      allow create, update, delete: if isAdmin();
    }

    // ===== KONUŞMALAR =====
    match /artifacts/{appId}/public/data/conversations/{conversationId} {
      // Tekil okuma (kendi konuşması): herkese açık
      allow get: if isAuthenticated();
      // Tüm konuşmaları listeleme: sadece admin
      allow list: if isAdmin();
      // Oluşturma ve güncelleme: authenticated
      allow create, update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    match /artifacts/{appId}/public/data/conversations/{conversationId}/messages/{messageId} {
      // Kendi konuşma mesajlarını okuyabilir
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }
    
    // ===== AYARLAR =====
    match /artifacts/{appId}/public/data/settings/{settingId} {
      // global ve price_list herkese açık okuma (iyzico kaldırıldı)
      allow read: if isAuthenticated() && settingId in ['global', 'price_list'];
      // admin ayarları sadece admin okuyabilir
      allow read: if isAdmin();
      // Yazma sadece admin
      allow write: if isAdmin();
    }
    
    // ===== ÖDEMELER =====
    match /artifacts/{appId}/public/data/payments/{paymentId} {
      allow create: if isAuthenticated();
      allow read, update, delete: if isAdmin();
    }

    // ===== ABONELİK LOGLARI (GELİR/GİDER) =====
    match /artifacts/{appId}/public/data/subscription_logs/{logId} {
      // Sadece admin tam yetki — kullanıcılar erişemez
      allow read, write: if isAdmin();
    }

    // ===== DİĞER TÜM KOLEKSİYONLAR =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
