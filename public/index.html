<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balkan IPTV - M√º≈üteri Merkezi</title>
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Balkan IPTV">
    <link rel="apple-touch-icon" href="/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-96.png">
    <meta name="description" content="IPTV abonelik y√∂netimi ve m√º≈üteri paneli">
    <!-- Preconnect Hints -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://us-central1-balkantvpanel.cloudfunctions.net">
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firebasestorage.googleapis.com" crossorigin>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { darkMode: 'class' }</script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fef3e3;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        /* Dark Mode */
        html.dark body { background-color: #1a1a2e; color: #e0e0e0; }
        html.dark .main-card { background-color: #16213e !important; border-color: #0f3460; }
        html.dark .bg-white { background-color: #16213e !important; }
        html.dark .bg-gray-50, html.dark .bg-gray-100 { background-color: #1a1a2e !important; }
        html.dark .bg-gray-200 { background-color: #0f3460 !important; }
        html.dark .text-gray-700, html.dark .text-gray-800 { color: #e0e0e0 !important; }
        html.dark .text-gray-500, html.dark .text-gray-600 { color: #a0a0b0 !important; }
        html.dark .border-gray-200, html.dark .border-gray-100, html.dark .border-gray-300 { border-color: #0f3460 !important; }
        html.dark .border { border-color: #0f3460 !important; }
        html.dark input, html.dark select, html.dark textarea { background-color: #1a1a2e !important; color: #e0e0e0 !important; border-color: #0f3460 !important; }
        html.dark .shadow-inner { box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3) !important; }
        html.dark .shadow-md, html.dark .shadow-lg { box-shadow: 0 4px 12px rgba(0,0,0,0.4) !important; }
        html.dark .hover\:bg-orange-100:hover { background-color: rgba(249,115,22,0.15) !important; }
        html.dark .hover\:bg-gray-50:hover, html.dark .hover\:bg-blue-50:hover, html.dark .hover\:bg-orange-50:hover { background-color: rgba(255,255,255,0.05) !important; }
        html.dark .user-row:hover { background-color: rgba(255,255,255,0.05) !important; }
        html.dark .bg-orange-100 { background-color: rgba(249,115,22,0.2) !important; }
        html.dark .bg-blue-50, html.dark .bg-orange-50, html.dark .bg-purple-50 { background-color: rgba(99,102,241,0.1) !important; }
        html.dark .bg-green-50, html.dark .bg-green-100 { background-color: rgba(16,185,129,0.1) !important; }
        html.dark .bg-gray-100.font-mono, html.dark .font-mono.bg-gray-100 { background-color: #0f3460 !important; }
        html.dark .text-orange-800 { color: #fdba74 !important; }
        html.dark .text-orange-700 { color: #fb923c !important; }
        html.dark .text-green-700 { color: #6ee7b7 !important; }
        html.dark .text-green-600 { color: #34d399 !important; }
        html.dark .text-red-600 { color: #fca5a5 !important; }
        html.dark .text-blue-600 { color: #93c5fd !important; }
        html.dark .text-blue-800 { color: #93c5fd !important; }
        html.dark .text-purple-600 { color: #c4b5fd !important; }
        html.dark code { background-color: #1a1a2e !important; color: #fdba74 !important; }
        html.dark .bg-orange-50 code, html.dark .bg-green-50 code { background-color: rgba(0,0,0,0.2) !important; }
        html.dark .border-green-300 { border-color: #065f46 !important; }
        html.dark .border-green-400, html.dark .ring-green-400 { border-color: #059669 !important; }
        html.dark .border-yellow-400, html.dark .ring-yellow-400 { border-color: #d97706 !important; }
        html.dark .border-gray-100 { border-color: #0f3460 !important; }
        html.dark .bg-gray-200.px-1 { background-color: #0f3460 !important; }
        html.dark .modal-content { background-color: #16213e !important; }
        html.dark .modal-overlay { background: rgba(0,0,0,0.75) !important; }
        html.dark #adminContent { background-color: #0f0f23 !important; }
        html.dark #appLogo { filter: brightness(2) contrast(1.1) drop-shadow(0 0 20px rgba(249,115,22,0.7)) drop-shadow(0 0 40px rgba(255,255,255,0.2)); background: rgba(255,255,255,0.85); border-radius: 20px; padding: 12px; }
        .dark-toggle { transition: all 0.3s ease; }
        .main-card {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
        }
        .admin-toggle-icon {
            transition: transform 0.3s;
        }
        /* Y√∂netici ve Kullanƒ±cƒ± G√∂r√ºn√ºmleri */
        .admin-view, .user-view, .user-panel-view, #newAccountRequestContainer {
            display: none;
        }
        #loginForm.hidden {
             display: none;
        }
        .user-row:hover {
            background-color: #fef8f4;
        }
        .metric-card {
            transition: all 0.3s cubic-bezier(.4,0,.2,1);
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, transparent 60%);
            pointer-events: none;
        }
        .metric-card:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 12px 24px -4px rgba(0,0,0,0.15);
        }
        /* Admin nav responsive */
        @media (max-width: 640px) {
            .admin-nav-bar {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 4px;
            }
            .admin-nav-bar > button,
            .admin-nav-bar > details {
                width: 100%;
                text-align: center;
                font-size: 0.75rem;
                padding: 8px 4px;
            }
            .admin-nav-bar > details > summary {
                font-size: 0.75rem;
                padding: 8px 4px;
                justify-content: center;
            }
        }
        /* Accordion arrow */
        .accordion-toggle .accordion-icon {
            transition: transform 0.3s;
        }
        .accordion-toggle[aria-expanded='true'] .accordion-icon {
            transform: rotate(180deg);
        }
        /* Turuncu Renk Paleti */
        .color-primary { background-color: #f97316; } /* Orange 600 */
        .color-secondary { background-color: #fb923c; } /* Orange 400 */
        .text-primary { color: #f97316; }
        .border-primary { border-color: #f97316; }

        /* Yeni Link Bildirim Animasyonu */
        @keyframes newLinkPulse {
            0%, 100% { background-color: #fef3c7; }
            50% { background-color: #fde68a; }
        }
        .new-link-badge {
            animation: newLinkPulse 2s ease-in-out infinite;
        }

        /* PWA Install Animasyonlarƒ± */
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Modal Stilleri */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        /* Logo Animasyonlarƒ± */
        @keyframes logoFadeIn {
            from { opacity: 0; transform: translateY(-15px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes logoPulse {
            0%, 100% { filter: drop-shadow(0 0 0px rgba(249, 115, 22, 0)); }
            50% { filter: drop-shadow(0 0 12px rgba(249, 115, 22, 0.35)); }
        }
        /* Skeleton Loading */
        @keyframes shimmer {
            0% { background-position: -468px 0; }
            100% { background-position: 468px 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 936px 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        .skeleton-text {
            height: 14px;
            margin-bottom: 8px;
            border-radius: 4px;
        }
        .skeleton-title {
            height: 20px;
            width: 60%;
            margin-bottom: 12px;
            border-radius: 4px;
        }
        .skeleton-card {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        html.dark .skeleton {
            background: linear-gradient(90deg, #1a1a2e 25%, #16213e 50%, #1a1a2e 75%);
            background-size: 936px 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
            transform: translateY(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .offline-banner.visible {
            transform: translateY(0);
        }
        /* Dark Mode Ge√ßi≈ü Animasyonu */
        html.dark-transition,
        html.dark-transition *,
        html.dark-transition *::before,
        html.dark-transition *::after {
            transition: background-color 0.4s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
        }
        /* Geri Sayƒ±m Widget */
        .countdown-widget {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 16px;
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .countdown-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            pointer-events: none;
        }
        .countdown-widget.expiring-soon {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            animation: countdownPulse 2s ease-in-out infinite;
        }
        .countdown-widget.expired {
            background: linear-gradient(135deg, #6b7280 0%, #374151 100%);
        }
        @keyframes countdownPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(220, 38, 38, 0); }
        }
        .countdown-number {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
        }
        .countdown-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            opacity: 0.85;
            letter-spacing: 0.5px;
        }
        /* Bildirim toast animasyonu */
        @keyframes notificationSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .realtime-notification {
            animation: notificationSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
        ‚ö†Ô∏è ƒ∞nternet baƒülantƒ±nƒ±z yok ‚Äî √áevrimdƒ±≈üƒ± moddasƒ±nƒ±z
    </div>
    
    <!-- Ger√ßek Zamanlƒ± Bildirim Container -->
    <div id="realtimeNotifications" class="fixed top-16 right-4 z-[9997] space-y-2 max-w-sm"></div>

    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="dark-toggle fixed top-4 right-4 z-[9998] bg-gray-800 hover:bg-gray-700 text-yellow-400 rounded-full p-3 shadow-xl border-2 border-yellow-400/30 hover:border-yellow-400/60" title="Tema Deƒüi≈ütir">
        <svg id="darkModeIcon" class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        <svg id="lightModeIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
    </button>

    <!-- PWA Kurulum Bannerƒ± -->
    <div id="pwaInstallBanner" class="hidden fixed bottom-0 left-0 right-0 z-[9999] p-4 bg-gradient-to-r from-orange-500 to-orange-600 shadow-2xl safe-bottom" style="animation: slideUp 0.4s ease-out;">
        <div class="max-w-lg mx-auto flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <img src="/icons/icon-72.png" alt="" class="w-10 h-10 rounded-xl shadow" loading="lazy" width="40" height="40">
                <div class="text-white">
                    <p class="font-bold text-sm">Balkan IPTV</p>
                    <p class="text-xs text-orange-100">Ana ekrana ekle, uygulama gibi kullan!</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button id="pwaInstallDismiss" class="py-1.5 px-3 text-orange-100 hover:text-white text-xs font-medium">Sonra</button>
                <button id="pwaInstallAccept" class="py-1.5 px-4 bg-white text-orange-600 rounded-full text-xs font-bold shadow hover:shadow-lg transition-all flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 3v12m0 0l-4-4m4 4l4-4"/></svg>
                    Kur
                </button>
            </div>
        </div>
    </div>

    <!-- PWA K√º√ß√ºk Kurulum Butonu (Header'da) -->
    <button id="pwaInstallMini" class="hidden fixed top-3 right-3 z-[9998] bg-orange-500 hover:bg-orange-600 text-white rounded-full px-3 py-1.5 text-xs font-bold shadow-lg flex items-center gap-1 transition-all" style="animation: fadeIn 0.3s ease-out;">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 3v12m0 0l-4-4m4 4l4-4"/></svg>
        Y√ºkle
    </button>

    <!-- Ana Ba≈ülƒ±k ve Uygulama Alanƒ± -->
    <div class="w-full max-w-5xl bg-white main-card rounded-3xl p-4 sm:p-8 transform hover:shadow-xl transition-all duration-300">
        <!-- Logo -->
        <div class="flex justify-center mb-4">
            <a href="https://www.balkanpremiumtv.de/" target="_blank" rel="noopener noreferrer" class="inline-block group" title="Balkan Premium TV">
                <img id="appLogo" src="https://firebasestorage.googleapis.com/v0/b/balkantvpanel.firebasestorage.app/o/logo.png?alt=media" 
                     alt="Balkan Premium TV" 
                     class="h-20 sm:h-24 w-auto object-contain transition-all duration-500 group-hover:scale-110 group-hover:drop-shadow-lg" 
                     style="animation: logoFadeIn 1s ease-out, logoPulse 3s ease-in-out 1s infinite;"
                     loading="lazy" decoding="async" fetchpriority="high"
                     onerror="this.style.display='none'">
            </a>
        </div>
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-orange-700 mb-2">
            BALKAN IPTV M√º≈üteri Merkezi
        </h1>
        <p class="text-center text-gray-500 mb-8">
            G√ºncel baƒülantƒ± URL'nizi ve abonelik detaylarƒ±nƒ±zƒ± kontrol edin.
        </p>
        
        <!-- Kimlik Doƒürulama Durumu (Debug Ama√ßlƒ±) -->
        <div id="authStatus" class="text-xs sm:text-sm text-center mb-4 p-2 rounded-xl bg-orange-100 text-orange-700 font-medium hidden">
            Sistem Baƒülantƒ±sƒ± Kuruluyor...
        </div>

        <!-- M√º≈üteri/Admin Giri≈ü Formu (Ortak) -->
        <form id="loginForm" class="space-y-4 mb-8 p-4 sm:p-6 border border-gray-100 rounded-xl bg-white shadow-inner">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-700 flex items-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                Oturum A√ß
            </h2>
            <label for="iptvUsernameInput" class="block text-sm font-medium text-gray-700">Kullanƒ±cƒ± Adƒ±:</label>
            <input type="text" id="iptvUsernameInput" placeholder="Kullanƒ±cƒ± adƒ±nƒ±zƒ± buraya girin..."
                           class="w-full px-4 py-2 border border-orange-200 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
            
            <label for="iptvPasswordInput" class="block text-sm font-medium text-gray-700">≈ûifre:</label>
            <input type="password" id="iptvPasswordInput" placeholder="≈ûifrenizi buraya girin..."
                           class="w-full px-4 py-2 border border-orange-200 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                           
            <button id="loginButton" type="submit"
                            class="w-full flex justify-center py-3 px-4 rounded-xl shadow-lg text-lg font-bold text-white bg-orange-600 hover:bg-orange-700 transition-all duration-300 transform hover:scale-[1.01]"
                            disabled>
                Giri≈ü Yap
            </button>
            
            <!-- HESAP OLU≈ûTURMA BUTONU -->
            <button id="showNewAccountFormButton" type="button"
                            class="w-full flex justify-center py-2 px-4 rounded-xl text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 mt-3 transition-colors">
                √úye Deƒüil misiniz? Hesap Olu≈üturma Talebi
            </button>
        </form>
        
        <!-- YENƒ∞ HESAP OLU≈ûTURMA TALEBƒ∞ FORMU -->
        <div id="newAccountRequestContainer" class="space-y-4 mb-8 p-4 sm:p-6 border border-orange-300 rounded-xl bg-orange-50 shadow-inner">
            <h2 class="text-xl sm:text-2xl font-bold text-orange-700 flex items-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="18" y1="8" x2="18" y2="10"></line><line x1="18" y1="14" x2="18" y2="16"></line></svg>
                Yeni Hesap Talebi
            </h2>
            <p class="text-sm text-gray-600">L√ºtfen y√∂neticinin size d√∂n√º≈ü yapabilmesi i√ßin bilgilerinizi eksiksiz doldurunuz.</p>
            
            <!-- Bilgilendirme Notu -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-start space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <p class="text-xs text-blue-700">Her telefon numarasƒ± ile yalnƒ±zca <strong>1 kez</strong> hesap talebi olu≈üturulabilir. Talebiniz onaylandƒ±ktan sonra giri≈ü bilgileriniz size iletilecektir.</p>
            </div>

            <!-- Hesap Bilgileri Sonu√ß Kutusu (Talep sonrasƒ± g√∂sterilir) -->
            <div id="newAccountCredentialsBox" class="hidden bg-green-50 border-2 border-green-400 rounded-xl p-4 space-y-3">
                <h3 class="text-lg font-bold text-green-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Hesap Bilgileriniz
                </h3>
                <p class="text-sm text-gray-600">A≈üaƒüƒ±daki bilgilerinizi not ediniz. Admin onayƒ±ndan sonra bu bilgilerle giri≈ü yapabilirsiniz.</p>
                <div class="bg-white rounded-lg p-3 space-y-2 border border-green-200">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">üë§ Kullanƒ±cƒ± Adƒ±:</span>
                        <code id="generatedUsername" class="bg-green-100 text-green-800 px-3 py-1 rounded-md font-bold text-sm"></code>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">üîë ≈ûifre:</span>
                        <code id="generatedPassword" class="bg-green-100 text-green-800 px-3 py-1 rounded-md font-bold text-sm"></code>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-2">
                    <p class="text-xs text-yellow-800 font-semibold">‚ö†Ô∏è Bu bilgileri mutlaka kaydediniz! Admin onayƒ±ndan sonra bu kullanƒ±cƒ± adƒ± ve ≈üifre ile giri≈ü yapabileceksiniz.</p>
                </div>
            </div>

            <!-- 1. Ad Soyad -->
            <div>
                <label for="newAccountNameInput" class="block text-sm font-medium text-gray-700 mb-1">Ad Soyad:</label>
                <input type="text" id="newAccountNameInput" placeholder="Adƒ±nƒ±z ve Soyadƒ±nƒ±z"
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
            </div>

            <!-- 2. Telefon Numarasƒ± -->
            <div>
                <label for="newAccountPhoneInput" class="block text-sm font-medium text-gray-700 mb-1">Telefon Numaranƒ±z:</label>
                <input type="tel" id="newAccountPhoneInput" placeholder="√ñrn: 5xx xxx xx xx"
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                <p class="text-xs text-gray-500 mt-1">WhatsApp √ºzerinden bilgilendirme yapƒ±lacaktƒ±r.</p>
            </div>

            <!-- 3. E-posta -->
            <div>
                <label for="newAccountEmailInput" class="block text-sm font-medium text-gray-700 mb-1">E-posta Adresiniz:</label>
                <input type="email" id="newAccountEmailInput" placeholder="E-posta adresinizi girin..."
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
            </div>

            <!-- 4. Kullanƒ±m Alanƒ± (√ñNCELƒ∞KLƒ∞) -->
            <div>
                <label for="newAccountTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Kullanƒ±m Alanƒ±:</label>
                <select id="newAccountTypeSelect"
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                    <option value="" disabled selected>-- Yurti√ßi mi, Yurtdƒ±≈üƒ± mƒ±? --</option>
                    <option value="YURTICI">üáπüá∑ Yurti√ßi</option>
                    <option value="YURTDISI">üåç Yurtdƒ±≈üƒ±</option>
                </select>
            </div>

            <!-- 5. √úyelik S√ºresi (Kullanƒ±m Alanƒ±na G√∂re Dinamik) -->
            <div id="newAccountDurationWrapper" class="hidden">
                <label for="newAccountDurationSelect" class="block text-sm font-medium text-gray-700 mb-1">√úyelik S√ºresi:</label>
                <select id="newAccountDurationSelect"
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                    <option value="" disabled selected>-- S√ºre Se√ßin --</option>
                </select>
            </div>

            <!-- Spam Uyarƒ±sƒ± -->
            <p id="newAccountPhoneError" class="text-xs text-red-600 hidden"></p>

            <button id="submitNewAccountRequestButton"
                class="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                Hesap Olu≈üturma Talebini G√∂nder
            </button>
            <button id="hideNewAccountFormButton"
                class="w-full py-2 text-sm font-medium text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg transition-colors mt-2">
                Giri≈ü Ekranƒ±na Geri D√∂n
            </button>
        </div>
        
        <!-- M√º≈üteri (User) G√ñR√úN√úM√ú -->
        <div id="userView" class="user-view">
            <!-- Header ve √áƒ±kƒ±≈ü Butonu -->
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 id="userWelcomeHeader" class="text-xl sm:text-2xl font-bold text-orange-700">Ho≈ü Geldiniz!</h3>
                <button id="userLogoutButton" class="py-1 px-4 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm transition-colors shadow-md">
                    √áƒ±kƒ±≈ü Yap
                </button>
            </div>

            <!-- M√ú≈ûTERƒ∞ MEN√úS√ú (G√úNCELLENDƒ∞) -->
            <nav class="flex flex-wrap space-x-1 border-b pb-2 mb-6">
                <button id="navUserInfo" class="py-2 px-4 text-sm font-semibold rounded-t-lg bg-orange-600 text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Hesap Bilgilerim
                </button>
                <button id="navUserRenewal" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6m6 0l-7 7-3-3m-7 7l3 3m0-3l7-7m-7 7V16a5 5 0 015-5h2a5 5 0 015 5v2"></path></svg>
                    √úyelik Uzatma
                </button>
                <!-- YENƒ∞: Fƒ∞YAT Lƒ∞STESƒ∞ -->
                <button id="navPriceList" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                    Fiyat Listesi
                </button>
                <button id="navUserMessages" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors inline-flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    Mesajlar
                </button>
            </nav>
            
            <!-- 1. HESAP Bƒ∞LGƒ∞LERƒ∞M G√ñR√úN√úM√ú -->
            <div id="userInfoView" class="user-panel-view"> 
                <!-- Hesap S√ºresi Geri Sayƒ±m Widget -->
                <div id="countdownWidget" class="countdown-widget mt-4 mb-4 hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm opacity-90 font-medium">‚è≥ √úyelik Biti≈ü S√ºreniz</p>
                            <p id="countdownDate" class="text-xs opacity-75 mt-1"></p>
                        </div>
                        <div id="countdownTimer" class="flex gap-3 text-center">
                            <div><span id="cdDays" class="countdown-number">--</span><p class="countdown-label">G√ºn</p></div>
                            <div><span id="cdHours" class="countdown-number">--</span><p class="countdown-label">Saat</p></div>
                            <div><span id="cdMins" class="countdown-number">--</span><p class="countdown-label">Dk</p></div>
                            <div><span id="cdSecs" class="countdown-number">--</span><p class="countdown-label">Sn</p></div>
                        </div>
                    </div>
                    <div id="countdownProgress" class="mt-3 h-2 bg-white/20 rounded-full overflow-hidden">
                        <div id="countdownBar" class="h-full bg-white/60 rounded-full transition-all duration-1000" style="width: 100%"></div>
                    </div>
                    <p id="countdownMessage" class="text-xs opacity-80 mt-2 text-center"></p>
                </div>

                <!-- Skeleton Loading -->
                <div id="userDataSkeleton" class="mt-8 p-4 sm:p-6 border border-gray-200 rounded-xl bg-white shadow-lg hidden">
                    <div class="skeleton skeleton-title"></div>
                    <div class="space-y-2">
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                        <div class="skeleton skeleton-card" style="height: 52px;"></div>
                    </div>
                </div>

                <div id="resultContainer" class="mt-8 p-4 sm:p-6 border border-green-200 rounded-xl bg-green-50 shadow-lg">
                    <h2 class="text-xl sm:text-2xl font-bold text-green-700 border-b-2 border-green-300 pb-3 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        G√ºncel Abonelik Bilgileri
                        <span id="subscriptionStatusBadge" class="ml-3 text-xs font-bold px-3 py-1 rounded-full"></span>
                    </h2>
                    <div id="userDataDisplay" class="space-y-4">
                        <!-- Veriler buraya y√ºklenecek -->
                    </div>

                    <div class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg text-sm text-yellow-800">
                        <p class="font-bold">‚ö†Ô∏è Yeni Baƒülantƒ± Uyarƒ±sƒ±:</p>
                        <p>Yeni URL'niz aktif edilmi≈ütir. Oynatƒ±cƒ±nƒ±za kopyalayƒ±p yapƒ±≈ütƒ±rƒ±nƒ±z. Sorun ya≈üarsanƒ±z l√ºtfen y√∂neticinizle ileti≈üime ge√ßin.</p>
                    </div>
                </div>
            </div>

            <!-- 2. √úYELƒ∞K UZATMA G√ñR√úN√úM√ú -->
            <div id="userRenewalView" class="user-panel-view hidden">
                <div id="renewalFormContainer" class="mt-8 p-4 sm:p-6 bg-orange-100 border border-orange-300 rounded-xl space-y-4 shadow-md">
                    <h3 class="text-lg sm:text-xl font-bold text-orange-700 flex items-center border-b pb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10l3 3m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Yeni √úyelik Uzatma Talebi
                    </h3>
                    
                    <label for="renewalDuration" class="block text-sm font-medium text-gray-700">Uzatma S√ºresi Se√ßiniz:</label>
                    <select id="renewalDuration"
                                 class="w-full px-4 py-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                        <option value="" disabled selected>-- S√ºre Se√ßin --</option>
                        <option value="3 Ay">3 Ay</option>
                        <option value="6 Ay">6 Ay</option>
                        <option value="12 Ay">12 Ay</option>
                        <option value="15 Ay">15 Ay</option>
                    </select>

                    <label for="renewalUserTypeSelect" class="block text-sm font-medium text-gray-700">√úyelik Tipi Onayƒ± (Gerekli):</label>
                    <select id="renewalUserTypeSelect"
                                 class="w-full px-4 py-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">
                        <option value="" disabled selected>-- Mevcut Tipi Onaylayƒ±n --</option>
                        <option value="YURTICI">Yurti√ßi</option>
                        <option value="YURTDISI">Yurtdƒ±≈üƒ±</option>
                    </select>

                    <label for="phoneNumberInput" class="block text-sm font-medium text-gray-700">Telefon Numaranƒ±z (ƒ∞leti≈üim i√ßin):</label>
                    <input type="tel" id="phoneNumberInput" placeholder="√ñrn: 5xx xxx xx xx"
                                 class="w-full px-4 py-2 border border-orange-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 transition-shadow">

                    <button id="sendRenewalRequestButton"
                                 class="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-xl font-bold transition-colors disabled:opacity-50 shadow-lg">
                        Uzatma Talebini G√∂nder
                    </button>
                    <p class="text-xs text-center text-orange-800 pt-2">Talebiniz bize ula≈ütƒ±ktan sonra size geri d√∂n√º≈ü yapƒ±lacaktƒ±r.</p>
                    
                    <!-- VEYA √ßizgisi -->
                    <div class="flex items-center my-4">
                        <div class="flex-grow border-t border-orange-300"></div>
                        <span class="mx-4 text-sm font-bold text-orange-600 bg-orange-100 px-3 py-1 rounded-full">VEYA</span>
                        <div class="flex-grow border-t border-orange-300"></div>
                    </div>

                    <!-- Online √ñdeme B√∂l√ºm√º - Accordion -->
                    <div id="iyzicoAccordionWrapper" class="bg-white rounded-2xl shadow-lg border-2 border-green-200 overflow-hidden">
                        <!-- Accordion Ba≈ülƒ±k (Tƒ±klanabilir) -->
                        <button id="iyzicoAccordionToggle" type="button" 
                            class="w-full flex items-center justify-between p-4 sm:p-5 hover:bg-green-50 transition-colors duration-200 focus:outline-none">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                                </div>
                                <div class="text-left">
                                    <h4 class="text-base sm:text-lg font-bold text-gray-800">Kredi Kartƒ± ile √ñdeme</h4>
                                    <p class="text-xs text-gray-500">Online √∂deme ile hemen uzatƒ±n</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- Aktif/Devre Dƒ±≈üƒ± Badge -->
                                <span id="iyzicoUserStatusBadge" class="px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-600 border border-red-200">
                                    ‚õî Devre Dƒ±≈üƒ±
                                </span>
                                <!-- Chevron -->
                                <svg id="iyzicoAccordionChevron" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </button>

                        <!-- Accordion ƒ∞√ßerik (Gizli - Tƒ±klayƒ±nca A√ßƒ±lƒ±r) -->
                        <div id="iyzicoAccordionContent" class="hidden border-t border-green-200">
                            <div class="p-4 sm:p-6 space-y-4">

                                <!-- G√ºvenlik Bilgilendirme Mesajƒ± -->
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                    <div class="flex items-start space-x-3">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0 mt-0.5">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                                        </div>
                                        <div class="flex-1">
                                            <h5 class="text-sm font-bold text-blue-800 mb-1">üîí G√ºvenli √ñdeme Garantisi</h5>
                                            <ul class="text-xs text-blue-700 space-y-1.5">
                                                <li class="flex items-start"><span class="mr-1.5 mt-0.5">‚úÖ</span> Kart bilgileriniz <strong>kesinlikle sistemimizde saklanmaz</strong></li>
                                                <li class="flex items-start"><span class="mr-1.5 mt-0.5">‚úÖ</span> T√ºm √∂demeler <strong>iyzico altyapƒ±sƒ±</strong> √ºzerinden g√ºvenle i≈ülenir</li>
                                                <li class="flex items-start"><span class="mr-1.5 mt-0.5">‚úÖ</span> <strong>256-bit SSL</strong> ≈üifreleme ile verileriniz korunur</li>
                                                <li class="flex items-start"><span class="mr-1.5 mt-0.5">‚úÖ</span> <strong>3D Secure</strong> doƒürulama ile ekstra g√ºvenlik</li>
                                                <li class="flex items-start"><span class="mr-1.5 mt-0.5">‚úÖ</span> iyzico, <strong>BDDK lisanslƒ±</strong> √∂deme kurulu≈üudur</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Devre Dƒ±≈üƒ± Uyarƒ±sƒ± (iyzico kapalƒ±yken g√∂r√ºn√ºr) -->
                                <div id="iyzicoDisabledNotice" class="bg-yellow-50 border border-yellow-300 rounded-xl p-4 text-center">
                                    <div class="flex flex-col items-center space-y-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                        </svg>
                                        <p class="font-bold text-yellow-800">Online √∂deme ≈üu anda aktif deƒüildir</p>
                                        <p class="text-xs text-yellow-700">√ñdeme sistemi yakƒ±nda hizmetinize sunulacaktƒ±r. L√ºtfen √ºstteki formu kullanarak uzatma talebi g√∂nderiniz.</p>
                                    </div>
                                </div>

                                <!-- iyzico Aktifken G√∂r√ºnecek √ñdeme Alanƒ± -->
                                <div id="iyzicoActivePaymentArea" class="hidden space-y-4">
                                    <p class="text-sm text-gray-500">S√ºre se√ßin, hemen √∂deyin, aboneliƒüiniz anƒ±nda uzatƒ±lsƒ±n.</p>

                                    <!-- Paket Se√ßimi Kartlarƒ± -->
                                    <div id="iyzicoPackageCards" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <!-- JS ile doldurulacak -->
                                    </div>

                                    <!-- Se√ßilen Paketin √ñzeti -->
                                    <div id="iyzicoSelectedSummary" class="hidden bg-green-50 border border-green-300 rounded-xl p-4 space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium text-gray-700">Se√ßilen Paket:</span>
                                            <span id="iyzicoSelectedPackage" class="font-bold text-green-700"></span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium text-gray-700">Tutar:</span>
                                            <span id="iyzicoSelectedPrice" class="font-bold text-2xl text-green-700"></span>
                                        </div>
                                    </div>

                                    <!-- Kart Bilgileri Formu -->
                                    <div id="iyzicoCardForm" class="hidden space-y-3">
                                        <!-- Kart G√ºvenlik Notu -->
                                        <div class="flex items-center bg-gray-50 rounded-lg p-2.5 border border-gray-200">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-500 mr-2 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                            <p class="text-[11px] text-gray-500">Kart bilgileriniz doƒürudan iyzico g√ºvenli sunucularƒ±na iletilir. Bilgileriniz tarafƒ±mƒ±zca g√∂r√ºnt√ºlenemez ve saklanamaz.</p>
                                        </div>
                                        <div class="bg-gray-50 rounded-xl p-4 space-y-3 border">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Kart √úzerindeki ƒ∞sim</label>
                                                <input type="text" id="iyzicoCardName" placeholder="Ad Soyad" 
                                                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-green-500 focus:border-green-500">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 mb-1">Kart Numarasƒ±</label>
                                                <input type="text" id="iyzicoCardNumber" placeholder="0000 0000 0000 0000" maxlength="19"
                                                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-mono tracking-wider focus:ring-green-500 focus:border-green-500">
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">Son Kullanma</label>
                                                    <input type="text" id="iyzicoCardExpiry" placeholder="AA/YY" maxlength="5"
                                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-mono focus:ring-green-500 focus:border-green-500">
                                                </div>
                                                <div>
                                                    <label class="block text-xs font-medium text-gray-600 mb-1">CVV</label>
                                                    <input type="text" id="iyzicoCardCvv" placeholder="000" maxlength="4"
                                                        class="w-full px-4 py-2.5 border border-gray-300 rounded-lg text-sm font-mono focus:ring-green-500 focus:border-green-500">
                                                </div>
                                            </div>
                                        </div>

                                        <!-- √ñdeme Butonu -->
                                        <button id="iyzicoPayButton" disabled
                                            class="w-full py-3.5 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl font-bold text-lg transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-[1.02] flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                            G√ºvenli √ñdeme Yap
                                        </button>
                                        <p id="iyzicoPaymentStatus" class="text-xs text-center text-gray-500 hidden"></p>
                                    </div>
                                </div>

                                <!-- G√ºvenlik Rozetleri -->
                                <div class="flex flex-wrap items-center justify-center gap-4 pt-3 border-t border-green-100">
                                    <div class="flex items-center text-xs text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                                        256-bit SSL
                                    </div>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                                        iyzico G√ºvencesi
                                    </div>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                                        3D Secure
                                    </div>
                                    <div class="flex items-center text-xs text-gray-400">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
                                        BDDK Lisanslƒ±
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Fƒ∞YAT Lƒ∞STESƒ∞ G√ñR√úN√úM√ú (YENƒ∞) -->
            <div id="userPriceListView" class="user-panel-view hidden">
                <div class="mt-8 p-4 sm:p-6 bg-orange-100 border border-orange-300 rounded-xl shadow-md">
                    <h3 class="text-lg sm:text-xl font-bold text-orange-700 border-b pb-2 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                        G√ºncel Abonelik Fiyat Listesi
                    </h3>
                    <div id="priceListDisplay" class="space-y-4">
                        <p class="text-center text-gray-500">Fiyatlar y√ºkleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- 4. MESAJLAR G√ñR√úN√úM√ú -->
            <div id="userMessagesView" class="user-panel-view hidden">
                <!-- Y√∂neticiye Mesaj G√∂nder -->
                <div class="mt-4 bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
                    <!-- Chat Header -->
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-4 sm:px-6 py-3 flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                        </div>
                        <div>
                            <h3 class="text-white font-bold text-sm">Destek Hattƒ±</h3>
                            <p class="text-orange-100 text-xs">Y√∂netici ile ileti≈üim</p>
                        </div>
                    </div>
                    <!-- Chat Body -->
                    <div id="userConversationArea">
                        <div id="userChatMessages" class="min-h-[200px] max-h-[400px] overflow-y-auto p-4 bg-gradient-to-b from-gray-50 to-white space-y-3">
                            <p class="text-center text-sm text-gray-400 py-8">Hen√ºz mesaj yok. Y√∂neticiye bir mesaj g√∂nderin.</p>
                        </div>
                        <!-- Chat Input -->
                        <div class="p-3 border-t bg-gray-50">
                            <div class="flex gap-2 items-end">
                                <textarea id="userMessageInput" rows="1" placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..." class="flex-grow px-4 py-2.5 border border-gray-200 rounded-2xl text-sm focus:border-orange-400 focus:ring-2 focus:ring-orange-100 focus:outline-none resize-none bg-white"></textarea>
                                <button id="sendUserMessageButton" class="p-2.5 bg-orange-500 hover:bg-orange-600 text-white rounded-full transition-all shadow-md hover:shadow-lg active:scale-95">
                                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Duyurular (Toplu Mesajlar) -->
                <div class="mt-4 bg-white border border-gray-200 rounded-2xl shadow-lg overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-500 px-4 sm:px-6 py-3 flex items-center">
                        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
                        </div>
                        <h3 class="text-white font-bold text-sm">Duyurular</h3>
                    </div>
                    <div id="userMessagesContainer" class="space-y-3 max-h-96 overflow-y-auto p-4">
                        <!-- Toplu mesajlar buraya gelecek -->
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- Y√ñNETƒ∞Cƒ∞ (Admin) G√ñR√úN√úM√ú -->
        <div id="adminView" class="admin-view mt-12 border-t pt-8">
            <h3 class="text-xl sm:text-2xl font-bold text-orange-700 mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between">
                <span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 inline-block text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>
                    Y√∂netici Kontrol Merkezi
                </span>
                <button id="adminLogoutButton" class="py-1 px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition-colors">
                    √áƒ±kƒ±≈ü Yap
                </button>
            </h3>

            <!-- Y√ñNETƒ∞Cƒ∞ MEN√úS√ú -->
            <nav class="admin-nav-bar flex flex-wrap gap-1 border-b pb-2 mb-6">
                <button id="navDashboard" class="py-2 px-4 text-sm font-semibold rounded-t-lg bg-orange-600 text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
                    Dashboard
                </button>
                <button id="navRegisteredUsers" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 00-3-3.87"></path><path d="M16 3.13a4 4 0 010 7.75"></path></svg>
                    Kullanƒ±cƒ±lar
                </button>
                <button id="navUserManagement" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><path d="M18 8a2 2 0 100 4 2 2 0 000-4z"></path><path d="M10 21v-2a4 4 0 014-4h2"></path></svg>
                    Y√∂netim Ara√ßlarƒ±
                </button>
                <!-- YENƒ∞: ƒ∞√áERƒ∞K Y√ñNETƒ∞Mƒ∞ MEN√úS√ú -->
                <div class="relative" id="contentManagementDropdown">
                    <button onclick="document.getElementById('contentDropdownMenu').classList.toggle('hidden')" class="py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors cursor-pointer flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path></svg>
                        ƒ∞√ßerik Y√∂netimi
                        <svg class="w-3 h-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="contentDropdownMenu" class="hidden absolute top-full left-0 bg-white border rounded-lg shadow-xl z-50 w-48 py-1">
                        <button id="navPriceManagement" class="w-full text-left py-2.5 px-4 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors">Fiyat Listesi</button>
                        <button id="navMessages" class="w-full text-left py-2.5 px-4 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors">Mesajlar</button>
                        <button id="navIyzico" class="w-full text-left py-2.5 px-4 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-600 transition-colors">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                                iyzico √ñdeme
                            </span>
                        </button>
                    </div>
                </div>
            </nav>

            <div id="adminContent" class="bg-gray-100 p-2 sm:p-6 rounded-2xl space-y-6 shadow-inner">
                
                <!-- 1. DASHBOARD G√ñR√úN√úM√ú -->
                <div id="adminDashboardView" class="admin-panel-view space-y-6">
                    
                    <h4 class="font-bold text-gray-700 text-xl border-b pb-2 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                        Genel Metrikler
                    </h4>

                    <!-- METRƒ∞K KARTLARI -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                        <div class="metric-card p-4 rounded-2xl bg-gradient-to-br from-emerald-400 to-emerald-600 text-white text-center shadow-lg cursor-pointer" data-filter="active">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div id="metricActiveUsers" class="text-3xl font-extrabold tracking-tight">0</div>
                            <div class="text-[11px] font-semibold mt-1 uppercase tracking-wider opacity-90">Aktif</div>
                        </div>
                        <div class="metric-card p-4 rounded-2xl bg-gradient-to-br from-amber-400 to-amber-600 text-white text-center shadow-lg cursor-pointer" data-filter="expiring">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                            <div id="metricExpiringSoon" class="text-3xl font-extrabold tracking-tight">0</div>
                            <div class="text-[11px] font-semibold mt-1 uppercase tracking-wider opacity-90">7 G√ºn ƒ∞√ßinde Biten</div>
                        </div>
                        <div class="metric-card p-4 rounded-2xl bg-gradient-to-br from-rose-400 to-rose-600 text-white text-center shadow-lg cursor-pointer" data-filter="expired">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                            </div>
                            <div id="metricExpired" class="text-3xl font-extrabold tracking-tight">0</div>
                            <div class="text-[11px] font-semibold mt-1 uppercase tracking-wider opacity-90">Biten</div>
                        </div>
                        <div class="metric-card p-4 rounded-2xl bg-gradient-to-br from-violet-400 to-violet-600 text-white text-center shadow-lg cursor-pointer" data-filter="renewal">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </div>
                            <div id="metricRenewalRequests" class="text-3xl font-extrabold tracking-tight">0</div>
                            <div class="text-[11px] font-semibold mt-1 uppercase tracking-wider opacity-90">Uzatma</div>
                        </div>
                        <div class="metric-card p-4 rounded-2xl bg-gradient-to-br from-orange-400 to-orange-600 text-white text-center shadow-lg cursor-pointer" data-filter="newaccount">
                            <div class="flex items-center justify-center mb-2">
                                <svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                            </div>
                            <div id="metricNewAccountRequests" class="text-3xl font-extrabold tracking-tight">0</div>
                            <div class="text-[11px] font-semibold mt-1 uppercase tracking-wider opacity-90">Yeni Talep</div>
                        </div>
                    </div>

                    <!-- Merkezi URL Y√∂netimi Alanƒ± -->
                    <div class="border p-4 rounded-xl bg-white space-y-3 shadow-md">
                        <h4 class="font-bold text-gray-700 text-lg border-b pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"></path></svg>
                            1. Merkezi URL Y√∂netimi (Yurti√ßi & Yurtdƒ±≈üƒ±)
                        </h4>
                        
                        <!-- YURTƒ∞√áƒ∞ -->
                        <div class="border p-3 rounded-lg bg-gray-50 space-y-2">
                            <label for="globalDomesticUrlInput" class="block text-sm font-bold text-gray-700">Yurti√ßi URL:</label>
                            <input type="url" id="globalDomesticUrlInput" placeholder="Yurti√ßi Baƒülantƒ± (√ñrn: https://dom.link)" 
                                        class="w-full px-3 py-2 border border-red-300 rounded-lg text-sm focus:border-red-500 focus:ring-red-500">
                            <button id="updateDomesticUrlButton" class="w-full py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Yurti√ßi URL'yi G√ºncelle
                            </button>
                        </div>
                        
                        <!-- YURTDI≈ûI -->
                        <div class="border p-3 rounded-lg bg-gray-50 space-y-2">
                            <label for="globalInternationalUrlInput" class="block text-sm font-bold text-gray-700">Yurtdƒ±≈üƒ± URL:</label>
                            <input type="url" id="globalInternationalUrlInput" placeholder="Yurtdƒ±≈üƒ± Baƒülantƒ± (√ñrn: https://int.link)" 
                                        class="w-full px-3 py-2 border border-red-300 rounded-lg text-sm focus:border-red-500 focus:ring-red-500">
                            <button id="updateInternationalUrlButton" class="w-full py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Yurtdƒ±≈üƒ± URL'yi G√ºncelle
                            </button>
                        </div>

                        <div id="currentGlobalUrl" class="text-sm text-center p-2 rounded-lg bg-gray-100 font-mono break-all">Mevcut URL'ler y√ºkleniyor...</div>
                    </div>

                    <!-- M3U Base URL Y√∂netimi -->
                    <div class="border p-4 rounded-xl bg-white space-y-3 shadow-md">
                        <h4 class="font-bold text-gray-700 text-lg border-b pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                            2. M3U Playlist URL Y√∂netimi
                        </h4>
                        <p class="text-xs text-gray-500">Sadece base URL girin (√∂rn: <code class="bg-gray-200 px-1 rounded">http://aa3.504738.xyz:80</code>). Kullanƒ±cƒ± adƒ± ve ≈üifre otomatik eklenir.</p>
                        
                        <!-- YURTƒ∞√áƒ∞ M3U -->
                        <div class="border p-3 rounded-lg bg-green-50 space-y-2">
                            <label for="m3uBaseDomesticInput" class="block text-sm font-bold text-gray-700">üáπüá∑ Yurti√ßi M3U Base URL:</label>
                            <input type="text" id="m3uBaseDomesticInput" placeholder="√ñrn: http://aa3.504738.xyz:80" 
                                        class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:border-green-500 focus:ring-green-500 font-mono">
                            <button id="updateM3uDomesticButton" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Yurti√ßi M3U URL G√ºncelle
                            </button>
                        </div>
                        
                        <!-- YURTDI≈ûI M3U -->
                        <div class="border p-3 rounded-lg bg-green-50 space-y-2">
                            <label for="m3uBaseInternationalInput" class="block text-sm font-bold text-gray-700">üåç Yurtdƒ±≈üƒ± M3U Base URL:</label>
                            <input type="text" id="m3uBaseInternationalInput" placeholder="√ñrn: http://bb5.123456.xyz:80" 
                                        class="w-full px-3 py-2 border border-green-300 rounded-lg text-sm focus:border-green-500 focus:ring-green-500 font-mono">
                            <button id="updateM3uInternationalButton" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Yurtdƒ±≈üƒ± M3U URL G√ºncelle
                            </button>
                        </div>

                        <div id="currentM3uUrls" class="text-sm text-center p-2 rounded-lg bg-gray-100 font-mono break-all">M3U Base URL'ler y√ºkleniyor...</div>
                    </div>

                    <!-- Test Hesaplarƒ± Alanƒ± (YENƒ∞) - Accordion -->
                    <div class="border rounded-xl bg-white shadow-md overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.accordion-icon').classList.toggle('rotate-180')" class="accordion-toggle w-full p-4 font-bold text-gray-700 text-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                Test Hesaplarƒ±
                                <span id="testAccountCount" class="ml-2 text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">0</span>
                            </span>
                            <svg class="accordion-icon w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="hidden p-4 border-t space-y-3">
                            <button id="refreshTestAccountsButton" class="py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs transition-colors">
                                Test Hesaplarƒ±nƒ± Yenile
                            </button>
                            <div id="testAccountsList" class="max-h-80 overflow-y-auto mt-3 border rounded-lg bg-gray-50 space-y-2 p-2">
                                <p class="text-center p-4 text-gray-500" id="testAccountStatus">Hen√ºz aktif test hesabƒ± bulunmuyor.</p>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Hesap Uzatma Talepleri Alanƒ± - Accordion -->
                    <div class="border rounded-xl bg-white shadow-md overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.accordion-icon').classList.toggle('rotate-180')" class="accordion-toggle w-full p-4 font-bold text-gray-700 text-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10l3 3m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                √úyelik Uzatma Talepleri
                                <span id="requestCount" class="ml-2 text-xs bg-purple-500 text-white px-2 py-0.5 rounded-full">0</span>
                            </span>
                            <svg class="accordion-icon w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="hidden p-4 border-t space-y-3">
                            <button id="refreshRequestsButton" class="py-1 px-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-xs transition-colors">
                                Talepleri Yenile
                            </button>
                            <div id="renewalRequestsList" class="max-h-80 overflow-y-auto mt-3 border rounded-lg bg-gray-50">
                                <p class="text-center p-4 text-gray-500" id="requestStatus">Talepleri g√∂r√ºnt√ºlemek i√ßin Yenile'ye tƒ±klayƒ±n.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Yeni Hesap Olu≈üturma Talepleri Alanƒ± - Accordion -->
                    <div class="border rounded-xl bg-white shadow-md overflow-hidden">
                        <button onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.accordion-icon').classList.toggle('rotate-180')" class="accordion-toggle w-full p-4 font-bold text-gray-700 text-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                            <span class="flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="18" y1="8" x2="18" y2="16"></line><line x1="22" y1="12" x2="14" y2="12"></line></svg>
                                Yeni Hesap Talepleri
                                <span id="newAccountRequestCount" class="ml-2 text-xs bg-orange-500 text-white px-2 py-0.5 rounded-full">0</span>
                            </span>
                            <svg class="accordion-icon w-5 h-5 text-gray-400 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div class="hidden p-4 border-t space-y-3">
                            <button id="refreshNewAccountRequestsButton" class="py-1 px-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-xs transition-colors">
                                Talepleri Yenile
                            </button>
                            <div id="newAccountRequestsList" class="max-h-80 overflow-y-auto mt-3 border rounded-lg bg-gray-50">
                                <p class="text-center p-4 text-gray-500" id="newAccountRequestStatus">Talepleri g√∂r√ºnt√ºlemek i√ßin Yenile'ye tƒ±klayƒ±n.</p>
                            </div>
                        </div>
                    </div>

                </div>
                <!-- DASHBOARD G√ñR√úN√úM√ú Bƒ∞Tƒ∞≈û -->
                
                <!-- 2. KAYITLI KULLANICILAR G√ñR√úN√úM√ú -->
                <div id="adminRegisteredUsersView" class="admin-panel-view hidden space-y-6">
                    <!-- Kullanƒ±cƒ± Listeleme Alanƒ± -->
                    <div class="border p-4 rounded-xl bg-white space-y-3 shadow-md">
                        <h4 class="font-bold text-gray-700 text-lg border-b pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line></svg>
                            Kayƒ±tlƒ± Kullanƒ±cƒ±lar (Toplam: <span id="userCount">0</span>)
                        </h4>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="userSearchInput" placeholder="Kullanƒ±cƒ± adƒ±na g√∂re ara..."
                                 class="flex-grow px-3 py-1.5 border rounded-lg text-sm">
                            <div class="flex gap-2">
                                <button id="refreshUserListButton" class="flex-1 sm:flex-none py-1.5 px-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg text-xs sm:text-sm transition-colors">
                                    Yenile
                                </button>
                                <button id="exportToExcelButton" class="flex-1 sm:flex-none py-1.5 px-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs sm:text-sm transition-colors">
                                    Excel
                                </button>
                            </div>
                        </div>

                        <!-- Kullanƒ±cƒ± Tipi Filtreleme (YENƒ∞) -->
                        <div class="flex flex-wrap gap-2">
                            <button id="filterAllUsersBtn" class="py-1 px-3 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm transition-colors font-semibold">
                                T√ºm√º
                            </button>
                            <button id="filterDomesticUsersBtn" class="py-1 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition-colors">
                                üìç Yurti√ßi
                            </button>
                            <button id="filterInternationalUsersBtn" class="py-1 px-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm transition-colors">
                                üåç Yurtdƒ±≈üƒ±
                            </button>
                        </div>

                        <div id="userListContainer" class="max-h-96 overflow-y-auto mt-3 border rounded-lg bg-gray-50 relative">
                            <div class="sticky top-0 bg-gray-200 p-2 font-semibold text-xs text-gray-700 hidden sm:flex justify-between">
                                <span class="w-1/4">Kullanƒ±cƒ± Adƒ± / ≈ûifre</span>
                                <span class="w-1/5 text-center">Tip</span>
                                <span class="w-1/4 text-center">Biti≈ü Tarihi</span>
                                <span class="w-1/6 text-center">Durum</span>
                                <span class="w-1/6 text-right">ƒ∞≈ülemler</span>
                            </div>
                            <div id="userListContent">
                                <!-- Admin Skeleton Loading -->
                                <div id="adminListSkeleton" class="hidden space-y-2 p-2">
                                    <div class="skeleton skeleton-card" style="height: 56px;"></div>
                                    <div class="skeleton skeleton-card" style="height: 56px;"></div>
                                    <div class="skeleton skeleton-card" style="height: 56px;"></div>
                                    <div class="skeleton skeleton-card" style="height: 56px;"></div>
                                    <div class="skeleton skeleton-card" style="height: 56px;"></div>
                                </div>
                                <p class="text-center p-4 text-gray-500" id="listStatus">Listeyi g√∂r√ºnt√ºlemek i√ßin Yenile'ye tƒ±klayƒ±n.</p>
                            </div>
                        </div>
                        
                        <!-- Pagination Kontrolleri -->
                        <div id="paginationControls" class="flex justify-center items-center space-x-4 mt-4 p-2">
                            <!-- Butonlar buraya eklenecek -->
                        </div>
                    </div>
                </div>
                <!-- KAYITLI KULLANICILAR G√ñR√úN√úM√ú Bƒ∞Tƒ∞≈û -->


                <!-- 3. Y√ñNETƒ∞M ARA√áLARI G√ñR√úN√úM√ú -->
                <div id="adminUserManagementView" class="admin-panel-view hidden space-y-6">

                    <!-- Alt Sekme Navigasyonu -->
                    <div class="flex gap-2 border-b border-gray-200 pb-2">
                        <button id="mgmtTabUsers" class="mgmt-tab py-2 px-4 text-sm font-semibold rounded-t-lg bg-orange-600 text-white transition-colors" onclick="switchMgmtTab('users')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                            Kullanƒ±cƒ± ƒ∞≈ülemleri
                        </button>
                        <button id="mgmtTabRevenue" class="mgmt-tab py-2 px-4 text-sm font-semibold rounded-t-lg text-orange-600 hover:bg-orange-100 transition-colors" onclick="switchMgmtTab('revenue')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 mr-1 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                            Gelir / Gider Hesaplamasƒ±
                        </button>
                    </div>

                    <!-- KULLANICI ƒ∞≈ûLEMLERƒ∞ TABƒ∞ -->
                    <div id="mgmtUsersContent" class="mgmt-tab-content space-y-6">

                    <!-- 1. KULLANICI EKLEME (AKORDƒ∞YON) -->
                    <details class="group rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                        <summary class="p-5 font-bold text-gray-800 text-lg flex items-center justify-between cursor-pointer hover:bg-orange-50 transition-all duration-200">
                            <span class="flex items-center gap-3">
                                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                                </span>
                                <span>Yeni Kullanƒ±cƒ± Ekle</span>
                            </span>
                            <svg class="w-5 h-5 text-gray-400 transform group-open:rotate-180 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-5 bg-gray-50 border-t border-gray-200 space-y-4">
                            <div class="space-y-1">
                                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Kullanƒ±cƒ± Adƒ±</label>
                                <input type="text" id="singleUsername" placeholder="Kullanƒ±cƒ± adƒ±nƒ± girin" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                            </div>
                            <div class="space-y-1">
                                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">≈ûifre</label>
                                <input type="password" id="singlePassword" placeholder="≈ûifre girin" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                            </div>
                            <div class="space-y-1">
                                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Biti≈ü Tarihi</label>
                                <input type="text" id="singleExpiryDate" placeholder="YYYY-MM-DD" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                            </div>
                            <div class="space-y-1">
                                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">E-posta (ƒ∞steƒüe baƒülƒ±)</label>
                                <input type="email" id="singleEmail" placeholder="E-posta adresi" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                                <div class="space-y-1">
                                    <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Kullanƒ±cƒ± Tipi</label>
                                    <select id="singleUserType" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                                        <option value="YURTICI">Yurti√ßi</option>
                                        <option value="YURTDISI">Yurtdƒ±≈üƒ±</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Hesap Tipi</label>
                                    <select id="singleAccountType" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                                        <option value="Normal">Normal</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Premium">Premium</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">√úyelik S√ºresi</label>
                                    <select id="singleSubscriptionPeriod" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                                        <option value="3 Ay">3 Ay</option>
                                        <option value="6 Ay">6 Ay</option>
                                        <option value="12 Ay">12 Ay</option>
                                        <option value="15 Ay">15 Ay</option>
                                    </select>
                                </div>
                            </div>
                            <div class="space-y-1">
                                <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">A√ßƒ±klama (ƒ∞steƒüe baƒülƒ±)</label>
                                <textarea id="singleDescription" placeholder="A√ßƒ±klama yazƒ±n..." class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow" rows="3"></textarea>
                            </div>
                            <button id="singleAddUserButton" class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                Yeni Kullanƒ±cƒ±yƒ± Kaydet
                            </button>
                        </div>
                    </details>

                    <!-- 2. KULLANICI D√úZENLEME (AKORDƒ∞YON) -->
                    <details id="editUserAccordion" class="group rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                        <summary class="p-5 font-bold text-gray-800 text-lg flex items-center justify-between cursor-pointer hover:bg-blue-50 transition-all duration-200">
                            <span class="flex items-center gap-3">
                                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </span>
                                <span>Kullanƒ±cƒ±yƒ± D√ºzenle / Sil</span>
                            </span>
                            <svg class="w-5 h-5 text-gray-400 transform group-open:rotate-180 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-5 bg-gray-50 border-t border-gray-200 space-y-4">
                            <div class="space-y-1">
                                <label for="editUserSelect" class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">D√ºzenlenecek Kullanƒ±cƒ±yƒ± Se√ßin</label>
                                <select id="editUserSelect" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow"></select>
                            </div>
                            
                            <div id="editUserForm" class="hidden space-y-4 pt-4 border-t border-gray-200">

                                <!-- SEKME BUTONLARI -->
                                <div class="flex gap-2 border-b border-gray-200 pb-2">
                                    <button type="button" id="editTabInfo" class="edit-tab py-2 px-4 text-sm font-semibold rounded-t-lg bg-blue-600 text-white transition-colors" onclick="switchEditTab('info')">
                                        üìù Hesap Bilgisi G√ºncelle
                                    </button>
                                    <button type="button" id="editTabExtend" class="edit-tab py-2 px-4 text-sm font-semibold rounded-t-lg text-green-600 border border-green-300 hover:bg-green-50 transition-colors" onclick="switchEditTab('extend')">
                                        ‚è∞ Hesap S√ºresi Uzat
                                    </button>
                                </div>

                                <!-- HESAP Bƒ∞LGƒ∞Sƒ∞ G√úNCELLE TABƒ∞ -->
                                <div id="editInfoContent" class="edit-tab-content space-y-4">
                                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-3">
                                        <p class="text-xs text-blue-700 font-semibold">‚ÑπÔ∏è Bu b√∂l√ºmde ≈üifre, e-posta, kullanƒ±cƒ± tipi ve hesap tipi g√ºncellenebilir. Gelir/gider hesaplamasƒ±nƒ± etkilemez.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Yeni ≈ûifre</label>
                                        <input type="password" id="editPassword" placeholder="Yeni ≈üifre girin" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Yeni E-posta</label>
                                        <input type="email" id="editEmail" placeholder="E-posta adresi" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                    </div>
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div class="space-y-1">
                                            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Kullanƒ±cƒ± Tipi</label>
                                            <select id="editUserType" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow"></select>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Hesap Tipi</label>
                                            <input type="text" id="editAccountType" placeholder="Hesap tipi" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                        </div>
                                    </div>
                                    <button id="updateUserInfoButton" class="w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                                        Hesap Bilgisini G√ºncelle
                                    </button>
                                </div>

                                <!-- HESAP S√úRESƒ∞ UZAT TABƒ∞ -->
                                <div id="editExtendContent" class="edit-tab-content hidden space-y-4">
                                    <div class="bg-green-50 border border-green-200 rounded-xl p-3">
                                        <p class="text-xs text-green-700 font-semibold">üí∞ Bu i≈ülem gelir/gider hesaplamasƒ±na kaydedilir. S√ºre uzatƒ±ldƒ±ƒüƒ±nda abonelik logu olu≈üturulur.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">√úyelik S√ºresi</label>
                                        <select id="editSubscriptionPeriod" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm bg-white focus:ring-2 focus:ring-green-400 focus:border-green-400 transition-shadow">
                                            <option value="3 Ay">3 Ay</option>
                                            <option value="6 Ay">6 Ay</option>
                                            <option value="12 Ay" selected>12 Ay</option>
                                            <option value="15 Ay">15 Ay</option>
                                            <option value="12 Ay √áift">12 Ay √áift Cihaz</option>
                                        </select>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider">Yeni Biti≈ü Tarihi</label>
                                        <input type="text" id="editExpiryDate" placeholder="YYYY-MM-DD" class="w-full px-4 py-2.5 border border-gray-300 rounded-xl text-sm focus:ring-2 focus:ring-green-400 focus:border-green-400 transition-shadow">
                                    </div>
                                    <div id="editExtendPreview" class="bg-gray-100 rounded-xl p-3 hidden">
                                        <p class="text-xs font-semibold text-gray-600">Hesaplama √ñnizleme:</p>
                                        <div id="editExtendPreviewContent" class="text-sm mt-1"></div>
                                    </div>
                                    <button id="extendUserButton" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v10l3 3m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Hesap S√ºresini Uzat & Kaydet
                                    </button>
                                </div>

                                <!-- Sƒ∞L BUTONU -->
                                <div class="pt-3 border-t border-gray-200">
                                    <button id="deleteUserButton" class="w-full py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"></path></svg>
                                        Kullanƒ±cƒ±yƒ± Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 3. TOPLU MESAJ G√ñNDERME (AKORDƒ∞YON) -->
                    <details class="group border rounded-xl bg-white shadow-md overflow-hidden">
                        <summary class="p-4 font-bold text-gray-700 text-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                            <span>3. Toplu Mesaj G√∂nder</span>
                            <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-4 border-t space-y-3">
                            <label for="bulkMessageInput" class="block text-sm font-medium text-gray-700">T√ºm kullanƒ±cƒ±lara g√∂nderilecek mesaj:</label>
                            <textarea id="bulkMessageInput" rows="4" placeholder="Duyuru, bakƒ±m bildirimi veya kampanya mesajƒ±nƒ±zƒ± buraya yazƒ±n..." class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                            <button id="sendBulkMessageButton" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Mesajƒ± T√ºm Kullanƒ±cƒ±lara G√∂nder
                            </button>
                        </div>
                    </details>

                    <!-- 5. HIZLI KULLANICI EKLEME -->
                    <details class="group border rounded-xl bg-white shadow-md overflow-hidden">
                        <summary class="p-4 font-bold text-gray-700 text-lg flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors">
                            <span>4. Hƒ±zlƒ± Kullanƒ±cƒ± Ekleme</span>
                            <svg class="w-5 h-5 transform group-open:rotate-180 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </summary>
                        <div class="p-4 border-t space-y-3">
                            <p class="text-sm text-gray-600">Hazƒ±r ≈üablonlardan birini se√ßin veya kendi formatƒ±nƒ±zƒ± yazƒ±n: Kullanƒ±cƒ± Adƒ±:xxx,≈ûifre:yyy,Biti≈ü Tarihi:2027-01-01,Hesap T√ºr√º:Yurtdƒ±≈üƒ±</p>
                            <select id="quickAddInput" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="">-- ≈ûablon Se√ßin --</option>
                                <option value="Kullanƒ±cƒ± Adƒ±:testuser,≈ûifre:testpass,Biti≈ü Tarihi:2027-01-01,Hesap T√ºr√º:Yurtdƒ±≈üƒ±">Temel Yurtdƒ±≈üƒ± ≈ûablonu</option>
                                <option value="Kullanƒ±cƒ± Adƒ±:testuser,≈ûifre:testpass,Biti≈ü Tarihi:2027-01-01,Hesap T√ºr√º:YURTICI">Temel Yurti√ßi ≈ûablonu</option>
                                <option value="Kullanƒ±cƒ± Adƒ±:testuser,≈ûifre:testpass,Biti≈ü Tarihi:2027-12-01,Hesap T√ºr√º:Yurtdƒ±≈üƒ±">12 Ay Yurtdƒ±≈üƒ± ≈ûablonu</option>
                                <option value="Kullanƒ±cƒ± Adƒ±:testuser,≈ûifre:testpass,Hesap T√ºr√º:Yurtdƒ±≈üƒ±,Test Hesabƒ±:Evet">Test Hesabƒ± (24 Saat Yurtdƒ±≈üƒ±)</option>
                                <option value="Kullanƒ±cƒ± Adƒ±:testuser,≈ûifre:testpass,Hesap T√ºr√º:YURTICI,Test Hesabƒ±:Evet">Test Hesabƒ± (24 Saat Yurti√ßi)</option>
                            </select>
                            <label class="flex items-center gap-2 text-sm text-gray-700 p-2 bg-blue-50 rounded-lg">
                                <input type="checkbox" id="quickAddIsTestAccount" class="rounded">
                                <span>Test Hesabƒ± (24 saat ge√ßerli)</span>
                            </label>
                            <textarea id="quickAddCustomInput" rows="3" placeholder="Veya kendi formatƒ±nƒ±zƒ± yazƒ±n..." class="w-full px-3 py-2 border rounded-lg text-sm mt-2"></textarea>
                            <button id="quickAddUserButton" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                Kullanƒ±cƒ±yƒ± Ekle ve ≈ûablonu Hazƒ±rla
                            </button>
                            <div id="quickAddResult" class="hidden mt-4 p-3 bg-gray-100 rounded-lg">
                                <h5 class="font-bold text-gray-700">Hazƒ±rlanan WhatsApp ≈ûablonu:</h5>
                                <textarea id="quickAddTemplate" rows="10" class="w-full px-3 py-2 border rounded-lg text-sm mt-2" readonly></textarea>
                                <button id="copyQuickTemplateButton" class="mt-2 py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs transition-colors">
                                    ≈ûablonu Kopyala
                                </button>
                            </div>
                        </div>
                    </details>

                    </div>
                    <!-- KULLANICI ƒ∞≈ûLEMLERƒ∞ TABƒ∞ Bƒ∞Tƒ∞≈û -->

                    <!-- GELƒ∞R / Gƒ∞DER HESAPLAMASI TABƒ∞ -->
                    <div id="mgmtRevenueContent" class="mgmt-tab-content hidden space-y-6">
                        
                        <!-- Ba≈ülƒ±k & Kur Bilgisi -->
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <span class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-600 text-white shadow-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                                </span>
                                <div>
                                    <h4 class="font-bold text-gray-800 text-xl">Gelir / Gider Hesaplamasƒ±</h4>
                                    <p class="text-xs text-gray-500">Kullanƒ±cƒ± aboneliklerine g√∂re otomatik hesaplama</p>
                                </div>
                            </div>
                            <div id="eurTryRate" class="text-right bg-blue-50 rounded-xl px-4 py-2 border border-blue-200">
                                <p class="text-xs text-blue-600 font-semibold">üí± G√ºncel EUR/TRY</p>
                                <p id="eurTryRateValue" class="text-lg font-bold text-blue-800">Y√ºkleniyor...</p>
                            </div>
                        </div>

                        <!-- D√∂nem Filtresi -->
                        <div class="rounded-2xl bg-white shadow-lg p-4 border border-gray-200">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 mb-3">
                                <h5 class="font-bold text-gray-700 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                    D√∂nem Se√ßimi
                                </h5>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setRevenuePeriod('month')" id="periodBtnMonth" class="period-btn py-1.5 px-3 text-xs font-bold rounded-lg bg-orange-600 text-white transition-colors">Bu Ay</button>
                                    <button onclick="setRevenuePeriod('3month')" id="periodBtn3month" class="period-btn py-1.5 px-3 text-xs font-bold rounded-lg text-orange-600 border border-orange-300 hover:bg-orange-50 transition-colors">3 Ay</button>
                                    <button onclick="setRevenuePeriod('6month')" id="periodBtn6month" class="period-btn py-1.5 px-3 text-xs font-bold rounded-lg text-orange-600 border border-orange-300 hover:bg-orange-50 transition-colors">6 Ay</button>
                                    <button onclick="setRevenuePeriod('12month')" id="periodBtn12month" class="period-btn py-1.5 px-3 text-xs font-bold rounded-lg text-orange-600 border border-orange-300 hover:bg-orange-50 transition-colors">12 Ay</button>
                                    <button onclick="setRevenuePeriod('all')" id="periodBtnAll" class="period-btn py-1.5 px-3 text-xs font-bold rounded-lg text-orange-600 border border-orange-300 hover:bg-orange-50 transition-colors">T√ºm√º</button>
                                </div>
                            </div>
                            <div id="periodDateRange" class="text-sm text-gray-500 bg-gray-50 rounded-lg px-3 py-2">
                                üìÖ Se√ßili D√∂nem: Y√ºkleniyor...
                            </div>
                        </div>

                        <!-- √ñzet Kartlarƒ± -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="rounded-2xl bg-gradient-to-br from-green-400 to-green-600 text-white p-5 shadow-lg">
                                <p class="text-xs font-semibold uppercase tracking-wider opacity-80">Toplam Gelir (TL)</p>
                                <p id="totalRevenueTL" class="text-3xl font-extrabold mt-1">0 ‚Ç∫</p>
                                <p id="totalRevenueEUR" class="text-sm opacity-80 mt-1">0 ‚Ç¨</p>
                            </div>
                            <div class="rounded-2xl bg-gradient-to-br from-red-400 to-red-600 text-white p-5 shadow-lg">
                                <p class="text-xs font-semibold uppercase tracking-wider opacity-80">Toplam Maliyet (TL)</p>
                                <p id="totalCostTL" class="text-3xl font-extrabold mt-1">0 ‚Ç∫</p>
                                <p id="totalCostCredits" class="text-sm opacity-80 mt-1">0 Kredi</p>
                            </div>
                            <div class="rounded-2xl bg-gradient-to-br from-blue-400 to-blue-600 text-white p-5 shadow-lg">
                                <p class="text-xs font-semibold uppercase tracking-wider opacity-80">Net Kar (TL)</p>
                                <p id="netProfitTL" class="text-3xl font-extrabold mt-1">0 ‚Ç∫</p>
                                <p id="profitMargin" class="text-sm opacity-80 mt-1">Kar Marjƒ±: %0</p>
                            </div>
                        </div>

                        <!-- Grafik -->
                        <div class="rounded-2xl bg-white shadow-lg p-5 border border-gray-200">
                            <h5 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                Abonelik Daƒüƒ±lƒ±mƒ± & Gelir Grafiƒüi
                            </h5>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div style="max-height: 320px;"><canvas id="revenueByTypeChart"></canvas></div>
                                <div style="max-height: 320px;"><canvas id="revenuePieChart"></canvas></div>
                            </div>
                        </div>

                        <!-- Aylƒ±k Gelir Daƒüƒ±lƒ±mƒ± -->
                        <div class="rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                            <div class="bg-gradient-to-r from-teal-500 to-teal-600 px-5 py-4">
                                <h5 class="text-white font-bold text-lg">üìÜ Aylƒ±k Gelir/Gider √ñzeti</h5>
                                <p class="text-teal-100 text-xs">Her ay ka√ß hesap eklendi/g√ºncellendi ve ne kadar kazanƒ±ldƒ±</p>
                            </div>
                            <div class="p-4">
                                <div style="max-height: 300px;"><canvas id="monthlyRevenueChart"></canvas></div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Ay</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Hesap Sayƒ±sƒ±</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Gelir (TL)</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Maliyet (TL)</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Net Kar (TL)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="monthlyRevenueTableBody" class="divide-y divide-gray-200">
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Kredi Maliyet Tablosu -->
                        <div class="rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-5 py-4">
                                <h5 class="text-white font-bold text-lg">üìã Kredi & Maliyet Tablosu</h5>
                                <p class="text-purple-100 text-xs">1 Kredi = 3‚Ç¨ √ó G√ºncel EUR/TRY Kuru</p>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Paket</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Kredi</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Maliyet (‚Ç¨)</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Maliyet (TL)</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Satƒ±≈ü (TL/‚Ç¨)</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Kar (TL)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="creditCostTableBody" class="divide-y divide-gray-200">
                                        <!-- JS ile doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Detaylƒ± Kullanƒ±cƒ± Bazƒ±nda Tablo -->
                        <div class="rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-5 py-4 flex items-center justify-between">
                                <div>
                                    <h5 class="text-white font-bold text-lg">üìä Kullanƒ±cƒ± Bazlƒ± Gelir Detayƒ±</h5>
                                    <p class="text-orange-100 text-xs">Her kullanƒ±cƒ±nƒ±n abonelik geliri ve maliyeti</p>
                                </div>
                                <button onclick="calculateRevenue()" class="py-2 px-4 bg-white/20 hover:bg-white/30 text-white rounded-lg text-xs font-bold transition-colors">
                                    üîÑ Yenile
                                </button>
                            </div>
                            <div class="overflow-x-auto max-h-96 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Kullanƒ±cƒ±</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Tip</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">√úyelik</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Gelir</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Kredi</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Maliyet</th>
                                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase">Kar</th>
                                        </tr>
                                    </thead>
                                    <tbody id="revenueDetailTableBody" class="divide-y divide-gray-200">
                                        <tr><td colspan="8" class="text-center p-4 text-gray-500">Hesaplamak i√ßin Yenile'ye tƒ±klayƒ±n</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                    <!-- GELƒ∞R/Gƒ∞DER TABƒ∞ Bƒ∞Tƒ∞≈û -->

                </div>
                <!-- Y√ñNETƒ∞M ARA√áLARI Bƒ∞Tƒ∞≈û -->

                <!-- 4. Fƒ∞YAT Lƒ∞STESƒ∞ Y√ñNETƒ∞Mƒ∞ G√ñR√úN√úM√ú (YENƒ∞) -->
                <div id="adminPriceManagementView" class="admin-panel-view hidden space-y-6">
                    
                    <!-- Ba≈ülƒ±k -->
                    <div class="flex items-center gap-3 pb-2">
                        <span class="flex items-center justify-center w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 text-white shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"></path></svg>
                        </span>
                        <div>
                            <h4 class="font-bold text-gray-800 text-xl">Fiyat Listesi Y√∂netimi</h4>
                            <p class="text-xs text-gray-500">Yurti√ßi ve Yurtdƒ±≈üƒ± abonelik fiyatlarƒ±nƒ± buradan g√ºncelleyebilirsiniz.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- YURTƒ∞√áƒ∞ Fƒ∞YATLARI -->
                        <div class="rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-5 py-4 flex items-center gap-3">
                                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-white/20 text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M3 10h18M5 6l7-3 7 3M4 10v11M20 10v11"/></svg>
                                </span>
                                <div>
                                    <h5 class="text-white font-bold text-lg">üáπüá∑ Yurti√ßi Fiyatlarƒ±</h5>
                                    <p class="text-blue-100 text-xs">T√ºrk Lirasƒ± (‚Ç∫)</p>
                                </div>
                            </div>
                            <div class="p-5 space-y-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Tekli Abonelik</p>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="block text-xs font-medium text-gray-600">3 Ay</label>
                                        <div class="relative">
                                            <input type="number" id="priceSingle3M" placeholder="0" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                            <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç∫</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-medium text-gray-600">6 Ay</label>
                                        <div class="relative">
                                            <input type="number" id="priceSingle6M" placeholder="0" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                            <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç∫</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-medium text-gray-600">12 Ay</label>
                                        <div class="relative">
                                            <input type="number" id="priceSingle12M" placeholder="0" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                            <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç∫</span>
                                        </div>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-medium text-gray-600">15 Ay</label>
                                        <div class="relative">
                                            <input type="number" id="priceSingle15M" placeholder="0" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                            <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç∫</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="border-t border-gray-200 pt-4">
                                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">√áiftli Abonelik</p>
                                    <div class="space-y-1">
                                        <label class="block text-xs font-medium text-gray-600">12 Ay (√áift Cihaz)</label>
                                        <div class="relative">
                                            <input type="number" id="priceDouble12M" placeholder="0" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition-shadow">
                                            <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç∫</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- YURTDI≈ûI Fƒ∞YATLARI -->
                        <div class="rounded-2xl bg-white shadow-lg overflow-hidden border border-gray-200">
                            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-5 py-4 flex items-center gap-3">
                                <span class="flex items-center justify-center w-8 h-8 rounded-full bg-white/20 text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
                                </span>
                                <div>
                                    <h5 class="text-white font-bold text-lg">üåç Yurtdƒ±≈üƒ± Fiyatƒ±</h5>
                                    <p class="text-orange-100 text-xs">Euro (‚Ç¨)</p>
                                </div>
                            </div>
                            <div class="p-5 space-y-4">
                                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">12 Aylƒ±k Abonelik</p>
                                <div class="space-y-1">
                                    <label class="block text-xs font-medium text-gray-600">Fiyat (‚Ç¨)</label>
                                    <div class="relative">
                                        <input type="number" id="priceInternational12M" placeholder="50" class="w-full pl-7 pr-3 py-2.5 border border-gray-300 rounded-xl text-sm font-semibold focus:ring-2 focus:ring-orange-400 focus:border-orange-400 transition-shadow">
                                        <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-sm font-bold">‚Ç¨</span>
                                    </div>
                                </div>
                                <div class="bg-orange-50 border border-orange-200 rounded-xl p-3">
                                    <p class="text-xs text-orange-700 flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Yurtdƒ±≈üƒ± fiyatƒ± Euro cinsinden belirlenir. Deƒüi≈ütirmek i√ßin yeni fiyatƒ± girin.
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- G√ºncelle Butonu -->
                    <button id="updatePriceListButton" class="w-full py-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-xl text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                        T√ºm Fiyatlarƒ± G√ºncelle
                    </button>
                    <div id="currentPriceListStatus" class="text-xs text-center p-3 rounded-xl bg-gray-100 font-mono text-gray-500">Mevcut fiyatlar y√ºkleniyor...</div>
                </div>
                <!-- Fƒ∞YAT Lƒ∞STESƒ∞ Y√ñNETƒ∞Mƒ∞ Bƒ∞Tƒ∞≈û -->

                <!-- 5. MESAJ Y√ñNETƒ∞Mƒ∞ G√ñR√úN√úM√ú -->
                <div id="adminMessagesView" class="admin-panel-view hidden space-y-6">
                    <!-- Kullanƒ±cƒ± Konu≈ümalarƒ± -->
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                        <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                                </div>
                                <h4 class="text-white font-bold text-sm">Kullanƒ±cƒ± Mesajlarƒ±</h4>
                            </div>
                            <button id="refreshConversationsButton" class="py-1.5 px-3 bg-white/20 hover:bg-white/30 text-white rounded-lg text-xs font-medium transition-colors backdrop-blur-sm">Yenile</button>
                        </div>
                        <div class="flex flex-col lg:flex-row" style="min-height: 420px;">
                            <!-- Konu≈üma Listesi -->
                            <div class="w-full lg:w-1/3 border-r border-gray-100 bg-gray-50/50">
                                <div id="conversationsList" class="max-h-[500px] overflow-y-auto divide-y divide-gray-100">
                                    <p class="text-center p-6 text-gray-400 text-sm">Hen√ºz kullanƒ±cƒ± mesajƒ± yok.</p>
                                </div>
                            </div>
                            <!-- Sohbet Paneli -->
                            <div class="w-full lg:w-2/3 flex flex-col bg-white">
                                <div id="adminChatHeader" class="p-3 bg-gray-50 border-b">
                                    <p class="text-sm font-bold text-gray-500">Bir konu≈üma se√ßin</p>
                                </div>
                                <div id="adminChatMessages" class="flex-grow min-h-[300px] max-h-[400px] overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-gray-50/50 to-white">
                                    <p class="text-center text-sm text-gray-400 mt-16">Soldan bir kullanƒ±cƒ± se√ßin</p>
                                </div>
                                <div id="adminReplyArea" class="p-3 border-t bg-gray-50 hidden">
                                    <div class="flex gap-2 items-end">
                                        <textarea id="adminReplyInput" rows="1" placeholder="Cevabƒ±nƒ±zƒ± yazƒ±n..." class="flex-grow px-4 py-2.5 border border-gray-200 rounded-2xl text-sm focus:border-orange-400 focus:ring-2 focus:ring-orange-100 focus:outline-none resize-none bg-white"></textarea>
                                        <button id="sendAdminReplyButton" class="p-2.5 bg-orange-500 hover:bg-orange-600 text-white rounded-full transition-all shadow-md hover:shadow-lg active:scale-95">
                                            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Toplu Mesaj Ar≈üivi -->
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-500 px-4 py-3 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center mr-3">
                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
                                </div>
                                <h4 class="text-white font-bold text-sm">Duyuru Ar≈üivi</h4>
                            </div>
                            <button id="refreshMessagesButton" class="py-1.5 px-3 bg-white/20 hover:bg-white/30 text-white rounded-lg text-xs font-medium transition-colors backdrop-blur-sm">Yenile</button>
                        </div>
                        <div id="adminMessagesList" class="max-h-96 overflow-y-auto p-4">
                            <p class="text-center p-4 text-gray-400 text-sm">Hen√ºz g√∂nderilmi≈ü mesaj yok.</p>
                        </div>
                    </div>
                </div>
                <!-- MESAJ Y√ñNETƒ∞Mƒ∞ Bƒ∞Tƒ∞≈û -->

                <!-- 7. IYZICO √ñDEME Y√ñNETƒ∞Mƒ∞ G√ñR√úN√úM√ú -->
                <div id="adminIyzicoView" class="admin-panel-view hidden space-y-6">
                    <div class="border p-4 rounded-xl bg-white space-y-4 shadow-md">
                        <h4 class="font-bold text-gray-700 text-lg border-b pb-2 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                            iyzico √ñdeme Sistemi Y√∂netimi
                        </h4>

                        <!-- Durum Kartƒ± -->
                        <div id="iyzicoStatusCard" class="p-4 rounded-xl bg-yellow-50 border border-yellow-300">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full bg-yellow-500 mr-3 animate-pulse"></div>
                                    <div>
                                        <p class="font-bold text-gray-700">iyzico Durumu: <span id="iyzicoStatusText" class="text-yellow-600">Yapƒ±landƒ±rƒ±lmadƒ±</span></p>
                                        <p class="text-xs text-gray-500">Hen√ºz API anahtarlarƒ± girilmedi.</p>
                                    </div>
                                </div>
                                <span id="iyzicoModeBadge" class="px-3 py-1 text-xs font-bold text-yellow-800 bg-yellow-200 rounded-full">Sandbox</span>
                            </div>
                        </div>

                        <!-- API Yapƒ±landƒ±rma -->
                        <div class="space-y-3 border p-4 rounded-lg bg-gray-50">
                            <p class="font-bold text-sm text-gray-700">API Yapƒ±landƒ±rmasƒ±</p>
                            
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="iyzicoMode" value="sandbox" checked class="mr-2 text-green-500 focus:ring-green-500">
                                    <span class="text-sm text-gray-700">Sandbox (Test)</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="iyzicoMode" value="live" class="mr-2 text-green-500 focus:ring-green-500">
                                    <span class="text-sm text-gray-700">Canlƒ± (Live)</span>
                                </label>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">API Key:</label>
                                <input type="text" id="iyzicoApiKey" placeholder="iyzico API Key giriniz..." 
                                    class="w-full px-3 py-2 border rounded-lg text-sm font-mono focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Secret Key:</label>
                                <input type="password" id="iyzicoSecretKey" placeholder="iyzico Secret Key giriniz..." 
                                    class="w-full px-3 py-2 border rounded-lg text-sm font-mono focus:ring-green-500 focus:border-green-500">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Callback URL (ba≈üarƒ±lƒ± √∂deme sonrasƒ±):</label>
                                <input type="url" id="iyzicoCallbackUrl" placeholder="https://balkantvpanel.web.app/callback" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm font-mono focus:ring-green-500 focus:border-green-500" value="https://balkantvpanel.web.app">
                            </div>

                            <button id="saveIyzicoSettingsBtn" class="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-colors">
                                iyzico Ayarlarƒ±nƒ± Kaydet
                            </button>
                            <div id="iyzicoSettingsStatus" class="text-xs text-center p-2 rounded-lg bg-gray-100 font-mono">Ayarlar hen√ºz kaydedilmedi.</div>
                        </div>

                        <!-- √ñdeme ƒ∞statistikleri -->
                        <div class="space-y-3 border p-4 rounded-lg bg-gray-50">
                            <p class="font-bold text-sm text-gray-700">√ñdeme ƒ∞statistikleri</p>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                <div class="bg-white p-3 rounded-lg text-center border">
                                    <p id="iyzicoTotalPayments" class="text-2xl font-bold text-green-600">0</p>
                                    <p class="text-xs text-gray-500">Toplam √ñdeme</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center border">
                                    <p id="iyzicoTotalRevenue" class="text-2xl font-bold text-green-600">0 ‚Ç∫</p>
                                    <p class="text-xs text-gray-500">Toplam Gelir</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center border">
                                    <p id="iyzicoSuccessRate" class="text-2xl font-bold text-blue-600">%0</p>
                                    <p class="text-xs text-gray-500">Ba≈üarƒ± Oranƒ±</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center border">
                                    <p id="iyzicoLastPayment" class="text-sm font-bold text-gray-600">-</p>
                                    <p class="text-xs text-gray-500">Son √ñdeme</p>
                                </div>
                            </div>
                        </div>

                        <!-- Son √ñdemeler Listesi -->
                        <div class="space-y-3 border p-4 rounded-lg bg-gray-50">
                            <div class="flex items-center justify-between">
                                <p class="font-bold text-sm text-gray-700">Son √ñdemeler</p>
                                <button id="refreshIyzicoPaymentsBtn" class="py-1 px-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs transition-colors">Yenile</button>
                            </div>
                            <div id="iyzicoPaymentsList" class="max-h-64 overflow-y-auto space-y-2">
                                <p class="text-center text-gray-400 text-sm py-4">Hen√ºz √∂deme kaydƒ± bulunmuyor.</p>
                            </div>
                        </div>

                        <!-- √ñdeme Aktif/Pasif -->
                        <div class="flex items-center justify-between p-3 border rounded-lg bg-gray-50">
                            <div>
                                <p class="font-bold text-sm text-gray-700">Online √ñdeme Sistemi</p>
                                <p class="text-xs text-gray-500">Kullanƒ±cƒ±lara online √∂deme se√ßeneƒüi g√∂sterilsin mi?</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="iyzicoEnabledToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <!-- IYZICO Y√ñNETƒ∞Mƒ∞ Bƒ∞Tƒ∞≈û -->

                <!-- 6. HIZLI KULLANICI EKLEME G√ñR√úN√úM√ú -->
                <!-- HIZLI KULLANICI EKLEME Bƒ∞Tƒ∞≈û -->

            </div>
        </div>
        
        <!-- YENƒ∞ HESAP ONAY MODAL'I -->
        <div id="accountApprovalModal" class="modal-overlay hidden">
            <div class="modal-content" style="display:flex;flex-direction:column;padding:0;">
                <!-- Modal √úst Bar (Sabit) -->
                <div class="flex items-center justify-between px-6 pt-5 pb-3 border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-lg sm:text-xl font-bold text-orange-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle><path d="M16 11l-3 3-1-1"></path></svg>
                        Yeni Kullanƒ±cƒ±yƒ± Onayla
                    </h3>
                    <button id="modalCloseXButton" class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-red-100 text-gray-500 hover:text-red-600 transition-colors" title="Kapat">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <!-- Modal ƒ∞√ßerik (Kaydƒ±rƒ±labilir) -->
                <div class="px-6 py-4 overflow-y-auto flex-grow" style="max-height:60vh;">
                </h3>

                <!-- Talep Bilgileri -->
                <div id="modalUserInfo" class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg text-sm space-y-1">
                    <p class="font-bold text-orange-700 mb-2">üìã Talep Bilgileri</p>
                    <p><strong>Talep ID:</strong> <span id="modalRequestId"></span></p>
                    <p><strong>Ad Soyad:</strong> <span id="modalRequestName" class="font-semibold"></span></p>
                    <p><strong>Kullanƒ±m Alanƒ±:</strong> <span id="modalRequestType" class="font-bold text-orange-600"></span></p>
                    <p><strong>Telefon:</strong> <span id="modalRequestPhone"></span></p>
                    <p><strong>E-posta:</strong> <span id="modalRequestEmail"></span></p>
                    <p><strong>ƒ∞stenen S√ºre:</strong> <span id="modalRequestDuration"></span></p>
                </div>

                <!-- Test Hesabƒ± Toggle -->
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center justify-between">
                    <div>
                        <p class="font-bold text-sm text-yellow-800">üß™ Test Hesabƒ± Olu≈ütur</p>
                        <p class="text-xs text-yellow-700">Aktifse hesap 24 saat sonra otomatik sona erer</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="modalTestAccountToggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                    </label>
                </div>
                
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kullanƒ±cƒ± Adƒ± (Zorunlu):</label>
                            <input type="text" id="modalUsername" placeholder="Kullanƒ±cƒ± Adƒ±" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">≈ûifre (Zorunlu):</label>
                            <input type="text" id="modalPassword" placeholder="≈ûifre" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Kullanƒ±m Alanƒ±:</label>
                            <select id="modalUserType" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="YURTICI">üáπüá∑ Yurti√ßi</option>
                                <option value="YURTDISI">üåç Yurtdƒ±≈üƒ±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Hesap Tipi:</label>
                            <select id="modalAccountType" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="Standart Paket">Standart Paket</option>
                                <option value="Premium Paket">Premium Paket</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">√úyelik S√ºresi:</label>
                            <select id="modalSubscriptionPeriod" class="w-full px-3 py-2 border rounded-lg text-sm">
                                <option value="3 Ay">3 Ay</option>
                                <option value="6 Ay">6 Ay</option>
                                <option value="12 Ay">12 Ay</option>
                                <option value="15 Ay">15 Ay</option>
                                <option value="12 Ay √áift">12 Ay √áift Kullanƒ±cƒ±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Biti≈ü Tarihi:</label>
                            <input type="text" id="modalExpiryDate" placeholder="2027-01-01" class="w-full px-3 py-2 border rounded-lg text-sm">
                        </div>
                    </div>

                    <label class="block text-xs font-medium text-gray-700">Y√∂netici Notlarƒ± (ƒ∞steƒüe baƒülƒ±):</label>
                    <textarea id="modalAdminNotes" rows="2" placeholder="√ñrn: √ñdeme alƒ±ndƒ±, giri≈ü bilgileri mail ile g√∂nderildi." class="w-full px-3 py-2 border rounded-lg text-sm"></textarea>
                </div>
                </div>
                <!-- Modal Alt Bar (Sabit) -->
                <div class="px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-end gap-2 flex-shrink-0 bg-gray-50 rounded-b-2xl">
                    <button id="closeModalButton" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold transition-colors text-sm">
                        Vazge√ß
                    </button>
                    <button id="saveApprovedAccountButton" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-colors text-sm flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        Kaydet ve Onayla
                    </button>
                </div>
            </div>
        </div>

        <!-- WHATSAPP MESAJ MODAL'I (YENƒ∞) -->
        <div id="whatsappMessageModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-xl sm:text-2xl font-bold text-green-700 border-b pb-2 mb-4">
                    Kullanƒ±cƒ± Bilgileri G√∂nderime Hazƒ±r
                </h3>
                <p class="text-sm text-gray-600 mb-4">A≈üaƒüƒ±daki mesaj olu≈üturuldu. Kopyalayƒ±p doƒürudan kullanƒ±cƒ±ya g√∂nderebilirsiniz.</p>
                <textarea id="whatsappMessageOutput" rows="12" readonly class="w-full p-3 border rounded-lg bg-gray-50 font-mono text-sm"></textarea>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="closeWhatsappModalButton" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg font-semibold transition-colors">
                        Kapat
                    </button>
                    <button id="copyWhatsappMessageButton" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-colors">
                        Mesajƒ± Kopyala
                    </button>
                </div>
            </div>
        </div>


        <!-- Hata ve Mesaj Alanƒ± -->
        <div id="messageBox" class="hidden p-4 mt-4 text-sm rounded-xl font-semibold" role="alert"></div>

        <!-- YENƒ∞: ALT Bƒ∞LGƒ∞ -->
        <footer class="mt-8 pt-4 border-t border-gray-200 text-center">
            <p class="text-sm text-gray-500">Daha fazla bilgi i√ßin sitemizi ziyaret edin.</p>
            <a href="http://www.balkanpremiumtv.de" target="_blank" class="text-sm font-semibold text-orange-600 hover:text-orange-800 transition-colors">www.balkanpremiumtv.de</a>
        </footer>
    </div>

    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/tr.js" defer></script>

    <!-- Firebase Script -->
    <script type="module">
        // ===============================================
        // üö® KENDƒ∞ FIREBASE YAPILANDIRMANIZ BURADA
        // ===============================================

        // Eƒüer Canvas'tan gelmiyorsa, sizin projeniz i√ßin varsayƒ±lan deƒüerleri kullanƒ±r:
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyA5tsHpbIjS7IEsSj7MGlMdk1o5y30Q7Tc",
            authDomain: "balkantvpanel.firebaseapp.com",
            projectId: "balkantvpanel",
            storageBucket: "balkantvpanel.firebasestorage.app",
            messagingSenderId: "377175532888",
            appId: "1:377175532888:web:00ab5d929371adad0af12d",
            measurementId: "G-JN2VZ9V587"
        };
        
        // Canvas Global Deƒüi≈ükenleri (Gerekli deƒüilse varsayƒ±lanƒ± kullanƒ±r)
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const appId = window.appId; // Local reference
        const ADMIN_NOTIFICATION_EMAIL = 'mersinakpinar@outlook.com'; // Admin bildirim e-posta adresi
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : DEFAULT_FIREBASE_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ===============================================
        // FIREBASE ƒ∞MPORTLARI
        // ===============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, getDocs, collection, addDoc, deleteDoc, query, where, onSnapshot, orderBy, limit, startAfter, updateDoc, arrayUnion, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        let app, db, auth, userId = null;
        let functions = null; // Cloud Functions referansƒ±
        let isAuthReady = false;
        let isAdminUser = false; // Admin custom claim durumu
        let globalUrls = {}; 
        let currentLoggedInUser = null; 
        let allUsersData = []; 
        let newAccountRequestsData = []; 
        let priceList = {}; // Fiyat Listesi
        let allMessages = []; // T√ºm Mesajlar
                let lastRenewalRequestCount = 0; // Animasyon i√ßin
                let currentRenewalRequestIdForUpdate = null;
        
                // Sayfalama Deƒüi≈ükenleri
                const USERS_PER_PAGE = 20;
        let currentPage = 1;
        let currentFilter = 'all';
        let totalPages = 1;

        // UI Elementleri (Ortak)
        const authStatusEl = document.getElementById('authStatus');
        const messageBox = document.getElementById('messageBox');
        const loginForm = document.getElementById('loginForm');
        const userView = document.getElementById('userView');
        const adminView = document.getElementById('adminView');

        // UI Elementleri (M√º≈üteri)
        const loginButton = document.getElementById('loginButton');
        const usernameInput = document.getElementById('iptvUsernameInput');
        const passwordInput = document.getElementById('iptvPasswordInput'); 
        const showNewAccountFormButton = document.getElementById('showNewAccountFormButton'); 
        const resultContainer = document.getElementById('resultContainer');
        const userDataDisplay = document.getElementById('userDataDisplay');
        const userWelcomeHeader = document.getElementById('userWelcomeHeader'); 
        const renewalDurationSelect = document.getElementById('renewalDuration');
        const phoneNumberInput = document.getElementById('phoneNumberInput'); 
        const renewalUserTypeSelect = document.getElementById('renewalUserTypeSelect'); 
        const sendRenewalRequestButton = document.getElementById('sendRenewalRequestButton');
        const userLogoutButton = document.getElementById('userLogoutButton');
        const navUserInfo = document.getElementById('navUserInfo');
        const navUserRenewal = document.getElementById('navUserRenewal');
        const navPriceList = document.getElementById('navPriceList'); // YENƒ∞
        const userInfoView = document.getElementById('userInfoView');
        const userRenewalView = document.getElementById('userRenewalView');
        const userPriceListView = document.getElementById('userPriceListView'); // YENƒ∞
        const priceListDisplay = document.getElementById('priceListDisplay'); // YENƒ∞
        const navUserMessages = document.getElementById('navUserMessages'); // YENƒ∞
        const userMessagesView = document.getElementById('userMessagesView'); // YENƒ∞

        // Yeni Hesap Olu≈üturma UI
        const newAccountRequestContainer = document.getElementById('newAccountRequestContainer');
        const newAccountPhoneInput = document.getElementById('newAccountPhoneInput');
        const newAccountEmailInput = document.getElementById('newAccountEmailInput');
        const newAccountDurationSelect = document.getElementById('newAccountDurationSelect');
        const newAccountTypeSelect = document.getElementById('newAccountTypeSelect');
        const submitNewAccountRequestButton = document.getElementById('submitNewAccountRequestButton');
        const hideNewAccountFormButton = document.getElementById('hideNewAccountFormButton');
        
        // UI Elementleri (Y√∂netici)
        const adminLogoutButton = document.getElementById('adminLogoutButton');
        const navDashboard = document.getElementById('navDashboard');
        const navUserManagement = document.getElementById('navUserManagement'); 
        const navRegisteredUsers = document.getElementById('navRegisteredUsers'); 
        const navPriceManagement = document.getElementById('navPriceManagement'); // YENƒ∞
        const navMessages = document.getElementById('navMessages'); // YENƒ∞
        const navQuickAdd = document.getElementById('navQuickAdd'); // YENƒ∞
        const adminDashboardView = document.getElementById('adminDashboardView');
        const adminUserManagementView = document.getElementById('adminUserManagementView'); 
        const adminRegisteredUsersView = document.getElementById('adminRegisteredUsersView'); 
        const adminPriceManagementView = document.getElementById('adminPriceManagementView'); // YENƒ∞
        const adminMessagesView = document.getElementById('adminMessagesView'); // YENƒ∞
        const adminIyzicoView = document.getElementById('adminIyzicoView'); // IYZICO

        // Dashboard Metrikleri
        const metricActiveUsersEl = document.getElementById('metricActiveUsers');
        const metricExpiringSoonEl = document.getElementById('metricExpiringSoon');
        const metricExpiredEl = document.getElementById('metricExpired');
        const metricRenewalRequestsEl = document.getElementById('metricRenewalRequests');
        const metricNewAccountRequestsEl = document.getElementById('metricNewAccountRequests'); 
        // metricNewUsersLast7Days kaldƒ±rƒ±ldƒ± - 7 g√ºn metriƒüi artƒ±k expiringSoon ile birle≈ütirildi

        // URL Y√∂netimi
        const updateDomesticUrlButton = document.getElementById('updateDomesticUrlButton');
        const updateInternationalUrlButton = document.getElementById('updateInternationalUrlButton');
        const globalDomesticUrlInput = document.getElementById('globalDomesticUrlInput');
        const globalInternationalUrlInput = document.getElementById('globalInternationalUrlInput');
        const currentGlobalUrlEl = document.getElementById('currentGlobalUrl');

        // M3U Base URL Y√∂netimi
        const m3uBaseDomesticInput = document.getElementById('m3uBaseDomesticInput');
        const m3uBaseInternationalInput = document.getElementById('m3uBaseInternationalInput');
        const updateM3uDomesticButton = document.getElementById('updateM3uDomesticButton');
        const updateM3uInternationalButton = document.getElementById('updateM3uInternationalButton');
        const currentM3uUrlsEl = document.getElementById('currentM3uUrls');

        // Fiyat Y√∂netimi (YENƒ∞)
        const priceSingle3MInput = document.getElementById('priceSingle3M');
        const priceSingle6MInput = document.getElementById('priceSingle6M');
        const priceSingle12MInput = document.getElementById('priceSingle12M');
        const priceSingle15MInput = document.getElementById('priceSingle15M');
        const priceDouble12MInput = document.getElementById('priceDouble12M');
        const updatePriceListButton = document.getElementById('updatePriceListButton');
        const currentPriceListStatusEl = document.getElementById('currentPriceListStatus');

        // Kullanƒ±cƒ± Listesi ve Y√∂netim Elemanlarƒ±
        const bulkAddUsersButton = document.getElementById('bulkAddUsersButton');
        const bulkUserInput = document.getElementById('bulkUserInput');
        const refreshUserListButton = document.getElementById('refreshUserListButton');
        const exportToExcelButton = document.getElementById('exportToExcelButton');
        const userSearchInput = document.getElementById('userSearchInput');
        const userListContent = document.getElementById('userListContent');
        const userCountEl = document.getElementById('userCount');
        const listStatusEl = document.getElementById('listStatus');
        const paginationControlsEl = document.getElementById('paginationControls'); 

        // Talep Y√∂netimi
        const refreshRequestsButton = document.getElementById('refreshRequestsButton');
        const renewalRequestsList = document.getElementById('renewalRequestsList');
        const requestCountEl = document.getElementById('requestCount');

        // Yeni Hesap Talepleri Y√∂netimi
        const refreshNewAccountRequestsButton = document.getElementById('refreshNewAccountRequestsButton');
        const newAccountRequestsList = document.getElementById('newAccountRequestsList');
        const newAccountRequestCountEl = document.getElementById('newAccountRequestCount');
        const newAccountRequestStatusEl = document.getElementById('newAccountRequestStatus');

        // Tekil Ekleme 
        const singleAddUserButton = document.getElementById('singleAddUserButton');
        const singleUsernameInput = document.getElementById('singleUsername');
        const singlePasswordInput = document.getElementById('singlePassword');
        const singleExpiryDateInput = document.getElementById('singleExpiryDate');
        const singleEmailInput = document.getElementById('singleEmail');
        const singleUserTypeSelect = document.getElementById('singleUserType');
        const singleAccountTypeInput = document.getElementById('singleAccountType');
        const singleSubscriptionPeriodInput = document.getElementById('singleSubscriptionPeriod');
        const singleDescription = document.getElementById('singleDescription');

        // Kullanƒ±cƒ± D√ºzenleme/Silme (YENƒ∞)
        const editUserSelect = document.getElementById('editUserSelect');
        const editUserForm = document.getElementById('editUserForm');
        const editPasswordInput = document.getElementById('editPassword');
        const editExpiryDateInput = document.getElementById('editExpiryDate');
        const editEmailInput = document.getElementById('editEmail');
        const editUserTypeSelect = document.getElementById('editUserType');
        const editAccountTypeInput = document.getElementById('editAccountType');
        const editSubscriptionPeriodInput = document.getElementById('editSubscriptionPeriod');
        const updateUserInfoButton = document.getElementById('updateUserInfoButton');
        const extendUserButton = document.getElementById('extendUserButton');
        const updateUserButton = null; // eski buton kaldƒ±rƒ±ldƒ±
        const deleteUserButton = document.getElementById('deleteUserButton');

        // Toplu Mesajla≈üma (YENƒ∞)
        const bulkMessageInput = document.getElementById('bulkMessageInput');
        const sendBulkMessageButton = document.getElementById('sendBulkMessageButton');
        const userMessagesContainer = document.getElementById('userMessagesContainer');
        const adminMessagesList = document.getElementById('adminMessagesList');
        const refreshMessagesButton = document.getElementById('refreshMessagesButton');

        // Konu≈üma Sistemi
        const userChatMessages = document.getElementById('userChatMessages');
        const userMessageInput = document.getElementById('userMessageInput');
        const sendUserMessageButton = document.getElementById('sendUserMessageButton');
        const conversationsList = document.getElementById('conversationsList');
        const adminChatHeader = document.getElementById('adminChatHeader');
        const adminChatMessages = document.getElementById('adminChatMessages');
        const adminReplyArea = document.getElementById('adminReplyArea');
        const adminReplyInput = document.getElementById('adminReplyInput');
        const sendAdminReplyButton = document.getElementById('sendAdminReplyButton');
        const refreshConversationsButton = document.getElementById('refreshConversationsButton');
        let currentAdminConversationId = null; // Admin'in se√ßtiƒüi konu≈üma

        // Hƒ±zlƒ± Kullanƒ±cƒ± Ekleme
        const quickAddInput = document.getElementById('quickAddInput');
        const quickAddUserButton = document.getElementById('quickAddUserButton');
        const quickAddResult = document.getElementById('quickAddResult');
        const quickAddTemplate = document.getElementById('quickAddTemplate');
        const copyQuickTemplateButton = document.getElementById('copyQuickTemplateButton');

        // Modal √ñƒüeleri
        const accountApprovalModal = document.getElementById('accountApprovalModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const saveApprovedAccountButton = document.getElementById('saveApprovedAccountButton');
        // Modal Form Alanlarƒ±
        const modalRequestId = document.getElementById('modalRequestId');
        const modalRequestType = document.getElementById('modalRequestType');
        const modalRequestPhone = document.getElementById('modalRequestPhone');
        const modalRequestEmail = document.getElementById('modalRequestEmail');
        const modalRequestDuration = document.getElementById('modalRequestDuration');
        const modalUsernameInput = document.getElementById('modalUsername');
        const modalPasswordInput = document.getElementById('modalPassword');
        const modalExpiryDateInput = document.getElementById('modalExpiryDate');
        const modalAccountTypeInput = document.getElementById('modalAccountType');
        const modalSubscriptionPeriodInput = document.getElementById('modalSubscriptionPeriod');
        const modalUserTypeSelect = document.getElementById('modalUserType');
        const modalAdminNotesInput = document.getElementById('modalAdminNotes'); 

        let currentModalRequestId = null; 
        
        // Mesaj listener'larƒ± temizleme referanslarƒ±
        let unsubscribeMessages = null;
        let unsubscribeConversations = null;

        /**
         * Kalan g√ºn sayƒ±sƒ±nƒ± hesaplar (YENƒ∞)
         */
        function calculateRemainingDays(expiryDateString) {
            if (!expiryDateString) return { text: 'Tarih Yok', class: 'text-gray-500' };
            const now = new Date();
            const expiry = new Date(expiryDateString);
            // Saat, dakika, saniye farklarƒ±nƒ± sƒ±fƒ±rlayarak sadece g√ºn bazƒ±nda kar≈üƒ±la≈ütƒ±rma yap
            now.setHours(0, 0, 0, 0);
            expiry.setHours(0, 0, 0, 0);

            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return { text: 'S√ºresi Doldu', class: 'text-red-600 font-bold' };
            return { text: `${diffDays} g√ºn`, class: diffDays <= 30 ? 'text-yellow-600 font-bold' : 'text-green-600' };
        }

        /**
         * HTML enjeksiyonunu √∂nlemek i√ßin metin sanitize eder (XSS korumasƒ±)
         */
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Toast/Mesaj Kutusu G√∂sterme Fonksiyonu
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800', 'bg-blue-100', 'text-blue-800');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }
        
        /**
         * UI'ƒ± oturum a√ßma √∂ncesi duruma getirir (√áƒ±kƒ±≈ü Yapma)
         */
        async function resetUI() {
            // Admin oturumunu sunucu tarafƒ±nda temizle
            if (isAdminUser) {
                try {
                    const adminLogoutFn = httpsCallable(functions, 'adminLogout');
                    await adminLogoutFn();
                    await auth.currentUser.getIdToken(true); // Token yenile
                    isAdminUser = false;
                } catch (e) {
                    console.warn('Admin √ßƒ±kƒ±≈ü hatasƒ±:', e);
                }
            }
            
            // Listener'larƒ± temizle
            if (unsubscribeMessages) { unsubscribeMessages(); unsubscribeMessages = null; }
            if (unsubscribeConversations) { unsubscribeConversations(); unsubscribeConversations = null; }
            stopRealtimeListeners();
            
            // Geri sayƒ±mƒ± durdur
            if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            const countdownWidget = document.getElementById('countdownWidget');
            if (countdownWidget) countdownWidget.classList.add('hidden');
            
            // Session temizle
            sessionStorage.removeItem('iptvSession');
            
            loginForm.style.display = 'block';
            newAccountRequestContainer.style.display = 'none'; 
            userView.style.display = 'none';
            adminView.style.display = 'none';
            resultContainer.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            currentLoggedInUser = null;
            allUsersData = [];
            closeModal();
            showMessage("Oturum kapatƒ±ldƒ±.", 'info');
        }

        /**
         * Yeni Mesajlarƒ± Kontrol Eder ve Bildirim Ekler (YENƒ∞)
         */
        async function checkForNewMessages() {
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const querySnapshot = await getDocs(messagesRef);
                const messages = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                let unreadCount = 0;

                // Broadcast (duyuru) okunmamƒ±≈ü sayƒ±sƒ±
                if (messages.length > 0) {
                    let dismissedMessages = [];
                    if (currentLoggedInUser && currentLoggedInUser.iptvUsername) {
                        const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, currentLoggedInUser.iptvUsername);
                        const userSnap = await getDoc(userRef);
                        if (userSnap.exists()) {
                            dismissedMessages = userSnap.data().dismissedMessages || [];
                        }
                    }
                    unreadCount += messages.filter(msg => !dismissedMessages.includes(msg.id)).length;
                }

                // Konu≈üma okunmamƒ±≈ü sayƒ±sƒ±
                if (currentLoggedInUser && currentLoggedInUser.iptvUsername) {
                    const convRef = doc(db, `artifacts/${appId}/public/data/conversations`, currentLoggedInUser.iptvUsername);
                    const convSnap = await getDoc(convRef);
                    if (convSnap.exists()) {
                        const convData = convSnap.data();
                        unreadCount += (convData.unreadByUser || 0);
                    }
                }
                
                const navUserMessages = document.getElementById('navUserMessages');
                let badge = document.getElementById('message-notification-badge');

                if (unreadCount > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.id = 'message-notification-badge';
                        badge.className = 'ml-2 animate-pulse inline-flex items-center justify-center w-6 h-6 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full';
                        navUserMessages.appendChild(badge);
                    }
                    badge.textContent = unreadCount;
                } else {
                    if (badge) {
                        badge.remove();
                    }
                }
            } catch (error) {
                console.error("Yeni mesaj kontrol√º hatasƒ±:", error);
            }
        }


        
        /**
         * Y√∂netici Paneli G√∂r√ºn√ºm√ºn√º Deƒüi≈ütirir
         */
        function showAdminView(viewName) {
            const views = {
                dashboard: adminDashboardView,
                registeredUsers: adminRegisteredUsersView,
                managementTools: adminUserManagementView,
                priceManagement: adminPriceManagementView,
                messages: adminMessagesView,
                iyzico: adminIyzicoView
            };
            const navButtons = {
                dashboard: navDashboard,
                registeredUsers: navRegisteredUsers,
                managementTools: navUserManagement,
                priceManagement: navPriceManagement,
                messages: navMessages,
                iyzico: document.getElementById('navIyzico')
            };

            for (const name in views) {
                views[name].classList.add('hidden');
                if (!navButtons[name]) continue; 
                navButtons[name].classList.remove('bg-orange-600', 'text-white');
                navButtons[name].classList.add('text-orange-600', 'hover:bg-orange-100');
            }

            views[viewName].classList.remove('hidden');
            navButtons[viewName].classList.add('bg-orange-600', 'text-white');
            navButtons[viewName].classList.remove('text-orange-600', 'hover:bg-orange-100');

            if (viewName === 'dashboard') {
                fetchRenewalRequests();
                fetchNewAccountRequests();
                fetchTestAccounts();
            } else if (viewName === 'registeredUsers') {
                 if(allUsersData.length === 0) {
                     fetchAllUsers();
                   } else {
                     displayFilteredUsers(allUsersData, currentFilter);
                   }
            } else if (viewName === 'managementTools') {
                populateEditUserDropdown();
            } else if (viewName === 'priceManagement') {
                if (Object.keys(priceList).length === 0) {
                    fetchPriceList(true);
                }
            } else if (viewName === 'messages') {
                fetchAdminMessages();
                fetchConversations();
            } else if (viewName === 'iyzico') {
                loadIyzicoSettings();
            }
        }
        
        /**
         * Kullanƒ±cƒ± Paneli G√∂r√ºn√ºm√ºn√º Deƒüi≈ütirir
         */
        function showUserView(viewName) {
            const views = {
                info: userInfoView,
                renewal: userRenewalView,
                priceList: userPriceListView,
                messages: userMessagesView // YENƒ∞
            };
            const navButtons = {
                info: navUserInfo,
                renewal: navUserRenewal,
                priceList: navPriceList,
                messages: navUserMessages // YENƒ∞
            };

            for (const name in views) {
                views[name].style.display = 'none';
                navButtons[name].classList.remove('bg-orange-600', 'text-white');
                navButtons[name].classList.add('text-orange-600', 'hover:bg-orange-100');
            }

            views[viewName].style.display = 'block';
            navButtons[viewName].classList.add('bg-orange-600', 'text-white');
            navButtons[viewName].classList.remove('text-orange-600', 'hover:bg-orange-100');
            
            if (viewName === 'renewal' && currentLoggedInUser) {
                renewalUserTypeSelect.value = currentLoggedInUser.userType || 'YURTICI';
                loadIyzicoUserState(); // iyzico durumunu kontrol et ve paketleri y√ºkle
            } else if (viewName === 'priceList') {
                displayUserPriceList(); // YENƒ∞ Fiyat listesini g√∂ster
            } else if (viewName === 'messages') {
                displayUserMessages();
                loadUserConversation();
                const badge = document.getElementById('message-notification-badge');
                if (badge) {
                    badge.remove();
                }
            }
        }
        
        /**
         * Yeni Hesap Talebi Modal'ƒ±nƒ± A√ßar
         */
        function openAccountApprovalModal(requestData) {
            currentModalRequestId = requestData.id;
            
            // Modal Bilgilerini Doldur
            modalRequestId.textContent = requestData.id.substring(0, 8) + '...';
            document.getElementById('modalRequestName').textContent = requestData.fullName || 'Belirtilmemi≈ü';
            modalRequestType.textContent = requestData.userType === 'YURTDISI' ? 'üåç Yurtdƒ±≈üƒ±' : 'üáπüá∑ Yurti√ßi';
            modalRequestPhone.textContent = requestData.phoneNumber;
            modalRequestEmail.textContent = requestData.email || 'Bilinmiyor';
            modalRequestDuration.textContent = requestData.requestDuration;

            // Form Alanlarƒ±nƒ± √ñnceden Doldur/Temizle
            modalUsernameInput.value = requestData.generatedUsername || '';
            modalPasswordInput.value = requestData.generatedPassword || '';
            
            // Test hesabƒ± toggle'ƒ±nƒ± sƒ±fƒ±rla
            const testToggle = document.getElementById('modalTestAccountToggle');
            if (testToggle) testToggle.checked = false;
            
            // √úyelik s√ºresine g√∂re biti≈ü tarihi hesapla
            const now = new Date();
            const duration = requestData.requestDuration || '12 Ay';
            let monthsToAdd = 12;
            if (duration.includes('3')) monthsToAdd = 3;
            else if (duration.includes('6')) monthsToAdd = 6;
            else if (duration.includes('15')) monthsToAdd = 15;
            else monthsToAdd = 12;
            
            const expiryDate = new Date(now);
            expiryDate.setMonth(expiryDate.getMonth() + monthsToAdd);
            modalExpiryDateInput.value = expiryDate.toISOString().substring(0, 10);
            
            modalAccountTypeInput.value = 'Standart Paket';
            modalSubscriptionPeriodInput.value = requestData.requestDuration || '12 Ay';
            modalUserTypeSelect.value = requestData.userType || 'YURTICI';
            modalAdminNotesInput.value = '';

            // Modal'ƒ± G√∂ster
            accountApprovalModal.classList.remove('hidden');
        }

        /**
         * Yeni Hesap Talebi Modal'ƒ±nƒ± Kapatƒ±r
         */
        function closeModal() {
            accountApprovalModal.classList.add('hidden');
            currentModalRequestId = null;
        }

        /**
         * Kaydedilen Yeni Kullanƒ±cƒ±yƒ± Onaylar ve Kaydeder
         */
        async function saveApprovedAccount() {
            if (!currentModalRequestId) return;

            const username = modalUsernameInput.value.trim();
            const password = modalPasswordInput.value.trim();
            const expiryDate = modalExpiryDateInput.value.trim();
            const accountType = modalAccountTypeInput.value;
            const subscriptionPeriod = modalSubscriptionPeriodInput.value;
            const userType = modalUserTypeSelect.value;
            const email = modalRequestEmail.textContent.includes('Bilinmiyor') ? '' : modalRequestEmail.textContent;
            const phone = modalRequestPhone.textContent || '';
            const fullName = document.getElementById('modalRequestName').textContent || '';
            const adminNotes = modalAdminNotesInput.value.trim();
            const isTestAccount = document.getElementById('modalTestAccountToggle')?.checked || false;

            if (!username || !password || !expiryDate || !accountType || !userType) {
                showMessage("Kullanƒ±cƒ± Adƒ±, ≈ûifre, Biti≈ü Tarihi, Hesap Tipi ve Kullanƒ±m Alanƒ± zorunludur.", 'error');
                return;
            }

            saveApprovedAccountButton.disabled = true;
            saveApprovedAccountButton.innerHTML = '<svg class="animate-spin h-4 w-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Kaydediliyor...';

            const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
            const requestRef = doc(db, `artifacts/${appId}/public/data/new_account_requests`, currentModalRequestId);

            try {
                // Test hesabƒ±ysa biti≈ü tarihini 24 saat sonra yap (saat dahil)
                let finalExpiryDate = expiryDate;
                if (isTestAccount) {
                    const testExpiry = new Date();
                    testExpiry.setHours(testExpiry.getHours() + 24);
                    finalExpiryDate = testExpiry.toISOString(); // Tam tarih+saat
                }

                // 1. Yeni Kullanƒ±cƒ±yƒ± Aktif Listeye Kaydet
                const userData = {
                    iptvUsername: username,
                    iptvPassword: password,
                    expirationDate: finalExpiryDate,
                    accountType: isTestAccount ? 'Test Hesabƒ±' : accountType,
                    subscriptionPeriod: isTestAccount ? 'Test (24 Saat)' : subscriptionPeriod,
                    userType: userType,
                    email: email,
                    phoneNumber: phone,
                    fullName: fullName,
                    adminCreationNotes: adminNotes,
                    isTestAccount: isTestAccount,
                    isApproved: true,
                    createdAt: new Date().toISOString(),
                    lastUpdate: new Date().toISOString()
                };

                await setDoc(userRef, userData, { merge: true });

                // Abonelik logu olu≈ütur (test hesabƒ± deƒüilse)
                if (!isTestAccount) {
                    try {
                        const ci = getUserCreditInfo(userData);
                        const saleTL = getUserSalePrice(userData, ci);
                        const costTL = ci.credit * EUR_PER_CREDIT * (eurTryRate || 38);
                        const logRef = collection(db, `artifacts/${appId}/public/data/subscription_logs`);
                        await addDoc(logRef, {
                            username: username,
                            userType: userType,
                            subscriptionPeriod: isTestAccount ? 'Test (24 Saat)' : subscriptionPeriod,
                            newExpiryDate: finalExpiryDate,
                            credits: ci.credit,
                            saleTL: saleTL,
                            costTL: costTL,
                            profitTL: saleTL - costTL,
                            eurTryRate: eurTryRate || 38,
                            createdAt: new Date().toISOString(),
                            type: 'new'
                        });
                    } catch(logErr) {
                        console.warn('Abonelik logu olu≈üturulamadƒ±:', logErr);
                    }
                }

                // 2. Orijinal Talep Kaydƒ±nƒ± Sil
                await deleteDoc(requestRef);

                // 3. WhatsApp mesaj ≈üablonu olu≈ütur ve g√∂ster
                const whatsappMessage = isTestAccount 
                    ? `Merhaba *${fullName}*,\n\nBalkan Premium TV test hesabƒ±nƒ±z olu≈üturuldu! üéâ\n\n*üìã Hesap Bilgileri:*\nüë§ *Kullanƒ±cƒ± Adƒ±:* ${username}\nüîë *≈ûifre:* ${password}\nüìÖ *Test S√ºresi:* 24 Saat\nüåê *Kullanƒ±m:* ${userType === 'YURTDISI' ? 'Yurtdƒ±≈üƒ±' : 'Yurti√ßi'}\n\n‚ö†Ô∏è Bu bir test hesabƒ±dƒ±r ve 24 saat sonra s√ºresi dolacaktƒ±r.\n\n*Kurulum i√ßin:* https://www.balkanpremiumtv.de/sayfa/kurulumlar\n\nƒ∞yi seyirler! üì∫`
                    : `Merhaba *${fullName}*,\n\nBalkan Premium TV hesabƒ±nƒ±z ba≈üarƒ±yla olu≈üturuldu! üéâ\n\n*üìã Hesap Bilgileri:*\nüë§ *Kullanƒ±cƒ± Adƒ±:* ${username}\nüîë *≈ûifre:* ${password}\nüìÖ *√úyelik S√ºresi:* ${subscriptionPeriod}\nüìÖ *Biti≈ü Tarihi:* ${finalExpiryDate}\nüåê *Kullanƒ±m:* ${userType === 'YURTDISI' ? 'Yurtdƒ±≈üƒ±' : 'Yurti√ßi'}\nüì¶ *Paket:* ${accountType}\n\n*Kurulum i√ßin:* https://www.balkanpremiumtv.de/sayfa/kurulumlar\n*Panel:* https://balkantvpanel.web.app\n\nƒ∞yi seyirler! üì∫`;

                // WhatsApp modal'ƒ±nƒ± g√∂ster
                const whatsappOutput = document.getElementById('whatsappMessageOutput');
                if (whatsappOutput) {
                    whatsappOutput.value = whatsappMessage;
                }

                // 4. Kullanƒ±cƒ±ya e-posta ile bilgileri g√∂nder
                if (email) {
                    try {
                        const userMailData = {
                            to: email,
                            message: {
                                subject: isTestAccount 
                                    ? `üéâ Balkan Premium TV - Test Hesabƒ±nƒ±z Hazƒ±r!` 
                                    : `üéâ Balkan Premium TV - Hesabƒ±nƒ±z Olu≈üturuldu!`,
                                html: `<div style="font-family:Arial,sans-serif;max-width:500px;margin:0 auto;">
                                    <div style="background:#ea580c;color:white;padding:16px;border-radius:12px 12px 0 0;text-align:center;">
                                        <h2 style="margin:0;">${isTestAccount ? 'üß™ Test Hesabƒ±nƒ±z Hazƒ±r!' : 'üéâ Hesabƒ±nƒ±z Olu≈üturuldu!'}</h2>
                                    </div>
                                    <div style="background:#fff7ed;padding:20px;border:1px solid #fed7aa;">
                                        <p>Merhaba <strong>${fullName}</strong>,</p>
                                        <p>Balkan Premium TV ${isTestAccount ? 'test hesabƒ±nƒ±z' : 'hesabƒ±nƒ±z'} ba≈üarƒ±yla olu≈üturulmu≈ütur.</p>
                                        <table style="width:100%;border-collapse:collapse;margin:16px 0;">
                                            <tr><td style="padding:8px;border-bottom:1px solid #fed7aa;font-weight:bold;">üë§ Kullanƒ±cƒ± Adƒ±:</td><td style="padding:8px;border-bottom:1px solid #fed7aa;">${username}</td></tr>
                                            <tr><td style="padding:8px;border-bottom:1px solid #fed7aa;font-weight:bold;">üîë ≈ûifre:</td><td style="padding:8px;border-bottom:1px solid #fed7aa;">${password}</td></tr>
                                            <tr><td style="padding:8px;border-bottom:1px solid #fed7aa;font-weight:bold;">üìÖ ${isTestAccount ? 'Test S√ºresi:' : '√úyelik S√ºresi:'}</td><td style="padding:8px;border-bottom:1px solid #fed7aa;">${isTestAccount ? '24 Saat' : subscriptionPeriod}</td></tr>
                                            <tr><td style="padding:8px;font-weight:bold;">üåê Kullanƒ±m:</td><td style="padding:8px;">${userType === 'YURTDISI' ? 'Yurtdƒ±≈üƒ±' : 'Yurti√ßi'}</td></tr>
                                        </table>
                                        ${isTestAccount ? '<p style="color:#b45309;font-weight:bold;">‚ö†Ô∏è Bu bir test hesabƒ±dƒ±r ve 24 saat sonra s√ºresi dolacaktƒ±r.</p>' : ''}
                                        <p>üì∫ <a href="https://www.balkanpremiumtv.de/sayfa/kurulumlar" style="color:#ea580c;font-weight:bold;">Kurulum Rehberi</a></p>
                                        <p>üîê <a href="https://balkantvpanel.web.app" style="color:#ea580c;font-weight:bold;">Panel Giri≈üi</a></p>
                                    </div>
                                    <div style="background:#f3f4f6;padding:12px;border-radius:0 0 12px 12px;text-align:center;">
                                        <p style="margin:0;font-size:12px;color:#6b7280;">ƒ∞yi seyirler! - Balkan Premium TV</p>
                                    </div>
                                </div>`
                            }
                        };
                        await addDoc(collection(db, 'mail'), userMailData);
                    } catch (mailErr) {
                        console.warn('Kullanƒ±cƒ± mail hatasƒ±:', mailErr);
                    }
                }
                
                showMessage(`'${username}' kullanƒ±cƒ±sƒ± ba≈üarƒ±yla olu≈üturuldu${isTestAccount ? ' (Test Hesabƒ±)' : ''} ve talep kapatƒ±ldƒ±.`, 'success');
                
                closeModal();
                
                // WhatsApp mesaj modal'ƒ±nƒ± a√ß
                document.getElementById('whatsappMessageModal').classList.remove('hidden');
                
                fetchAllUsers(true);

            } catch (error) {
                console.error(`Kullanƒ±cƒ± kaydetme hatasƒ±:`, error);
                showMessage('Kullanƒ±cƒ± kaydetme sƒ±rasƒ±nda bir hata olu≈ütu.', 'error');
            } finally {
                saveApprovedAccountButton.disabled = false;
                saveApprovedAccountButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg> Kaydet ve Onayla';
            }
        }


        /**
         * Merkezi Global URL'yi getirir ve UI'ƒ± g√ºnceller.
         */
        async function fetchGlobalUrl() {
            if (!isAuthReady) return;
            try {
                const globalUrlRef = doc(db, `artifacts/${appId}/public/data/settings`, 'global');
                const docSnap = await getDoc(globalUrlRef);
                
                // Varsayƒ±lan deƒüerler
                const defaultUrls = {
                    domestic: 'http://default.domestic.link/list.m3u',
                    international: 'http://default.international.link/list.m3u'
                };
                
                if (docSnap.exists()) {
                    globalUrls = docSnap.data();
                    
                    globalUrls.domestic = globalUrls.domestic || defaultUrls.domestic;
                    globalUrls.international = globalUrls.international || defaultUrls.international;

                    currentGlobalUrlEl.innerHTML = `
                        Yurti√ßi: <code class="text-orange-600 break-all">${globalUrls.domestic}</code><br>
                        Yurtdƒ±≈üƒ±: <code class="text-orange-600 break-all">${globalUrls.international}</code>
                    `;
                    globalDomesticUrlInput.value = globalUrls.domestic;
                    globalInternationalUrlInput.value = globalUrls.international;

                    // M3U Base URL'leri y√ºkle
                    if (m3uBaseDomesticInput) m3uBaseDomesticInput.value = globalUrls.m3uBaseDomestic || '';
                    if (m3uBaseInternationalInput) m3uBaseInternationalInput.value = globalUrls.m3uBaseInternational || '';
                    if (currentM3uUrlsEl) {
                        const m3uDom = globalUrls.m3uBaseDomestic || 'Ayarlanmadƒ±';
                        const m3uInt = globalUrls.m3uBaseInternational || 'Ayarlanmadƒ±';
                        currentM3uUrlsEl.innerHTML = `
                            üáπüá∑ Yurti√ßi: <code class="text-green-600 break-all">${m3uDom}</code><br>
                            üåç Yurtdƒ±≈üƒ±: <code class="text-green-600 break-all">${m3uInt}</code>
                        `;
                    }
                    
                } else {
                    globalUrls = defaultUrls;
                    currentGlobalUrlEl.innerHTML = `Mevcut URL'ler: <code class="text-red-500 break-all">Ayarlanmadƒ±. Varsayƒ±lan kullanƒ±lƒ±yor.</code>`;
                    await setDoc(globalUrlRef, globalUrls);
                }
            } catch (error) {
                console.error("Global URL √ßekme hatasƒ±:", error);
                currentGlobalUrlEl.innerHTML = `Mevcut URL: <code class="text-red-500">Hata!</code>`;
            }
        }
        
        // fetchAdminCredentials kaldƒ±rƒ±ldƒ± - admin doƒürulama artƒ±k Cloud Functions √ºzerinden yapƒ±lƒ±yor
        
        /**
         * Fiyat Listesini Firestore'dan √ßeker ve Admin/User UI'ƒ±nƒ± g√ºnceller.
         * @param {boolean} updateAdminUI - Sadece y√∂netici panelindeki fiyat giri≈ülerini g√ºncellemek i√ßin
         */
        async function fetchPriceList(updateAdminUI = false) {
            if (!isAuthReady) return;

            try {
                const priceRef = doc(db, `artifacts/${appId}/public/data/settings`, 'price_list');
                const docSnap = await getDoc(priceRef);
                
                // Varsayƒ±lan fiyatlar - Yurti√ßi
                const defaultPricesDomestic = {
                    single3M: 750, single6M: 1050, single12M: 1600, single15M: 2000, double12M: 2800
                };
                
                // Varsayƒ±lan fiyatlar - Yurtdƒ±≈üƒ±
                const defaultPricesInternational = {
                    single12M: 50 // 50 EUR, tek tipi
                };
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    priceList = {
                        domestic: { ...defaultPricesDomestic, ...data.domestic },
                        international: { ...defaultPricesInternational, ...data.international }
                    };
                } else {
                    priceList = {
                        domestic: defaultPricesDomestic,
                        international: defaultPricesInternational
                    };
                    await setDoc(priceRef, priceList);
                }

                if (updateAdminUI) {
                    priceSingle3MInput.value = priceList.domestic.single3M;
                    priceSingle6MInput.value = priceList.domestic.single6M;
                    priceSingle12MInput.value = priceList.domestic.single12M;
                    priceSingle15MInput.value = priceList.domestic.single15M;
                    priceDouble12MInput.value = priceList.domestic.double12M;
                    // Yurtdƒ±≈üƒ± fiyat alanƒ±nƒ± g√ºncelle
                    const intlPriceInput = document.getElementById('priceInternational12M');
                    if (intlPriceInput) intlPriceInput.value = priceList.international?.single12M || 50;
                    currentPriceListStatusEl.textContent = `Son G√ºncelleme: ${new Date().toLocaleTimeString('tr-TR')}`;
                }
                
                // M√º≈üteri fiyat listesini de g√ºncelle (YENƒ∞)
                if(userPriceListView.style.display !== 'none' || !updateAdminUI) {
                    displayUserPriceList();
                }

            } catch (error) {
                console.error("Fiyat listesi √ßekme hatasƒ±:", error);
                currentPriceListStatusEl.textContent = `Hata: Fiyat listesi y√ºklenemedi.`;
            }
        }
        
        /**
         * M√º≈üteri Panelindeki Fiyat Listesini g√∂r√ºnt√ºler (YENƒ∞)
         */
        function displayUserPriceList() {
            // Kullanƒ±cƒ± tipine g√∂re doƒüru fiyat listesini se√ß
            const userType = currentLoggedInUser?.userType?.toUpperCase();
            const isInternational = userType === 'YURTDISI';
            const prices = isInternational ? priceList.international : priceList.domestic;
            const currencySymbol = isInternational ? '‚Ç¨' : '‚Ç∫';
            const currencyText = isInternational ? 'Avrupa Dolarƒ± (‚Ç¨)' : 'T.C. T√ºrk Lirasƒ± (‚Ç∫)';

            let content = '';
            
            if (isInternational) {
                // Yurtdƒ±≈üƒ± - Tek tipi
                content = `
                    <div class="space-y-8">
                        <div>
                            <h2 class="text-2xl font-bold text-center text-gray-800">Abonelik Paketiniz</h2>
                            <p class="text-center text-gray-500 mt-2">Yurtdƒ±≈üƒ± kullanƒ±cƒ±larƒ± i√ßin √∂zel paket</p>
                        </div>

                        <div class="flex justify-center">
                            <!-- 12 Ay Yurtdƒ±≈üƒ± (Pop√ºler) -->
                            <div class="border-2 border-orange-500 rounded-xl p-8 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-orange-50 shadow-2xl relative w-full max-w-sm">
                                <div class="absolute top-0 -translate-y-1/2 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full uppercase">√ñzel Fiyat</div>
                                <h3 class="font-bold text-lg text-orange-800">Tek Cihaz</h3>
                                <p class="font-semibold text-orange-600 text-5xl mt-4">${prices.single12M} <span class="text-2xl">${currencySymbol}</span></p>
                                <p class="text-gray-600 font-medium">12 Aylƒ±k Abonelik</p>
                                <button onclick="selectPlan('12 Ay')" class="mt-6 w-full py-3 px-4 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition-colors shadow-md">Hemen Ba≈üla</button>
                            </div>
                        </div>
                    </div>
                    <p class="mt-8 text-sm text-center text-gray-600">Fiyatlar ${currencyText} cinsindendir. Se√ßim sonrasƒ± √ºyelik uzatma sayfasƒ±na y√∂nlendirileceksiniz.</p>
                `;
            } else {
                // Yurti√ßi - T√ºm se√ßenekler
                content = `
                    <div class="space-y-8">
                        <div>
                            <h2 class="text-2xl font-bold text-center text-gray-800">Size Uygun Paketi Se√ßin</h2>
                            <p class="text-center text-gray-500 mt-2">En uygun fiyatlarla yurti√ßi hizmeti.</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                            <!-- 3 Ay Tekli -->
                            <div class="border rounded-xl p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-white shadow-lg">
                                <h3 class="font-bold text-lg text-gray-700">Tek Cihaz</h3>
                                <p class="font-semibold text-orange-600 text-4xl mt-4">${prices.single3M} <span class="text-xl">${currencySymbol}</span></p>
                                <p class="text-gray-500 font-medium">3 Aylƒ±k Abonelik</p>
                                <button onclick="selectPlan('3 Ay')" class="mt-6 w-full py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-lg hover:bg-orange-200 transition-colors">Se√ß</button>
                            </div>

                            <!-- 6 Ay Tekli -->
                            <div class="border rounded-xl p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-white shadow-lg">
                                <h3 class="font-bold text-lg text-gray-700">Tek Cihaz</h3>
                                <p class="font-semibold text-orange-600 text-4xl mt-4">${prices.single6M} <span class="text-xl">${currencySymbol}</span></p>
                                <p class="text-gray-500 font-medium">6 Aylƒ±k Abonelik</p>
                                <button onclick="selectPlan('6 Ay')" class="mt-6 w-full py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-lg hover:bg-orange-200 transition-colors">Se√ß</button>
                            </div>
                            
                            <!-- 12 Ay Tekli -->
                            <div class="border rounded-xl p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-white shadow-lg">
                                <h3 class="font-bold text-lg text-gray-700">Tek Cihaz</h3>
                                <p class="font-semibold text-orange-600 text-4xl mt-4">${prices.single12M} <span class="text-xl">${currencySymbol}</span></p>
                                <p class="text-gray-500 font-medium">12 Aylƒ±k Abonelik</p>
                                <button onclick="selectPlan('12 Ay')" class="mt-6 w-full py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-lg hover:bg-orange-200 transition-colors">Se√ß</button>
                            </div>

                            <!-- 15 Ay Tekli (Pop√ºler) -->
                            <div class="border-2 border-orange-500 rounded-xl p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-orange-50 shadow-2xl relative">
                                <div class="absolute top-0 -translate-y-1/2 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full uppercase">Pop√ºler</div>
                                <h3 class="font-bold text-lg text-orange-800">Tek Cihaz</h3>
                                <p class="font-semibold text-orange-600 text-5xl mt-4">${prices.single15M} <span class="text-2xl">${currencySymbol}</span></p>
                                <p class="text-gray-600 font-medium">15 Aylƒ±k Abonelik</p>
                                <button onclick="selectPlan('15 Ay')" class="mt-6 w-full py-3 px-4 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition-colors shadow-md">Hemen Ba≈üla</button>
                            </div>

                            <!-- 12 Ay √áiftli -->
                            <div class="border rounded-xl p-6 flex flex-col items-center text-center transform hover:scale-105 transition-transform duration-300 bg-white shadow-lg">
                                 <h3 class="font-bold text-lg text-blue-800">√áift Cihaz</h3>
                                <p class="font-semibold text-blue-600 text-5xl mt-4">${prices.double12M} <span class="text-2xl">${currencySymbol}</span></p>
                                <p class="text-gray-500 font-medium">12 Aylƒ±k Abonelik (√áift Cihaz)</p>
                                <button onclick="selectPlan('12 Ay √áift')" class="mt-6 w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors shadow-md">Hemen Ba≈üla</button>
                            </div>
                        </div>
                    </div>
                    <p class="mt-8 text-sm text-center text-gray-600">Fiyatlar ${currencyText} cinsindendir. G√ºncel kur farklarƒ± uygulanabilir. Se√ßim sonrasƒ± √ºyelik uzatma sayfasƒ±na y√∂nlendirileceksiniz.</p>
                `;
            }
            
            priceListDisplay.innerHTML = content;
        }

        window.selectPlan = function(duration) {
            showUserView('renewal');
            // '15 Ay' veya '12 Ay √áift' gelirse doƒüru e≈üle≈ütirme yap
            let renewalOption = duration;
            if (duration === '12 Ay √áift') renewalOption = '12 Ay';
            renewalDurationSelect.value = renewalOption;
        }

        /**
         * Fiyat Listesini G√ºnceller (YENƒ∞)
         */
        async function updatePriceList() {
            if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim.", 'error');
                return;
            }
            
            const newPrices = {
                domestic: {
                    single3M: parseFloat(priceSingle3MInput.value) || 0,
                    single6M: parseFloat(priceSingle6MInput.value) || 0,
                    single12M: parseFloat(priceSingle12MInput.value) || 0,
                    single15M: parseFloat(priceSingle15MInput.value) || 0,
                    double12M: parseFloat(priceDouble12MInput.value) || 0
                },
                international: {
                    single12M: parseFloat(document.getElementById('priceInternational12M')?.value) || 50
                }
            };

            if (Object.values(newPrices.domestic).some(p => p <= 0)) {
                showMessage("T√ºm yurti√ßi fiyat alanlarƒ± ge√ßerli (pozitif) sayƒ± olmalƒ±dƒ±r.", 'error');
                return;
            }

            updatePriceListButton.disabled = true;
            updatePriceListButton.textContent = "G√ºncelleniyor...";

            try {
                const priceRef = doc(db, `artifacts/${appId}/public/data/settings`, 'price_list');
                await setDoc(priceRef, newPrices, { merge: true });
                
                await fetchPriceList(true); // Hem fiyatƒ± √ßek hem de Admin UI'ƒ± g√ºncelle
                showMessage("Fiyat listesi ba≈üarƒ±yla g√ºncellendi!", 'success');

            } catch (error) {
                console.error("Fiyat listesi g√ºncelleme hatasƒ±:", error);
                showMessage('Fiyat listesi g√ºncellenirken bir hata olu≈ütu.', 'error');
            } finally {
                updatePriceListButton.disabled = false;
                updatePriceListButton.textContent = "Fiyat Listesini G√ºncelle";
            }
        }


        /**
         * Firebase Ba≈ülatma ve Kimlik Doƒürulama
         */
        async function initializeFirebase() {
             try {
                if (Object.keys(firebaseConfig).length === 0) {
                    showMessage("Firebase yapƒ±landƒ±rmasƒ± eksik. Uygulama √ßalƒ±≈ümayacaktƒ±r.", 'error');
                    authStatusEl.textContent = "HATA: Firebase yapƒ±landƒ±rmasƒ± eksik.";
                    return;
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                functions = getFunctions(app);
                console.log('Firebase initialized successfully');

                onAuthStateChanged(auth, async (user) => {
                    console.log('onAuthStateChanged:', user ? 'user logged in' : 'no user');
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `Kimlik Doƒürulama Ba≈üarƒ±lƒ±.`;
                        isAuthReady = true;
                        loginButton.disabled = false;
                        
                        // Admin claim kontrol√º (cache'li - hƒ±zlƒ±)
                        const tokenResult = await user.getIdTokenResult();
                        isAdminUser = tokenResult.claims.admin === true;
                        
                        // Oturum kalƒ±cƒ±lƒ±ƒüƒ± - √∂nceki oturumu geri y√ºkle (√∂ncelikli)
                        await restoreSession();
                        
                        // Firebase verilerini arka planda √ßek (login'i bloklamaz)
                        Promise.all([
                            fetchGlobalUrl(),
                            fetchPriceList(false)
                        ]).catch(e => console.warn('Arka plan veri √ßekme hatasƒ±:', e));

                    } else {
                        authStatusEl.textContent = "Kimlik Doƒürulama bekleniyor...";
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase ba≈ülatma hatasƒ±:", error);
                showMessage('Sistem ba≈ülatƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin.', 'error');
                authStatusEl.textContent = 'Baƒülantƒ± hatasƒ±. Sayfayƒ± yenileyiniz.';
            }
        }

        /**
         * √ñnceki oturumu geri y√ºkler (sessionStorage'dan)
         */
        async function restoreSession() {
            const savedSession = sessionStorage.getItem('iptvSession');
            if (!savedSession) return;
            
            try {
                const session = JSON.parse(savedSession);
                
                if (session.type === 'admin' && isAdminUser) {
                    // Admin oturumu geri y√ºkle
                    loginForm.style.display = 'none';
                    adminView.style.display = 'block';
                    fetchAllUsers(true);
                    showAdminView('dashboard');
                    startRealtimeListeners();
                    requestNotificationPermission();
                    console.log('Admin oturumu geri y√ºklendi.');
                    return;
                }
                
                if (session.type === 'user' && session.username) {
                    // Kullanƒ±cƒ± oturumunu geri y√ºkle (token doƒürulamalƒ±)
                    const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, session.username);
                    const docSnap = await getDoc(userRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Session token doƒürulama
                        if (!session.token || data.sessionToken !== session.token) {
                            console.warn('Oturum token doƒürulamasƒ± ba≈üarƒ±sƒ±z, yeniden giri≈ü gerekli.');
                            sessionStorage.removeItem('iptvSession');
                            return;
                        }
                        
                        if (data.isApproved === false) {
                            sessionStorage.removeItem('iptvSession');
                            return;
                        }
                        currentLoggedInUser = data;
                        userWelcomeHeader.textContent = `Ho≈ü Geldiniz, ${data.iptvUsername}!`;
                        showUserSkeleton();
                        displayUserData(data);
                        hideUserSkeleton();
                        
                        // Geri sayƒ±m ve ger√ßek zamanlƒ± bildirimler
                        if (data.expirationDate) startCountdown(data.expirationDate);
                        startUserRealtimeListener(data.iptvUsername);
                        requestNotificationPermission();
                        
                        // G√ºvenlik: ≈ûifreyi bellekten temizle (displayUserData zaten kullandƒ±)
                        delete currentLoggedInUser.iptvPassword;
                        
                        loginForm.style.display = 'none';
                        userView.style.display = 'block';
                        showUserView('info');
                        await checkForNewMessages();
                        console.log('Kullanƒ±cƒ± oturumu geri y√ºklendi:', session.username);
                    } else {
                        sessionStorage.removeItem('iptvSession');
                    }
                }
            } catch (e) {
                console.warn('Oturum geri y√ºkleme hatasƒ±:', e);
                sessionStorage.removeItem('iptvSession');
            }
        }

        /**
         * Birle≈üik Giri≈ü ƒ∞≈üleyicisi (M√º≈üteri veya Y√∂netici)
         */
        let isLoggingIn = false;
        async function handleMainLogin() {
            console.log('handleMainLogin called, isAuthReady:', isAuthReady);
            if (isLoggingIn) return;
            if (!isAuthReady) {
                showMessage("Sistem hen√ºz hazƒ±r deƒüil. L√ºtfen bekleyiniz.", 'error');
                return;
            }

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!username || !password) {
                showMessage("L√ºtfen kullanƒ±cƒ± adƒ± ve ≈üifrenizi giriniz.", 'info');
                return;
            }
            
            loginButton.disabled = true;
            loginButton.textContent = "Giri≈ü Yapƒ±lƒ±yor...";
            isLoggingIn = true;
            
            try {
                // 1. √ñNCE M√ú≈ûTERƒ∞ KONTROL√ú (√ßoƒüu giri≈ü m√º≈üteri olacak)
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    if (data.iptvPassword !== password) {
                         showMessage(`Hata: Yanlƒ±≈ü ≈üifre. L√ºtfen tekrar deneyin.`, 'error');
                         return;
                    }
                    
                    // Onay kontrol√º
                    if (data.isApproved === false) {
                        showMessage(`Hesabƒ±nƒ±z hen√ºz admin tarafƒ±ndan onaylanmamƒ±≈ütƒ±r. L√ºtfen onay s√ºrecini bekleyiniz.`, 'info');
                        return;
                    }
                    
                    currentLoggedInUser = data;
                    
                    // Son giri≈ü tarihini g√ºncelle + oturum token'ƒ± olu≈ütur
                    const nowIso = new Date().toISOString();
                    const sessionToken = crypto.randomUUID ? crypto.randomUUID() : Array.from(crypto.getRandomValues(new Uint8Array(16)), b => b.toString(16).padStart(2, '0')).join('');
                    await setDoc(userRef, { lastLoginDate: nowIso, sessionToken: sessionToken }, { merge: true });
                    data.lastLoginDate = nowIso; 
                    
                    // Oturumu kaydet (token ile)
                    sessionStorage.setItem('iptvSession', JSON.stringify({ type: 'user', username: data.iptvUsername, token: sessionToken }));
                    
                    // Yeni mesajlarƒ± kontrol et
                    await checkForNewMessages();
                    
                    // Kullanƒ±cƒ± aray√ºz√ºn√º g√ºncelle
                    userWelcomeHeader.textContent = `Ho≈ü Geldiniz, ${data.iptvUsername}!`;
                    showUserSkeleton();
                    displayUserData(data);
                    hideUserSkeleton();
                    
                    // Geri sayƒ±m ve ger√ßek zamanlƒ± bildirimler
                    if (data.expirationDate) startCountdown(data.expirationDate);
                    startUserRealtimeListener(data.iptvUsername);
                    requestNotificationPermission();
                    
                    // G√ºvenlik: ≈ûifreyi bellekten temizle (displayUserData zaten kullandƒ±)
                    delete currentLoggedInUser.iptvPassword;

                    loginForm.style.display = 'none';
                    userView.style.display = 'block';
                    showUserView('info'); 
                    showMessage(`Giri≈ü ba≈üarƒ±lƒ±! G√ºncel bilgileriniz g√∂r√ºnt√ºlendi.`, 'success');
                    return;
                }

                // 2. Y√ñNETƒ∞Cƒ∞ KONTROL√ú (Cloud Function ile g√ºvenli doƒürulama)
                try {
                    const verifyAdmin = httpsCallable(functions, 'verifyAdmin', { timeout: 30000 });
                    let result;
                    try {
                        result = await verifyAdmin({ username, password });
                    } catch (retryErr) {
                        // Cold start CORS hatasƒ± durumunda bir kez daha dene
                        if (retryErr.code === 'functions/internal' || retryErr.message?.includes('CORS') || retryErr.message?.includes('Failed to fetch')) {
                            console.log('Cloud Function cold start, yeniden deneniyor...');
                            result = await verifyAdmin({ username, password });
                        } else {
                            throw retryErr;
                        }
                    }
                    
                    if (result.data.success) {
                        // Token'ƒ± yenile (yeni custom claims alƒ±nmasƒ± i√ßin)
                        await auth.currentUser.getIdToken(true);
                        isAdminUser = true;
                        
                        // Admin oturumunu kaydet
                        sessionStorage.setItem('iptvSession', JSON.stringify({ type: 'admin' }));
                        
                        showMessage("Y√∂netici giri≈üi ba≈üarƒ±lƒ±!", 'success');
                        loginForm.style.display = 'none';
                        adminView.style.display = 'block';
                        fetchAllUsers(true); 
                        showAdminView('dashboard');
                        startRealtimeListeners();
                        requestNotificationPermission();
                        return;
                    }
                } catch (adminError) {
                    // Admin deƒüilse veya ≈üifre yanlƒ±≈üsa normal hata
                    if (adminError.code === 'functions/permission-denied') {
                        showMessage(`Hata: Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü.`, 'error');
                    } else if (adminError.code === 'functions/not-found') {
                        showMessage(`Hata: Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü.`, 'error');
                    } else {
                        showMessage(`Hata: Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü.`, 'error');
                    }
                    return;
                }

                showMessage(`Hata: Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü. L√ºtfen kontrol edin.`, 'error');
            } catch (error) {
                console.error("Giri≈ü hatasƒ±:", error);
                showMessage('Giri≈ü sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = "Giri≈ü Yap";
                isLoggingIn = false;
            }
        }
        
        /**
         * Rastgele 10 karakterli kullanƒ±cƒ± adƒ±/≈üifre √ºretir (b√ºy√ºk-k√º√ß√ºk harf + rakam, T√ºrk√ße karakter yok)
         */
        function generateRandomCredential(length = 10) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            const array = new Uint32Array(length);
            crypto.getRandomValues(array);
            return Array.from(array, v => chars[v % chars.length]).join('');
        }

        /**
         * Yeni Hesap Olu≈üturma Talebi G√∂nderir
         */
        async function submitNewAccountRequest() {
            const fullName = document.getElementById('newAccountNameInput').value.trim();
            const phone = newAccountPhoneInput.value.trim();
            const email = newAccountEmailInput.value.trim();
            const userType = newAccountTypeSelect.value;
            const duration = newAccountDurationSelect.value;
            const phoneError = document.getElementById('newAccountPhoneError');
            
            phoneError.classList.add('hidden');
            
            if (!fullName || !phone || !email || !userType || !duration) {
                showMessage("L√ºtfen t√ºm alanlarƒ± doldurunuz.", 'info');
                return;
            }

            // Telefon numarasƒ± format kontrol√º
            const cleanPhone = phone.replace(/\s/g, '').replace(/[^0-9+]/g, '');
            if (cleanPhone.length < 10) {
                showMessage("Ge√ßerli bir telefon numarasƒ± giriniz.", 'error');
                return;
            }

            // E-posta format kontrol√º
            if (!email.includes('@') || !email.includes('.')) {
                showMessage("Ge√ßerli bir e-posta adresi giriniz.", 'error');
                return;
            }

            // Rate limiting: Aynƒ± tarayƒ±cƒ±dan 10 dakikada sadece 1 talep
            const lastRequestTime = localStorage.getItem('lastNewAccountRequest');
            if (lastRequestTime) {
                const timeDiff = (Date.now() - parseInt(lastRequestTime)) / 1000 / 60;
                if (timeDiff < 10) {
                    showMessage(`L√ºtfen ${Math.ceil(10 - timeDiff)} dakika sonra tekrar deneyiniz. Spam korumasƒ± aktif.`, 'info');
                    return;
                }
            }
            
            submitNewAccountRequestButton.disabled = true;
            submitNewAccountRequestButton.textContent = "Kontrol ediliyor...";
            
            try {
                // Telefon numarasƒ± benzersizlik kontrol√º
                // Not: Normal kullanƒ±cƒ±lar koleksiyon listeleyemez, kontrol ba≈üarƒ±sƒ±z olursa talep yine g√∂nderilir
                let phoneCheckPassed = true;
                try {
                    const requestsRef = collection(db, `artifacts/${appId}/public/data/new_account_requests`);
                    const phoneQuery = query(requestsRef, where('phoneNumber', '==', cleanPhone));
                    const existingRequests = await getDocs(phoneQuery);
                    
                    if (!existingRequests.empty) {
                        phoneError.textContent = '‚ö†Ô∏è Bu telefon numarasƒ± ile daha √∂nce hesap talebi olu≈üturulmu≈ü. Her numara ile yalnƒ±zca 1 kez talep g√∂nderilebilir.';
                        phoneError.classList.remove('hidden');
                        showMessage("Bu telefon numarasƒ± ile zaten bir talep mevcut.", 'error');
                        phoneCheckPassed = false;
                    }
                } catch (phoneCheckErr) {
                    console.log('Telefon kontrol sorgusu atlandƒ± (yetki kƒ±sƒ±tlƒ±):', phoneCheckErr.code);
                }

                if (!phoneCheckPassed) return;

                try {
                    const usersRef = collection(db, `artifacts/${appId}/public/data/iptv_users`);
                    const usersSnapshot = await getDocs(usersRef);
                    let phoneExists = false;
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.phoneNumber === cleanPhone) {
                            phoneExists = true;
                        }
                    });

                    if (phoneExists) {
                        phoneError.textContent = '‚ö†Ô∏è Bu telefon numarasƒ± ile kayƒ±tlƒ± bir hesap zaten mevcut. L√ºtfen giri≈ü yapƒ±nƒ±z.';
                        phoneError.classList.remove('hidden');
                        showMessage("Bu telefon numarasƒ± ile kayƒ±tlƒ± bir hesap zaten var.", 'error');
                        return;
                    }
                } catch (userCheckErr) {
                    console.log('Kullanƒ±cƒ± telefon kontrol sorgusu atlandƒ± (yetki kƒ±sƒ±tlƒ±):', userCheckErr.code);
                }

                submitNewAccountRequestButton.textContent = "Talep G√∂nderiliyor...";
                
                // Otomatik kullanƒ±cƒ± adƒ± ve ≈üifre √ºret (farklƒ± olmalarƒ± GARANTƒ∞)
                const generatedUsername = generateRandomCredential(10);
                let generatedPassword = generateRandomCredential(10);
                // ≈ûifre kullanƒ±cƒ± adƒ±yla aynƒ±ysa tekrar √ºret (ekstra g√ºvenlik)
                while (generatedPassword === generatedUsername) {
                    generatedPassword = generateRandomCredential(10);
                }
                const requestData = {
                    fullName: fullName,
                    phoneNumber: cleanPhone,
                    email: email,
                    requestDuration: duration,
                    userType: userType,
                    requestDate: new Date().toISOString(),
                    status: 'Beklemede',
                    generatedUsername: generatedUsername,
                    generatedPassword: generatedPassword,
                };
                
                await addDoc(requestsRef, requestData);
                
                // Admin'e e-posta bildirimi g√∂nder
                try {
                    const mailData = {
                        to: ADMIN_NOTIFICATION_EMAIL,
                        message: {
                            subject: `üÜï YENƒ∞ HESAP TALEBƒ∞ - ${fullName}`,
                            html: `<div style="font-family:Arial,sans-serif;max-width:500px;">
                                <h2 style="color:#ea580c;">üÜï Yeni Hesap Olu≈üturma Talebi</h2>
                                <table style="width:100%;border-collapse:collapse;">
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">Ad Soyad:</td><td style="padding:8px;border-bottom:1px solid #eee;">${escapeHtml(fullName)}</td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">Telefon:</td><td style="padding:8px;border-bottom:1px solid #eee;">${escapeHtml(cleanPhone)}</td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">E-posta:</td><td style="padding:8px;border-bottom:1px solid #eee;">${escapeHtml(email)}</td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">Kullanƒ±m Alanƒ±:</td><td style="padding:8px;border-bottom:1px solid #eee;">${userType === 'YURTICI' ? 'üáπüá∑ Yurti√ßi' : 'üåç Yurtdƒ±≈üƒ±'}</td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">ƒ∞stenen S√ºre:</td><td style="padding:8px;border-bottom:1px solid #eee;">${duration}</td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">Olu≈üturulan Kullanƒ±cƒ± Adƒ±:</td><td style="padding:8px;border-bottom:1px solid #eee;"><strong>${generatedUsername}</strong></td></tr>
                                    <tr><td style="padding:8px;border-bottom:1px solid #eee;font-weight:bold;">Olu≈üturulan ≈ûifre:</td><td style="padding:8px;border-bottom:1px solid #eee;"><strong>${generatedPassword}</strong></td></tr>
                                    <tr><td style="padding:8px;font-weight:bold;">Tarih:</td><td style="padding:8px;">${new Date().toLocaleString('tr-TR')}</td></tr>
                                </table>
                                <p style="margin-top:16px;padding:12px;background:#fff7ed;border-radius:8px;font-size:13px;">
                                    ‚ö° Talebi onaylamak i√ßin <a href="https://balkantvpanel.web.app" style="color:#ea580c;font-weight:bold;">panele giri≈ü yapƒ±n</a>.
                                </p>
                            </div>`
                        }
                    };
                    await addDoc(collection(db, 'mail'), mailData);
                } catch (mailError) {
                    console.warn("Mail g√∂nderme hatasƒ± (sistem devam ediyor):", mailError);
                }
                
                showMessage(`Hesap olu≈üturma talebiniz ba≈üarƒ±yla g√∂nderildi! Kullanƒ±cƒ± bilgileriniz a≈üaƒüƒ±da g√∂sterilmektedir.`, 'success');
                
                // √úretilen bilgileri kullanƒ±cƒ±ya g√∂ster
                const credBox = document.getElementById('newAccountCredentialsBox');
                document.getElementById('generatedUsername').textContent = generatedUsername;
                document.getElementById('generatedPassword').textContent = generatedPassword;
                credBox.classList.remove('hidden');
                
                // Form alanlarƒ±nƒ± temizle (credentials kutusu kalacak)
                document.getElementById('newAccountNameInput').value = '';
                newAccountPhoneInput.value = '';
                newAccountEmailInput.value = '';
                newAccountDurationSelect.value = '';
                newAccountTypeSelect.value = '';
                document.getElementById('newAccountDurationWrapper').classList.add('hidden');
                submitNewAccountRequestButton.classList.add('hidden');
                
                // Rate limiting kaydƒ±
                localStorage.setItem('lastNewAccountRequest', Date.now().toString());

            } catch (error) {
                console.error("Yeni hesap talebi g√∂nderme hatasƒ±:", error);
                showMessage('Talep g√∂nderilirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                submitNewAccountRequestButton.disabled = false;
                submitNewAccountRequestButton.textContent = "Hesap Olu≈üturma Talebini G√∂nder";
            }
        }


        /**
         * Hesap Uzatma Talebi G√∂nderir
         */
        async function sendRenewalRequest() {
            if (!currentLoggedInUser) {
                showMessage("√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z.", 'error');
                return;
            }

            const duration = renewalDurationSelect.value;
            const phone = phoneNumberInput.value.trim();
            const userType = renewalUserTypeSelect.value;
            
            if (!duration || !phone || !userType) {
                showMessage("L√ºtfen uzatma s√ºresi, telefon numaranƒ±zƒ± ve √ºyelik tipinizi se√ßin.", 'info');
                return;
            }

            // Rate limiting: Aynƒ± kullanƒ±cƒ± 5 dakikada sadece 1 talep atabilir
            const lastRenewalRequestTime = localStorage.getItem(`lastRenewalRequest_${currentLoggedInUser.iptvUsername}`);
            if (lastRenewalRequestTime) {
                const timeDiff = (Date.now() - parseInt(lastRenewalRequestTime)) / 1000 / 60; // Dakika
                if (timeDiff < 5) {
                    showMessage(`L√ºtfen ${Math.ceil(5 - timeDiff)} dakika sonra tekrar deneyiniz. Spam talepler sistem tarafƒ±ndan bloke edilir.`, 'info');
                    return;
                }
            }
            
            sendRenewalRequestButton.disabled = true;
            sendRenewalRequestButton.textContent = "Talep G√∂nderiliyor...";
            
            try {
                const requestData = {
                    username: currentLoggedInUser.iptvUsername,
                    requestDuration: duration,
                    phoneNumber: phone,
                    userTypeConfirmed: userType, 
                    requestDate: new Date().toISOString(),
                    status: 'Beklemede',
                };
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/renewal_requests`), requestData);
                
                // Admin'e e-posta bildirimi g√∂nder
                try {
                    const mailData = {
                        to: ADMIN_NOTIFICATION_EMAIL,
                        message: {
                            subject: `üì¢ YENƒ∞ √úYELƒ∞K UZATMA TALEBƒ∞ - ${currentLoggedInUser.iptvUsername}`,
                            text: `Yeni bir √ºyelik uzatma talebi alƒ±ndƒ±:\n\nKullanƒ±cƒ±: ${currentLoggedInUser.iptvUsername}\nS√ºre: ${duration}\nTip: ${userType}\nTelefon: ${phone}\nTarih: ${new Date().toLocaleString('tr-TR')}`
                        }
                    };
                    await addDoc(collection(db, 'mail'), mailData);
                } catch (mailError) {
                    console.warn("Mail g√∂nderme hatasƒ± (sistem devam ediyor):", mailError);
                }
                
                showMessage(`Hesap uzatma talebiniz (${duration}, ${userType}) ba≈üarƒ±yla g√∂nderildi.`, 'success');
                renewalDurationSelect.value = "";
                phoneNumberInput.value = "";
                renewalUserTypeSelect.value = "";
                
                // Rate limiting kaydƒ± g√ºncelle
                localStorage.setItem(`lastRenewalRequest_${currentLoggedInUser.iptvUsername}`, Date.now().toString());

            } catch (error) {
                console.error("Talep g√∂nderme hatasƒ±:", error);
                showMessage('Uzatma talebi g√∂nderilirken bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                sendRenewalRequestButton.disabled = false;
                sendRenewalRequestButton.textContent = "Uzatma Talebini G√∂nder";
            }
        }


        /**
         * √áekilen kullanƒ±cƒ± verilerini ekranda g√∂r√ºnt√ºler
         */
        function displayUserData(data) {
            resultContainer.classList.remove('hidden');
            
            // Durum rozeti (badge) g√ºncelle
            const statusBadge = document.getElementById('subscriptionStatusBadge');
            if (statusBadge) {
                const now = new Date();
                const expiry = data.expirationDate ? new Date(data.expirationDate) : null;
                
                if (data.isApproved === false) {
                    statusBadge.textContent = '‚è≥ Onay S√ºrecinde';
                    statusBadge.className = 'ml-3 text-xs font-bold px-3 py-1 rounded-full bg-yellow-200 text-yellow-800 animate-pulse';
                } else if (expiry && expiry > now) {
                    statusBadge.textContent = '‚úÖ Aktif';
                    statusBadge.className = 'ml-3 text-xs font-bold px-3 py-1 rounded-full bg-green-200 text-green-800';
                } else {
                    statusBadge.textContent = '‚ùå Devre Dƒ±≈üƒ±';
                    statusBadge.className = 'ml-3 text-xs font-bold px-3 py-1 rounded-full bg-red-200 text-red-800';
                }
            }
            
            // Kullanƒ±m alanƒ±na g√∂re URL atamasƒ± (displayUserData √ßaƒürƒ±lmadan √∂nce globalUrls y√ºkl√º)
            if (data.userType && data.userType.toUpperCase() === 'YURTDISI') {
                data.newUrl = globalUrls.international || 'URL ayarlanmamƒ±≈ü';
            } else { // YURTICI veya tanƒ±msƒ±z ise
                data.newUrl = globalUrls.domestic || 'URL ayarlanmamƒ±≈ü';
            }

            // M3U Playlist URL olu≈ütur (base URL + kullanƒ±cƒ± bilgileri)
            const m3uBaseUrl = (data.userType && data.userType.toUpperCase() === 'YURTDISI') 
                ? globalUrls.m3uBaseInternational 
                : globalUrls.m3uBaseDomestic;
            
            if (m3uBaseUrl) {
                data.m3uUrl = `${m3uBaseUrl}/get.php?username=${encodeURIComponent(data.iptvUsername)}&password=${encodeURIComponent(data.iptvPassword)}&type=m3u_plus&output=ts`;
            } else {
                data.m3uUrl = 'M3U URL hen√ºz ayarlanmamƒ±≈ü';
            }

            // URL g√ºncelleme tarihi ve "Yeni Link" badge kontrol√º
            const urlUpdatedAt = globalUrls.urlUpdatedAt;
            let urlBadgeHtml = '';
            let urlDateHtml = '';
            if (urlUpdatedAt) {
                const urlDate = new Date(urlUpdatedAt);
                const now = new Date();
                const hoursSinceUpdate = (now - urlDate) / (1000 * 60 * 60);
                const formattedDate = urlDate.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                
                if (hoursSinceUpdate <= 24) {
                    urlBadgeHtml = `<span class="new-link-badge inline-block ml-2 px-2 py-0.5 text-xs font-bold text-orange-800 bg-yellow-300 rounded-full">üîî YENƒ∞ Lƒ∞NK</span>`;
                }
                urlDateHtml = `<span class="ml-2 text-xs text-gray-500 font-sans">(${formattedDate})</span>`;
            }
            
            const fields = [
                { label: "Kullanƒ±cƒ± Adƒ±", key: "iptvUsername", copy: true, icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>` },
                { label: "≈ûifre", key: "iptvPassword", copy: true, icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0110 0v4"></path></svg>` },
                { label: "E-posta", key: "email", icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>` },
                { label: "Kullanƒ±cƒ± Tipi", key: "userType", highlight: 'text-orange-700 font-bold', icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>` },
                { label: "Yeni Baƒülantƒ± (URL)", key: "newUrl", copy: true, highlight: 'text-red-600 font-bold', isUrl: true, icon: `<svg class="h-5 w-5 mr-2 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5v2m-5-2h-3m-6 0H6a5 5 0 00-5 5v2m5-7h3m-6 0h4"></path><line x1="12" y1="18" x2="12" y2="21"></line><line x1="8" y1="21" x2="16" y2="21"></line></svg>` }, 
                { label: "M3U Playlist URL", key: "m3uUrl", copy: true, highlight: 'text-green-700 font-bold', isM3u: true, icon: `<svg class="h-5 w-5 mr-2 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>` },
                { label: "√úyelik Biti≈ü Tarihi", key: "expirationDate", icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>` },
                { label: "Kullanƒ±cƒ± T√ºr√º", key: "accountType", icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"></path><path d="M12 6v6l4 2"></path></svg>` },
                { label: "√úyelik S√ºresi", key: "subscriptionPeriod", icon: `<svg class="h-5 w-5 mr-2 text-orange-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v10l3 3m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` },
            ];

            userDataDisplay.className = 'space-y-1';

            let htmlContent = fields.map(field => {
                const value = field.format ? field.format(data[field.key]) : data[field.key] || 'Veri Yok';
                const extraBadge = field.isUrl ? (urlBadgeHtml + urlDateHtml) : '';
                const isM3uActive = field.isM3u && value !== 'M3U URL hen√ºz ayarlanmamƒ±≈ü' && value !== 'Veri Yok';
                const escapedValue = value.replace(/&/g, '&amp;').replace(/"/g, '&quot;');
                
                return `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-1 bg-white rounded-lg shadow-sm border border-gray-100 ${field.isUrl && urlBadgeHtml ? 'ring-2 ring-yellow-400' : ''} ${isM3uActive ? 'ring-2 ring-green-400 bg-green-50' : ''}">
                        <span class="font-medium text-gray-600 w-full sm:w-1/3 flex items-center">
                            ${field.icon}
                            ${field.label}:
                        </span>
                        <div class="flex items-center w-full sm:w-2/3 mt-1 sm:mt-0">
                            <code class="flex-grow ${isM3uActive ? 'bg-green-50' : 'bg-orange-50'} ${field.highlight || 'text-orange-800'} p-2 rounded-md text-${field.isM3u ? 'xs' : 'sm'} break-all font-mono">
                                ${value}
                                ${extraBadge}
                                ${field.key === 'expirationDate' ? `<span class="ml-2 font-sans text-xs font-bold ${calculateRemainingDays(value).class}">(${calculateRemainingDays(value).text})</span>` : ''}
                            </code>
                            ${field.copy && value !== 'Veri Yok' && value !== 'M3U URL hen√ºz ayarlanmamƒ±≈ü' ? `
                                <button class="ml-2 p-1 text-orange-600 hover:text-orange-800 focus:outline-none copy-button" data-copy-text="${escapedValue}" title="Kopyala">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            userDataDisplay.innerHTML = htmlContent;

            // ƒ∞ndirme Merkezi
            const downloadCenterHtml = `
                <div class="mt-8 p-4 sm:p-6 bg-white rounded-2xl shadow-lg border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        ƒ∞ndirme Merkezi
                    </h3>
                    <p class="text-sm text-gray-500 mb-6">Cihazƒ±nƒ±za uygun uygulamayƒ± a≈üaƒüƒ±daki butonlarƒ± kullanarak indirebilirsiniz.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- IPTV Smarters PRO APK -->
                        <a href="https://www.iptvsmarters.com/iptv-smarters-5.0.apk" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-orange-50 hover:bg-orange-100 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-lg">
                            <div class="p-3 bg-orange-500 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18a.968.968 0 01-.707-.293l-4-4a1 1 0 111.414-1.414L12 15.586l3.293-3.293a1 1 0 111.414 1.414l-4 4A.968.968 0 0112 18zm0-14a.968.968 0 01.707.293l4 4a1 1 0 11-1.414 1.414L12 6.414l-3.293 3.293a1 1 0 11-1.414-1.414l4-4A.968.968 0 0112 4z" /></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">IPTV Smarters PRO</p>
                                <p class="text-sm text-gray-500">Android APK</p>
                            </div>
                        </a>

                        <!-- Smarters Player LITE IOS -->
                        <a href="https://apps.apple.com/tr/app/smarters-player-lite/id1628995509?l=tr" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-lg">
                            <div class="p-3 bg-blue-500 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">Smarters Player LITE</p>
                                <p class="text-sm text-gray-500">iOS (iPhone/iPad)</p>
                            </div>
                        </a>

                        <!-- XCIPTV APK -->
                        <a href="https://tr.divxland.org/wp-content/themes/apps/download.php?id=8552&key=ODU1MnwxNzY4OTE2NTE4fDE5NS4xNzUuMjA2LjIyNnw2OTc0N2U5YzFkNTI4MzExMmQxYzgyMDY5MDZkOTEzMDNjYWNkMzNlODVjOTU2ZGY5MzQxOTZkZDM3ZjRhZjE2" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-green-50 hover:bg-green-100 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-lg">
                            <div class="p-3 bg-green-500 rounded-lg mr-4">
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z" /></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">XCIPTV</p>
                                <p class="text-sm text-gray-500">Android APK</p>
                            </div>
                        </a>

                        <!-- SSIPTV Playlist -->
                        <a href="https://ss-iptv.com/en/users/playlist" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-lg">
                            <div class="p-3 bg-gray-500 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">SSIPTV Playlist</p>
                                <p class="text-sm text-gray-500">Smart TV</p>
                            </div>
                        </a>

                        <!-- Downloader App -->
                        <a href="https://play.google.com/store/apps/details?id=com.esaba.downloader&pcampaignid=web_share" target="_blank" rel="noopener noreferrer" class="flex items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-lg">
                            <div class="p-3 bg-purple-500 rounded-lg mr-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">Downloader</p>
                                <p class="text-sm text-gray-500">Android / Fire TV</p>
                            </div>
                        </a>
                    </div>

                    <!-- Kurulum Rehberi Butonu -->
                    <div class="mt-6 text-center">
                        <a href="https://www.balkanpremiumtv.de/sayfa/kurulumlar" target="_blank" rel="noopener noreferrer" 
                           class="group relative inline-flex items-center justify-center px-8 py-4 overflow-hidden font-bold text-white rounded-2xl shadow-2xl bg-gradient-to-r from-orange-500 via-red-500 to-pink-500 hover:from-orange-600 hover:via-red-600 hover:to-pink-600 transition-all duration-500 transform hover:scale-105 hover:shadow-orange-500/25">
                            <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-orange-400 via-red-400 to-pink-400 opacity-0 group-hover:opacity-20 transition-opacity duration-500"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 group-hover:animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                            <span class="relative text-lg">Kurulum Rehberi & Videolar</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-3 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                        </a>
                        <p class="text-xs text-gray-400 mt-2">T√ºm cihazlar i√ßin adƒ±m adƒ±m kurulum videolarƒ±</p>
                    </div>
                </div>
            `;
            userDataDisplay.insertAdjacentHTML('beforeend', downloadCenterHtml);


            document.querySelectorAll('.copy-button').forEach(button => {
                button.onclick = (e) => {
                    const textToCopy = e.currentTarget.getAttribute('data-copy-text');
                    copyToClipboard(textToCopy);
                };
            });
        }

        /**
         * Metni panoya kopyalar
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy'); 
                showMessage('Deƒüer ba≈üarƒ±yla panoya kopyalandƒ±!', 'success');
            } catch (err) {
                console.error('Kopyalama ba≈üarƒ±sƒ±z:', err);
                showMessage('Kopyalama ba≈üarƒ±sƒ±z oldu.', 'error');
            }
            document.body.removeChild(textarea);
        }

        /**
         * Tekil URL G√ºncelleme (Yurti√ßi/Yurtdƒ±≈üƒ±)
         */
        async function updateSingleGlobalUrl(type) {
            if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim.", 'error');
                return;
            }

            const inputEl = (type === 'domestic') ? globalDomesticUrlInput : globalInternationalUrlInput;
            const buttonEl = (type === 'domestic') ? updateDomesticUrlButton : updateInternationalUrlButton;
            const urlKey = (type === 'domestic') ? 'domestic' : 'international';
            const label = (type === 'domestic') ? 'Yurti√ßi' : 'Yurtdƒ±≈üƒ±';

            const newUrl = inputEl.value.trim();

            if (!newUrl.startsWith('http')) {
                showMessage(`L√ºtfen ge√ßerli bir ${label} URL'si (http/https) giriniz.`, 'info');
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = ` ${label} G√ºncelleniyor...`;

            try {
                const globalUrlRef = doc(db, `artifacts/${appId}/public/data/settings`, 'global');
                
                await setDoc(globalUrlRef, { 
                    [urlKey]: newUrl,
                    lastUpdate: new Date().toISOString(),
                    urlUpdatedAt: new Date().toISOString()
                }, { merge: true });
                
                await fetchGlobalUrl();
                showMessage(`${label} URL ba≈üarƒ±yla g√ºncellendi!`, 'success');

            } catch (error) {
                console.error(`URL g√ºncelleme hatasƒ± (${label}):`, error);
                showMessage('URL g√ºncellenirken bir hata olu≈ütu.', 'error');
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = `${label} URL'yi G√ºncelle`;
            }
        }

        /**
         * M3U Base URL G√ºncelleme (Yurti√ßi/Yurtdƒ±≈üƒ±)
         */
        async function updateM3uBaseUrl(type) {
            if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim.", 'error');
                return;
            }

            const inputEl = (type === 'domestic') ? m3uBaseDomesticInput : m3uBaseInternationalInput;
            const buttonEl = (type === 'domestic') ? updateM3uDomesticButton : updateM3uInternationalButton;
            const urlKey = (type === 'domestic') ? 'm3uBaseDomestic' : 'm3uBaseInternational';
            const label = (type === 'domestic') ? 'Yurti√ßi' : 'Yurtdƒ±≈üƒ±';

            let newBaseUrl = inputEl.value.trim();

            if (!newBaseUrl.startsWith('http')) {
                showMessage(`L√ºtfen ge√ßerli bir ${label} M3U Base URL'si (http/https) giriniz.`, 'info');
                return;
            }

            // Sondaki / i≈üaretini kaldƒ±r
            newBaseUrl = newBaseUrl.replace(/\/+$/, '');

            buttonEl.disabled = true;
            buttonEl.textContent = `${label} M3U G√ºncelleniyor...`;

            try {
                const globalUrlRef = doc(db, `artifacts/${appId}/public/data/settings`, 'global');
                
                await setDoc(globalUrlRef, { 
                    [urlKey]: newBaseUrl,
                    lastUpdate: new Date().toISOString()
                }, { merge: true });
                
                await fetchGlobalUrl();
                showMessage(`${label} M3U Base URL ba≈üarƒ±yla g√ºncellendi!`, 'success');

            } catch (error) {
                console.error(`M3U URL g√ºncelleme hatasƒ± (${label}):`, error);
                showMessage('M3U URL g√ºncellenirken bir hata olu≈ütu.', 'error');
            } finally {
                buttonEl.disabled = false;
                buttonEl.textContent = `${label} M3U URL G√ºncelle`;
            }
        }
        
        /**
         * Tekil Kullanƒ±cƒ± Ekler/G√ºnceller
         */
        async function singleAddUser() {
            if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim. L√ºtfen Y√∂netici olarak giri≈ü yapƒ±n.", 'error');
                return;
            }

            const username = singleUsernameInput.value.trim();
            const password = singlePasswordInput.value.trim();
            const expiryDate = singleExpiryDateInput.value.trim();
            const email = singleEmailInput.value.trim(); 
            const userType = singleUserTypeSelect.value;
            const accountType = singleAccountTypeInput.value.trim();
            const subscriptionPeriod = singleSubscriptionPeriodInput.value.trim();
            const description = singleDescription.value.trim();

            if (!username || !password || !expiryDate || !userType || !accountType || !subscriptionPeriod) {
                showMessage("L√ºtfen zorunlu t√ºm alanlarƒ± doldurun (Kullanƒ±cƒ± Adƒ±, ≈ûifre, Biti≈ü Tarihi, Tip, S√ºre, Kullanƒ±m Alanƒ±).", 'error');
                return;
            }

            singleAddUserButton.disabled = true;
            singleAddUserButton.textContent = "Kullanƒ±cƒ± Kaydediliyor...";

            const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);

            try {
                const userData = {
                    iptvUsername: username,
                    iptvPassword: password,
                    expirationDate: expiryDate,
                    accountType: accountType,
                    subscriptionPeriod: subscriptionPeriod,
                    userType: userType,
                    email: email,
                    description: description,
                    lastLoginDate: new Date().toISOString(), 
                    lastUpdate: new Date().toISOString(),
                    isApproved: true
                };

                await setDoc(userRef, userData, { merge: true });
                showMessage(`'${username}' kullanƒ±cƒ±sƒ± ba≈üarƒ±yla kaydedildi/g√ºncellendi.`, 'success');

                // Formu temizle
                singleUsernameInput.value = '';
                singlePasswordInput.value = '';
                singleExpiryDateInput.value = '';
                singleEmailInput.value = '';
                singleAccountTypeInput.value = 'Normal';
                singleSubscriptionPeriodInput.value = '3 Ay';
                singleDescription.value = '';

                fetchAllUsers(true); // Listeyi ve metrikleri yenile
                
            } catch (error) {
                console.error(`Tekil kullanƒ±cƒ± ekleme hatasƒ±:`, error);
                showMessage('Kullanƒ±cƒ± eklenirken bir hata olu≈ütu.', 'error');
            } finally {
                singleAddUserButton.disabled = false;
                singleAddUserButton.textContent = "Yeni Kullanƒ±cƒ±yƒ± Kaydet";
            }
        }

        /**
         * Hƒ±zlƒ± Kullanƒ±cƒ± Ekleme ve ≈ûablon Hazƒ±rlama
         */
        async function quickAddUser() {
            if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim. L√ºtfen Y√∂netici olarak giri≈ü yapƒ±n.", 'error');
                return;
            }

            const input = quickAddCustomInput.value.trim() || quickAddInput.value.trim();
            const isTestAccount = document.getElementById('quickAddIsTestAccount').checked;
            
            if (!input) {
                showMessage("L√ºtfen kullanƒ±cƒ± bilgilerini girin veya ≈üablon se√ßin.", 'error');
                return;
            }

            // Parse input: Kullanƒ±cƒ± Adƒ±:xxx,≈ûifre:yyy,Biti≈ü Tarihi:2027-01-01,Hesap T√ºr√º:Yurtdƒ±≈üƒ±
            const parts = input.split(',');
            let username = '', password = '', expiryDate = '', userType = '';

            parts.forEach(part => {
                const [key, value] = part.split(':').map(s => s.trim());
                if (key === 'Kullanƒ±cƒ± Adƒ±') username = value;
                else if (key === '≈ûifre') password = value;
                else if (key === 'Biti≈ü Tarihi') expiryDate = value;
                else if (key === 'Hesap T√ºr√º') {
                    // Normalize: Yurtdƒ±≈üƒ±/Yurti√ßi ‚Üí YURTDISI/YURTICI
                    const normalized = value.toUpperCase().replace('≈û', 'S').replace('ƒ∞', 'I');
                    userType = normalized.includes('YURTDISI') ? 'YURTDISI' : 'YURTICI';
                }
            });

            // Test hesabƒ± ise biti≈ü tarihini +24 saat olarak set et (saat dahil)
            if (isTestAccount || input.includes('Test Hesabƒ±:Evet')) {
                const now = new Date();
                now.setHours(now.getHours() + 24);
                expiryDate = now.toISOString(); // Tam tarih+saat
            }

            if (!username || !password || !expiryDate || !userType) {
                showMessage("Bilgiler eksik veya yanlƒ±≈ü format. L√ºtfen kontrol edin.", 'error');
                return;
            }

            // URL'yi al
            const url = userType === 'YURTDISI' ? globalUrls.international : globalUrls.domestic;

            quickAddUserButton.disabled = true;
            quickAddUserButton.textContent = "Kullanƒ±cƒ± Ekleniyor...";

            const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);

            try {
                const userData = {
                    iptvUsername: username,
                    iptvPassword: password,
                    expirationDate: expiryDate,
                    accountType: isTestAccount ? 'Test' : 'Standart',
                    subscriptionPeriod: '24 Saat',
                    userType: userType,
                    email: '',
                    description: isTestAccount ? 'Test Hesabƒ± (24 Saat Ge√ßerli)' : '',
                    lastLoginDate: new Date().toISOString(), 
                    lastUpdate: new Date().toISOString(),
                    isTestAccount: isTestAccount,
                    isApproved: true
                };

                await setDoc(userRef, userData, { merge: true });
                
                // Test hesabƒ± deƒüilse abonelik logu olu≈ütur (gelir hesaplama i√ßin)
                if (!isTestAccount) {
                    try {
                        const ci = getUserCreditInfo(userData);
                        const saleTL = getUserSalePrice(userData, ci);
                        const costTL = ci.credit * EUR_PER_CREDIT * (eurTryRate || 38);
                        const logRef = collection(db, `artifacts/${appId}/public/data/subscription_logs`);
                        await addDoc(logRef, {
                            username: username,
                            userType: userType,
                            subscriptionPeriod: userData.subscriptionPeriod,
                            newExpiryDate: expiryDate,
                            credits: ci.credit,
                            saleTL: saleTL,
                            costTL: costTL,
                            profitTL: saleTL - costTL,
                            eurTryRate: eurTryRate || 38,
                            createdAt: new Date().toISOString(),
                            type: 'new'
                        });
                    } catch(logErr) {
                        console.warn('Abonelik logu olu≈üturulamadƒ±:', logErr);
                    }
                }

                const accountTypeText = isTestAccount ? '‚úÖ TEST HESABI (24 SAAT)' : 'IPTV';
                showMessage(`'${username}' kullanƒ±cƒ±sƒ± ${accountTypeText} olarak ba≈üarƒ±yla eklendi.`, 'success');

                // ≈ûablonu hazƒ±rla (WhatsApp bold: *metin*)
                const template = `üéâ *${isTestAccount ? 'TEST HESABI - 24 SAAT' : 'IPTV KULLANICI Bƒ∞LGƒ∞LERƒ∞Nƒ∞Z'}* üéâ
${isTestAccount ? 'Test hesabƒ±nƒ±z 24 saat boyunca aktif olacaktƒ±r.' : ''}
T√ºm giri≈ü bilgileriniz a≈üaƒüƒ±dadƒ±r. L√ºtfen bu bilgileri cihazlarƒ±nƒ±zƒ±n kurulum ekranlarƒ±na eksiksiz giriniz: üëá

*üîë Gƒ∞Rƒ∞≈û Bƒ∞LGƒ∞LERƒ∞Nƒ∞Zƒ∞N TAMAMI*

üÜî *Kullanƒ±cƒ± Adƒ±:* ${username}

üîí *≈ûifre:* ${password}

üåê *Portal URL (Baƒülantƒ± Adresi):* ${url}

‚è∞ *Biti≈ü Tarihi:* ${expiryDate}

*üí° NOT:*

Bu bilgileri yalnƒ±zca siz kullanabilirsiniz. üö´

Kurulum desteƒüi i√ßin bize ula≈üabilirsiniz. üì≤

*Kurulum bilgileri ve videolarƒ±:* www.balkanpremiumtv.de

*M√º≈üteri Merkezi:* Kullanƒ±cƒ± adƒ±nƒ±z ile giri≈ü yapabilirsiniz.
https://balkantvpanel.web.app

Keyifli seyirler! üì∫`;

                quickAddTemplate.value = template;
                quickAddResult.classList.remove('hidden');

                // Test hesabƒ± ise dashboard'da g√∂ster
                if (isTestAccount) {
                    // Test hesaplarƒ± listesini yenile
                    fetchTestAccounts();
                }

                fetchAllUsers(true); // Listeyi yenile
                
            } catch (error) {
                console.error(`Hƒ±zlƒ± kullanƒ±cƒ± ekleme hatasƒ±:`, error);
                showMessage('Hƒ±zlƒ± kullanƒ±cƒ± eklenirken bir hata olu≈ütu.', 'error');
            } finally {
                quickAddUserButton.disabled = false;
                quickAddUserButton.textContent = "Kullanƒ±cƒ±yƒ± Ekle ve ≈ûablonu Hazƒ±rla";
            }
        }

        /**
         * D√ºzenleme sekmelerini deƒüi≈ütirir
         */
        window.switchEditTab = function(tab) {
            document.querySelectorAll('.edit-tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.edit-tab').forEach(b => {
                b.classList.remove('bg-blue-600', 'bg-green-600', 'text-white');
                b.classList.add('border');
            });
            if (tab === 'info') {
                document.getElementById('editInfoContent').classList.remove('hidden');
                const btn = document.getElementById('editTabInfo');
                btn.classList.add('bg-blue-600', 'text-white');
                btn.classList.remove('border', 'text-blue-600');
            } else {
                document.getElementById('editExtendContent').classList.remove('hidden');
                const btn = document.getElementById('editTabExtend');
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('border', 'text-green-600');
                updateExtendPreview();
            }
        };

        /**
         * Uzatma √∂nizleme hesaplamasƒ±nƒ± g√ºnceller
         */
        function updateExtendPreview() {
            const period = editSubscriptionPeriodInput?.value || '12 Ay';
            const userType = editUserTypeSelect?.value || 'YURTICI';
            const preview = document.getElementById('editExtendPreview');
            const content = document.getElementById('editExtendPreviewContent');
            if (!preview || !content) return;

            const ci = CREDIT_MAP[period] || CREDIT_MAP['12 Ay'];
            const costEUR = ci.credit * EUR_PER_CREDIT;
            const costTL = costEUR * (eurTryRate || 38);
            let saleTL = 0;
            if (userType === 'YURTDISI') {
                saleTL = (priceList?.international?.single12M || 50) * (eurTryRate || 38);
            } else if (ci.plKey) {
                saleTL = priceList?.domestic?.[ci.plKey] || 0;
            }
            const profit = saleTL - costTL;
            const profitCls = profit >= 0 ? 'text-green-600' : 'text-red-600';

            content.innerHTML = `
                <div class="grid grid-cols-3 gap-2 text-center">
                    <div><p class="text-xs text-gray-500">Kredi</p><p class="font-bold text-purple-600">${ci.credit}</p></div>
                    <div><p class="text-xs text-gray-500">Maliyet</p><p class="font-bold text-red-500">${costTL.toFixed(0)} ‚Ç∫</p></div>
                    <div><p class="text-xs text-gray-500">Kar</p><p class="font-bold ${profitCls}">${profit >= 0 ? '+' : ''}${profit.toFixed(0)} ‚Ç∫</p></div>
                </div>`;
            preview.classList.remove('hidden');
        }

        /**
         * Hesap Bilgisi G√ºncelle (≈üifre, e-posta, tip - gelir hesaplamayƒ± ETKƒ∞LEMEZ)
         */
        async function updateUserInfo() {
            const username = editUserSelect.value;
            if (!username) {
                showMessage("L√ºtfen d√ºzenlemek i√ßin bir kullanƒ±cƒ± se√ßin.", 'info');
                return;
            }

            const updatedData = {
                iptvPassword: editPasswordInput.value.trim(),
                email: editEmailInput.value.trim(),
                userType: editUserTypeSelect.value,
                accountType: editAccountTypeInput.value.trim(),
                lastUpdate: new Date().toISOString()
            };

            if (!updatedData.iptvPassword) {
                showMessage("≈ûifre alanƒ± bo≈ü bƒ±rakƒ±lamaz.", 'error');
                return;
            }

            updateUserInfoButton.disabled = true;
            updateUserInfoButton.textContent = "G√ºncelleniyor...";

            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                await setDoc(userRef, updatedData, { merge: true });
                showMessage(`'${username}' hesap bilgileri g√ºncellendi.`, 'success');
                await fetchAllUsers(true);
                calculateMetrics(allUsersData);
            } catch (error) {
                console.error(`Hesap bilgisi g√ºncelleme hatasƒ±:`, error);
                showMessage('Kullanƒ±cƒ± bilgileri g√ºncellenirken bir hata olu≈ütu.', 'error');
            } finally {
                updateUserInfoButton.disabled = false;
                updateUserInfoButton.textContent = "Hesap Bilgisini G√ºncelle";
            }
        }

        /**
         * Hesap S√ºresi Uzat (Firestore'a subscription_logs kaydƒ± olu≈üturur = GELƒ∞R HESAPLAMASI)
         */
        async function extendUserSubscription() {
            const username = editUserSelect.value;
            if (!username) {
                showMessage("L√ºtfen d√ºzenlemek i√ßin bir kullanƒ±cƒ± se√ßin.", 'info');
                return;
            }

            const newExpiry = editExpiryDateInput.value.trim();
            const period = editSubscriptionPeriodInput.value;
            const userType = editUserTypeSelect.value;

            if (!newExpiry) {
                showMessage("Biti≈ü tarihi bo≈ü bƒ±rakƒ±lamaz.", 'error');
                return;
            }

            extendUserButton.disabled = true;
            extendUserButton.textContent = "Kaydediliyor...";

            try {
                // 1. Kullanƒ±cƒ±yƒ± g√ºncelle
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                await setDoc(userRef, {
                    expirationDate: newExpiry,
                    subscriptionPeriod: period,
                    lastUpdate: new Date().toISOString()
                }, { merge: true });

                // 2. Abonelik logunu kaydet (GELƒ∞R HESAPLAMASI ƒ∞√áƒ∞N)
                const ci = getUserCreditInfo({ subscriptionPeriod: period, userType: userType, accountType: editAccountTypeInput?.value || '' });
                const saleTL = getUserSalePrice({ subscriptionPeriod: period, userType: userType, accountType: editAccountTypeInput?.value || '' }, ci);
                const costTL = ci.credit * EUR_PER_CREDIT * (eurTryRate || 38);

                const logRef = collection(db, `artifacts/${appId}/public/data/subscription_logs`);
                await addDoc(logRef, {
                    username: username,
                    userType: userType,
                    subscriptionPeriod: period,
                    newExpiryDate: newExpiry,
                    credits: ci.credit,
                    saleTL: saleTL,
                    costTL: costTL,
                    profitTL: saleTL - costTL,
                    eurTryRate: eurTryRate || 38,
                    createdAt: new Date().toISOString(),
                    type: 'extension' // 'new' veya 'extension'
                });

                // Uzatma talebinden geldiyse talebi sil
                const fromRenewalRequest = !!currentRenewalRequestIdForUpdate;
                if (fromRenewalRequest) {
                    const requestRef = doc(db, `artifacts/${appId}/public/data/renewal_requests`, currentRenewalRequestIdForUpdate);
                    await deleteDoc(requestRef);
                    showMessage('√úyelik uzatma talebi listeden kaldƒ±rƒ±ldƒ±.', 'success');
                    currentRenewalRequestIdForUpdate = null;
                }

                showMessage(`'${username}' hesap s√ºresi uzatƒ±ldƒ± ve gelir kaydƒ± olu≈üturuldu! ‚úÖ`, 'success');
                await fetchAllUsers(true);
                calculateMetrics(allUsersData);
                // Gelir tablosunu da g√ºncelle
                try { await calculateRevenue(); } catch(e) { console.warn('Gelir g√ºncelleme:', e); }

                if (fromRenewalRequest) {
                    showAdminView('dashboard');
                }

            } catch (error) {
                console.error(`S√ºre uzatma hatasƒ±:`, error);
                showMessage('Abonelik uzatƒ±lƒ±rken bir hata olu≈ütu.', 'error');
            } finally {
                extendUserButton.disabled = false;
                extendUserButton.textContent = "Hesap S√ºresini Uzat & Kaydet";
            }
        }

        // Eski updateSelectedUser fonk. uyumluluk
        async function updateSelectedUser() {
            // Eski koddan √ßaƒürƒ±lƒ±rsa s√ºre uzat sekmesine y√∂nlendir
            await extendUserSubscription();
        }

        /**
         * Se√ßili Kullanƒ±cƒ±yƒ± Siler (YENƒ∞)
         */
        async function deleteSelectedUser() {
            const username = editUserSelect.value;
            if (!username) {
                showMessage("L√ºtfen silmek i√ßin bir kullanƒ±cƒ± se√ßin.", 'info');
                return;
            }

            if (!confirm(`'${username}' kullanƒ±cƒ±sƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                return;
            }

            deleteUserButton.disabled = true;
            deleteUserButton.textContent = "Siliniyor...";

            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                await deleteDoc(userRef);

                showMessage(`'${username}' kullanƒ±cƒ±sƒ± ba≈üarƒ±yla silindi.`, 'success');
                
                editUserForm.classList.add('hidden'); // Formu gizle
                await fetchAllUsers(true); // Listeyi, metrikleri ve d√ºzenleme formunu yenile

            } catch (error) {
                console.error(`Kullanƒ±cƒ± silme hatasƒ±:`, error);
                showMessage('Kullanƒ±cƒ± silinirken bir hata olu≈ütu.', 'error');
            } finally {
                deleteUserButton.disabled = false;
                deleteUserButton.textContent = "Kullanƒ±cƒ±yƒ± Sil";
            }
        }

        /**
         * Kullanƒ±cƒ±yƒ± doƒürudan listeden siler (YENƒ∞)
         */
        async function deleteUserFromList(username) {
            if (!username) {
                showMessage("Silinecek kullanƒ±cƒ± adƒ± belirtilmedi.", 'error');
                return;
            }

            if (!confirm(`'${username}' kullanƒ±cƒ±sƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.`)) {
                return;
            }

            // Butonlarƒ± ge√ßici olarak devre dƒ±≈üƒ± bƒ±rak
            document.querySelectorAll('.list-delete-button, .list-edit-button, .list-extend-button').forEach(b => b.disabled = true);

            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                await deleteDoc(userRef);

                showMessage(`'${username}' kullanƒ±cƒ±sƒ± ba≈üarƒ±yla silindi.`, 'success');
                await fetchAllUsers(true); // Listeyi, metrikleri ve d√ºzenleme formunu yenile

            } catch (error) {
                console.error(`Kullanƒ±cƒ± silme hatasƒ±:`, error);
                showMessage('Kullanƒ±cƒ± silinirken bir hata olu≈ütu.', 'error');
                document.querySelectorAll('.list-delete-button, .list-edit-button, .list-extend-button').forEach(b => b.disabled = false);
            }
        }

        /**
         * Kullanƒ±cƒ±larƒ± Excel'e aktarƒ±r (CSV formatƒ±nda)
         */
        function exportToExcel() {
            if (allUsersData.length === 0) {
                showMessage("Aktarƒ±lacak kullanƒ±cƒ± bulunamadƒ±.", 'info');
                return;
            }

            // CSV ba≈ülƒ±klarƒ±
            const headers = ['Kullanƒ±cƒ± Adƒ±', '≈ûifre', 'Biti≈ü Tarihi', 'Hesap Tipi', '√úyelik S√ºresi', 'Kullanƒ±m Alanƒ±', 'E-posta', 'Son Giri≈ü'];
            
            // CSV verilerini olu≈ütur
            const csvData = allUsersData.map(user => [
                user.iptvUsername || '',
                user.iptvPassword || '',
                user.expirationDate || '',
                user.accountType || '',
                user.subscriptionPeriod || '',
                user.userType || '',
                user.email || '',
                user.lastLoginDate || ''
            ]);

            // CSV string olu≈ütur
            const csvContent = [headers, ...csvData]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            // Download link olu≈ütur
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kullanicilar_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage(`${allUsersData.length} kullanƒ±cƒ± ba≈üarƒ±yla Excel'e aktarƒ±ldƒ±.`, 'success');
        }

        /**
         * Toplu Mesaj G√∂nderir (YENƒ∞)
         */
        async function sendBulkMessage() {
            const messageContent = bulkMessageInput.value.trim();
            if (!messageContent) {
                showMessage("L√ºtfen g√∂nderilecek bir mesaj yazƒ±n.", 'info');
                return;
            }

            sendBulkMessageButton.disabled = true;
            sendBulkMessageButton.textContent = "G√∂nderiliyor...";

            try {
                const messageData = {
                    content: messageContent,
                    timestamp: new Date().toISOString(),
                    sender: 'admin'
                };

                const messagesCollection = collection(db, `artifacts/${appId}/public/data/messages`);
                await addDoc(messagesCollection, messageData);

                showMessage("Mesaj t√ºm kullanƒ±cƒ±lara ba≈üarƒ±yla g√∂nderildi.", 'success');
                bulkMessageInput.value = '';

                // Ar≈üivi yenile
                if (adminMessagesView.style.display !== 'none') {
                    fetchAdminMessages();
                }

            } catch (error) {
                console.error("Toplu mesaj g√∂nderme hatasƒ±:", error);
                showMessage('Mesaj g√∂nderilirken bir hata olu≈ütu.', 'error');
            } finally {
                sendBulkMessageButton.disabled = false;
                sendBulkMessageButton.textContent = "Mesajƒ± T√ºm Kullanƒ±cƒ±lara G√∂nder";
            }
        }

        /**
         * Toplu Kullanƒ±cƒ±larƒ± ekler (Excel/CSV Sim√ºlasyonu)
         */
        async function bulkAddUsers() {
             if (!isAdminUser) {
                showMessage("Yetkisiz eri≈üim. L√ºtfen Y√∂netici olarak giri≈ü yapƒ±n.", 'error');
                return;
            }
            
            const rawData = bulkUserInput.value.trim();
            if (!rawData) {
                showMessage("L√ºtfen toplu kullanƒ±cƒ± verilerini yapƒ±≈ütƒ±rƒ±n.", 'info');
                return;
            }
            
            bulkAddUsersButton.disabled = true;
            bulkAddUsersButton.textContent = "Kullanƒ±cƒ±lar Ekleniyor...";

            const lines = rawData.split('\n').filter(line => line.trim() !== '');
            let successCount = 0;
            let errorCount = 0;
            const usersCollection = `artifacts/${appId}/public/data/iptv_users`;
            const defaultLastLogin = new Date().toISOString();

            
            for (const line of lines) {
                const parts = line.split(',').map(p => p.trim());

                if (parts.length < 6) { 
                    console.warn(`Hata: Satƒ±r formatƒ± yanlƒ±≈ü (en az 6 alan gerekli): ${line}`);
                    errorCount++;
                    continue;
                }

                const [username, password, expirationDate, accountType, subscriptionPeriod, userType] = parts;
                const validatedUserType = (userType.toUpperCase() === 'YURTDISI') ? 'YURTDISI' : 'YURTICI';
                const email = parts.length > 6 ? parts[6] : ''; // Opsiyonel 7. alan

                if (!username || !password) {
                    console.warn(`Hata: Kullanƒ±cƒ± adƒ± veya ≈üifre bo≈ü: ${line}`);
                    errorCount++;
                    continue;
                }
                
                const userRef = doc(db, usersCollection, username);
                
                try {
                    const userData = {
                        iptvUsername: username,
                        iptvPassword: password,
                        expirationDate: expirationDate,
                        accountType: accountType,
                        subscriptionPeriod: subscriptionPeriod,
                        userType: validatedUserType,
                        email: email, 
                        lastLoginDate: defaultLastLogin, 
                        lastUpdate: new Date().toISOString()
                    };

                    await setDoc(userRef, userData, { merge: true });
                    successCount++;
                } catch (error) {
                    console.error(`Kullanƒ±cƒ± '${username}' eklenirken hata:`, error);
                    errorCount++;
                }
            }
            
            bulkAddUsersButton.disabled = false;
            bulkAddUsersButton.textContent = "Toplu Kullanƒ±cƒ±larƒ± Ekle";

            if (successCount > 0) {
                showMessage(`${successCount} kullanƒ±cƒ± ba≈üarƒ±yla eklendi/g√ºncellendi. Hata: ${errorCount}`, 'success');
                bulkUserInput.value = '';
                fetchAllUsers(true); // Listeyi ve metrikleri yenile
            } else if (errorCount > 0) {
                showMessage(`T√ºm kullanƒ±cƒ±lar eklenirken hata olu≈ütu. Hata sayƒ±sƒ±: ${errorCount}`, 'error');
            } else {
                showMessage('Hi√ßbir veri i≈ülenmedi.', 'info');
            }
        }

        /**
         * T√ºm kullanƒ±cƒ±larƒ± Firestore'dan √ßeker ve Admin UI'da listeler.
         * @param {boolean} updateMetrics - Metrikleri de g√ºncellemek i√ßin true
         */
        /**
         * Dashboard Metriklerini Hesaplar
         */
        async function calculateMetrics(users) {
            const now = new Date();
            const expiringSoonDate = new Date();
            expiringSoonDate.setDate(now.getDate() + 7); // 7 g√ºn sonrasƒ±
            
            let activeUsers = 0;
            let expiringSoon = 0;
            let expiredUsers = 0;

            users.forEach(user => {
                if (!user.expirationDate) return; // Tarih yoksa atla
                const expiry = new Date(user.expirationDate);
                
                if (isNaN(expiry.getTime())) return; // Ge√ßersiz tarih atla
                
                if (expiry > now) {
                    activeUsers++;
                } else {
                    expiredUsers++;
                }

                // Hesabƒ±n bitmesine 7 g√ºn veya daha az kalan kullanƒ±cƒ±lar
                if (expiry > now && expiry <= expiringSoonDate) {
                    expiringSoon++;
                }
            });

            metricActiveUsersEl.textContent = activeUsers;
            metricExpiringSoonEl.textContent = expiringSoon;
            metricExpiredEl.textContent = expiredUsers;
        }

        /**
         * T√ºm kullanƒ±cƒ±larƒ± Firestore'dan √ßeker ve Admin UI'da listeler.
         * @param {boolean} updateMetrics - Metrikleri de g√ºncellemek i√ßin true
         */
        async function fetchAllUsers(updateMetrics = false) {
             if (!isAdminUser && !updateMetrics) return;

            showAdminListSkeleton();
            listStatusEl.textContent = "Kullanƒ±cƒ±lar y√ºkleniyor...";
            userListContent.innerHTML = '';
            userCountEl.textContent = '0';
            refreshUserListButton.disabled = true;
            paginationControlsEl.innerHTML = ''; // Sayfalama kontrol√ºn√º sƒ±fƒ±rla
            allUsersData = [];

            try {
                const usersCollectionRef = collection(db, `artifacts/${appId}/public/data/iptv_users`);
                const querySnapshot = await getDocs(usersCollectionRef);

                querySnapshot.forEach((doc) => {
                    const userData = doc.data();
                    // Aynƒ± username varsa ekleme (duplikasyon √∂nleme)
                    if (!allUsersData.some(u => u.iptvUsername === userData.iptvUsername)) {
                        allUsersData.push(userData);
                    }
                });

                userCountEl.textContent = allUsersData.length;

                // --- Sayfalama sƒ±fƒ±rlama ---
                currentPage = 1; 

                if (allUsersData.length === 0) {
                    listStatusEl.textContent = "Sistemde kayƒ±tlƒ± kullanƒ±cƒ± bulunmamaktadƒ±r.";
                    userListContent.appendChild(listStatusEl);
                } else {
                    listStatusEl.classList.add('hidden');
                    displayFilteredUsers(allUsersData, currentFilter);
                }
                
                if (updateMetrics) {
                    calculateMetrics(allUsersData);
                    populateEditUserDropdown(); // D√ºzenleme dropdown'ƒ±nƒ± doldur
                } else {
                    populateEditUserDropdown(); // Sadece dropdown'ƒ± doldur
                }


            } catch (error) {
                console.error("Kullanƒ±cƒ± listesi √ßekme hatasƒ±:", error);
                listStatusEl.textContent = `Liste y√ºklenirken bir hata olu≈ütu: ${error.message}`;
                listStatusEl.classList.remove('hidden');
                userListContent.appendChild(listStatusEl);
            } finally {
                hideAdminListSkeleton();
                refreshUserListButton.disabled = false;
            }
        }

        /**
         * Test Hesaplarƒ±nƒ± Y√ºkler ve G√∂sterir (YENƒ∞)
         */
        async function fetchTestAccounts() {
            const testAccountsList = document.getElementById('testAccountsList');
            const testAccountCount = document.getElementById('testAccountCount');
            const testAccountStatus = document.getElementById('testAccountStatus');
            const refreshTestButton = document.getElementById('refreshTestAccountsButton');
            
            if (!testAccountsList) return; // Element yoksa √ßƒ±k
            
            testAccountStatus.textContent = 'Test hesaplarƒ± y√ºkleniyor...';
            refreshTestButton.disabled = true;

            try {
                const testAccounts = allUsersData.filter(user => user.isTestAccount === true);
                const now = new Date();
                const activeTestAccounts = testAccounts.filter(user => {
                    const expiry = new Date(user.expirationDate);
                    return expiry > now;
                });

                testAccountCount.textContent = activeTestAccounts.length;

                if (activeTestAccounts.length === 0) {
                    testAccountStatus.textContent = 'Hen√ºz aktif test hesabƒ± bulunmuyor.';
                    testAccountsList.innerHTML = '';
                    testAccountsList.appendChild(testAccountStatus);
                } else {
                    testAccountsList.innerHTML = '';
                    activeTestAccounts.forEach(user => {
                        const expiryTime = new Date(user.expirationDate);
                        const diffMs = expiryTime - now;
                        const remainingHours = Math.floor(diffMs / (1000 * 60 * 60));
                        const remainingMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        const timeText = remainingHours > 0 ? `${remainingHours} saat ${remainingMins} dk` : `${remainingMins} dakika`;
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'p-3 border rounded-lg bg-blue-50 flex justify-between items-center';
                        cardDiv.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-bold text-sm text-gray-700">üë§ ${escapeHtml(user.iptvUsername)}</p>
                                <p class="text-xs text-gray-600">Tip: ${user.userType === 'YURTDISI' ? 'Yurtdƒ±≈üƒ±' : 'Yurti√ßi'}</p>
                                <p class="text-xs text-red-600 font-semibold">‚è∞ ${timeText} kaldƒ±</p>
                            </div>
                            <button class="convert-test-btn py-1 px-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs transition-colors" data-username="${escapeHtml(user.iptvUsername)}">
                                Normal'e √áevir
                            </button>
                        `;
                        testAccountsList.appendChild(cardDiv);
                    });

                    // Event listener ile baƒüla (module scope'dan eri≈üim i√ßin)
                    testAccountsList.querySelectorAll('.convert-test-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            convertTestToNormal(btn.dataset.username);
                        });
                    });
                }
            } catch (error) {
                console.error("Test hesaplarƒ± y√ºkleme hatasƒ±:", error);
                testAccountStatus.textContent = `Hata: ${error.message}`;
            } finally {
                refreshTestButton.disabled = false;
            }
        }

        /**
         * Test Hesabƒ±nƒ± Normal Hesaba √áevirir (D√úZELTƒ∞LMƒ∞≈û)
         */
        async function convertTestToNormal(username) {
            // Modal olu≈ütur
            const existingModal = document.getElementById('convertTestModal');
            if (existingModal) existingModal.remove();

            const user = allUsersData.find(u => u.iptvUsername === username);
            if (!user) { showMessage('Kullanƒ±cƒ± bulunamadƒ±.', 'error'); return; }

            const modal = document.createElement('div');
            modal.id = 'convertTestModal';
            modal.className = 'modal-overlay flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 space-y-4">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Test Hesabƒ±nƒ± Normal'e √áevir
                    </h3>
                    <p class="text-sm text-gray-600">Kullanƒ±cƒ±: <strong>${username}</strong></p>
                    
                    <label class="block text-sm font-medium text-gray-700">√úyelik S√ºresi:</label>
                    <select id="convertDuration" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <option value="3 Ay">3 Ay</option>
                        <option value="6 Ay">6 Ay</option>
                        <option value="12 Ay" selected>12 Ay</option>
                        <option value="15 Ay">15 Ay</option>
                    </select>

                    <label class="block text-sm font-medium text-gray-700">Hesap T√ºr√º:</label>
                    <select id="convertAccountType" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <option value="Standart" selected>Standart</option>
                        <option value="Premium">Premium</option>
                    </select>

                    <label class="block text-sm font-medium text-gray-700">Kullanƒ±m Alanƒ±:</label>
                    <select id="convertUserType" class="w-full px-3 py-2 border rounded-lg text-sm">
                        <option value="YURTICI" ${user.userType === 'YURTICI' ? 'selected' : ''}>Yurti√ßi</option>
                        <option value="YURTDISI" ${user.userType === 'YURTDISI' ? 'selected' : ''}>Yurtdƒ±≈üƒ±</option>
                    </select>

                    <label class="block text-sm font-medium text-gray-700">Biti≈ü Tarihi:</label>
                    <input type="date" id="convertExpiryDate" class="w-full px-3 py-2 border rounded-lg text-sm" value="${new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString().split('T')[0]}">

                    <div class="flex space-x-3 pt-2">
                        <button id="confirmConvertBtn" class="flex-1 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold transition-colors">
                            D√∂n√º≈üt√ºr
                        </button>
                        <button id="cancelConvertBtn" class="flex-1 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm font-bold transition-colors">
                            ƒ∞ptal
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Flatpickr uygula
            flatpickr('#convertExpiryDate', { dateFormat: 'Y-m-d', allowInput: true, locale: 'tr' });

            document.getElementById('cancelConvertBtn').onclick = () => modal.remove();
            document.getElementById('confirmConvertBtn').onclick = async () => {
                const duration = document.getElementById('convertDuration').value;
                const accountType = document.getElementById('convertAccountType').value;
                const userType = document.getElementById('convertUserType').value;
                const expiryDate = document.getElementById('convertExpiryDate').value;

                if (!expiryDate) { showMessage('Biti≈ü tarihi se√ßiniz.', 'error'); return; }

                document.getElementById('confirmConvertBtn').disabled = true;
                document.getElementById('confirmConvertBtn').textContent = 'D√∂n√º≈üt√ºr√ºl√ºyor...';

                try {
                    const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, username);
                    await setDoc(userRef, {
                        accountType: accountType,
                        subscriptionPeriod: duration,
                        userType: userType,
                        expirationDate: expiryDate,
                        isTestAccount: false,
                        isApproved: true,
                        description: 'Test hesabƒ±ndan normal hesaba d√∂n√º≈üt√ºr√ºlm√º≈ü',
                        lastUpdate: new Date().toISOString()
                    }, { merge: true });

                    showMessage(`'${username}' ba≈üarƒ±yla normal hesaba √ßevrildi. S√ºre: ${duration}, Biti≈ü: ${expiryDate}`, 'success');
                    modal.remove();
                    fetchAllUsers(true);
                    fetchTestAccounts();
                } catch (error) {
                    console.error('Test hesabƒ± d√∂n√º≈üt√ºrme hatasƒ±:', error);
                    showMessage('Hesap d√∂n√º≈üt√ºr√ºl√ºrken bir hata olu≈ütu.', 'error');
                    document.getElementById('confirmConvertBtn').disabled = false;
                    document.getElementById('confirmConvertBtn').textContent = 'D√∂n√º≈üt√ºr';
                }
            };
        }

        /**
         * Kullanƒ±cƒ± D√ºzenleme Dropdown'ƒ±nƒ± Doldurur (YENƒ∞)
         */
        function populateEditUserDropdown() {
            editUserSelect.innerHTML = '<option value="">-- Kullanƒ±cƒ± Se√ßin --</option>';
            allUsersData
                .sort((a, b) => a.iptvUsername.localeCompare(b.iptvUsername))
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.iptvUsername;
                    option.textContent = user.iptvUsername;
                    editUserSelect.appendChild(option);
                });
        }

        /**
         * D√ºzenleme i√ßin kullanƒ±cƒ± se√ßildiƒüinde formu doldurur (YENƒ∞)
         */
        function handleEditUserSelect() {
            const selectedUsername = editUserSelect.value;
            if (!selectedUsername) {
                editUserForm.classList.add('hidden');
                return;
            }

            const user = allUsersData.find(u => u.iptvUsername === selectedUsername);
            if (user) {
                editPasswordInput.value = user.iptvPassword || '';
                editExpiryDateInput.value = user.expirationDate || '';
                editEmailInput.value = user.email || '';
                editAccountTypeInput.value = user.accountType || '';
                editSubscriptionPeriodInput.value = user.subscriptionPeriod || '12 Ay';
                
                // User Type select'ini doldur ve se√ß
                editUserTypeSelect.innerHTML = '<option value="YURTICI">Yurti√ßi</option><option value="YURTDISI">Yurtdƒ±≈üƒ±</option>';
                editUserTypeSelect.value = user.userType || 'YURTICI';

                // Uzatma √∂nizleme g√∂ster
                updateExtendPreview();

                editUserForm.classList.remove('hidden');
            }
        }
        
        /**
         * Kullanƒ±cƒ±larƒ± filtreler ve listeyi yeniden √ßizer (Sayfalama Eklendi)
         */
        function displayFilteredUsers(users, filterType = 'all') {
            let filteredUsers = users;
            
            if (filterType === 'active') {
                filteredUsers = users.filter(user => new Date(user.expirationDate) > new Date());
            } else if (filterType === 'expired') {
                filteredUsers = users.filter(user => new Date(user.expirationDate) <= new Date());
            } else if (filterType === 'expiring') {
                const expiringSoonDate = new Date();
                expiringSoonDate.setDate(new Date().getDate() + 7);
                filteredUsers = users.filter(user => {
                    const expiry = new Date(user.expirationDate);
                    return expiry > new Date() && expiry <= expiringSoonDate;
                });
            } else {
                // all or search
                const searchTerm = userSearchInput.value.toLowerCase();
                filteredUsers = users.filter(user => 
                    user.iptvUsername.toLowerCase().includes(searchTerm)
                );
            }
            
            // Sayfalama Hesaplamalarƒ±
            totalPages = Math.ceil(filteredUsers.length / USERS_PER_PAGE);
            
            // Eƒüer arama sonucu yoksa veya sayfa numarasƒ± √ßok b√ºy√ºkse, sƒ±fƒ±rla
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                 currentPage = 1;
            }

            const startIndex = (currentPage - 1) * USERS_PER_PAGE;
            const endIndex = startIndex + USERS_PER_PAGE;
            const usersToDisplay = filteredUsers.slice(startIndex, endIndex);

            if (usersToDisplay.length === 0 && filteredUsers.length > 0) {
                // Eƒüer son sayfada kullanƒ±cƒ± yoksa (√∂rneƒüin silinme sonrasƒ±), bir √∂nceki sayfaya git
                currentPage = Math.max(1, currentPage - 1);
                displayFilteredUsers(users); // Yeniden √ßaƒüƒ±r
                return;
            }

            if (filteredUsers.length === 0) {
                userListContent.innerHTML = `<p class="text-center p-4 text-gray-500">Aranan kritere uygun kullanƒ±cƒ± bulunamadƒ±.</p>`;
                renderPaginationControls(0, 0); // Sayfalama kontrol√ºn√º sƒ±fƒ±rla
                return;
            }

            // Liste i√ßeriƒüini olu≈ütur
            const listHtml = usersToDisplay.map(user => {
                const isExpired = new Date(user.expirationDate) < new Date();
                const statusClass = isExpired ? 'bg-red-500' : 'bg-green-500';
                const statusText = isExpired ? 'DOLDU' : 'AKTƒ∞F';
                const typeClass = user.userType === 'YURTDISI' ? 'text-orange-700 bg-orange-200' : 'text-blue-700 bg-blue-200';
                const remainingDaysInfo = calculateRemainingDays(user.expirationDate);
                
                // Test hesabƒ± i√ßin badge ekle
                const testAccountBadge = user.isTestAccount ? '<span class="ml-2 text-xs bg-purple-600 text-white px-2 py-0.5 rounded-full font-bold">üß™ TEST</span>' : '';

                // Mobil i√ßin kart yapƒ±sƒ±, masa√ºst√º i√ßin satƒ±r yapƒ±sƒ±
                return `
                    <div class="user-row p-3 border-b ${user.isTestAccount ? 'bg-purple-50 border-purple-200' : 'border-gray-200'} text-sm transition-colors duration-150">
                        <!-- Mobil Kart G√∂r√ºn√ºm√º -->
                        <div class="sm:hidden space-y-2">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-gray-800 text-base">${escapeHtml(user.iptvUsername)} ${testAccountBadge}</p>
                                    <p class="text-xs text-gray-500">≈ûifre: ${escapeHtml(user.iptvPassword)}</p>
                                </div>
                                <span class="text-xs font-bold ${statusClass} text-white px-2.5 py-1 rounded-full">${statusText}</span>
                            </div>
                            <div class="flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2">
                                <div class="flex items-center gap-2">
                                    <span class="${typeClass} font-medium text-xs px-2 py-0.5 rounded">${escapeHtml(user.userType || 'Bƒ∞Lƒ∞NMƒ∞YOR')}</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-gray-700 font-medium text-xs">${escapeHtml(user.expirationDate)}</span>
                                    <span class="block text-xs ${remainingDaysInfo.class}">${remainingDaysInfo.text}</span>
                                </div>
                            </div>
                            <div class="flex justify-end items-center gap-2 pt-1 border-t border-gray-100">
                                <button title="Kopyala" data-username="${escapeHtml(user.iptvUsername)}" data-password="${escapeHtml(user.iptvPassword)}" data-expiry="${escapeHtml(user.expirationDate)}" data-usertype="${escapeHtml(user.userType)}" class="list-copy-button p-1.5 text-green-600 hover:bg-green-100 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
                                </button>
                                <button title="D√ºzenle" data-username="${escapeHtml(user.iptvUsername)}" class="list-edit-button p-1.5 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button title="S√ºre Uzat" data-username="${escapeHtml(user.iptvUsername)}" class="list-extend-button p-1.5 text-green-600 hover:bg-green-100 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </button>
                                <button title="Sil" data-username="${escapeHtml(user.iptvUsername)}" class="list-delete-button p-1.5 text-red-600 hover:bg-red-100 rounded-lg transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                        <!-- Masa√ºst√º Satƒ±r G√∂r√ºn√ºm√º -->
                        <div class="hidden sm:flex items-center justify-between">
                            <div class="w-1/4 truncate">
                                <p class="font-semibold">${escapeHtml(user.iptvUsername)} ${testAccountBadge}</p>
                                <p class="text-xs text-gray-500">≈ûifre: ${escapeHtml(user.iptvPassword)}</p>
                            </div>
                            <span class="w-1/5 text-center"><span class="${typeClass} font-medium px-2 py-0.5 rounded">${escapeHtml(user.userType || 'Bƒ∞Lƒ∞NMƒ∞YOR')}</span></span>
                            <span class="w-1/4 text-center text-gray-600">${escapeHtml(user.expirationDate)} <span class="text-xs ${remainingDaysInfo.class}">(${remainingDaysInfo.text})</span></span>
                            <div class="w-1/6 text-center">
                                <span class="text-xs font-bold ${statusClass} text-white px-2 py-0.5 rounded">${statusText}</span>
                            </div>
                            <div class="w-1/6 text-right flex justify-end items-center space-x-2">
                                <button title="Kopyala" data-username="${escapeHtml(user.iptvUsername)}" data-password="${escapeHtml(user.iptvPassword)}" data-expiry="${escapeHtml(user.expirationDate)}" data-usertype="${escapeHtml(user.userType)}" class="list-copy-button p-1 text-green-600 hover:bg-green-100 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path></svg>
                                </button>
                                <button title="D√ºzenle" data-username="${escapeHtml(user.iptvUsername)}" class="list-edit-button p-1 text-blue-600 hover:bg-blue-100 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button title="S√ºre Uzat" data-username="${escapeHtml(user.iptvUsername)}" class="list-extend-button p-1 text-green-600 hover:bg-green-100 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                </button>
                                <button title="Sil" data-username="${escapeHtml(user.iptvUsername)}" class="list-delete-button p-1 text-red-600 hover:bg-red-100 rounded-full transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            userListContent.innerHTML = listHtml;
            renderPaginationControls(currentPage, totalPages);

            // Butonlara olay dinleyicileri ekle
            document.querySelectorAll('.list-edit-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    showAdminView('managementTools');
                    switchMgmtTab('users');
                    const detailsElement = editUserSelect.closest('details');
                    if (detailsElement) detailsElement.open = true;
                    editUserSelect.value = username;
                    handleEditUserSelect();
                    switchEditTab('info');
                });
            });

            document.querySelectorAll('.list-extend-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    showAdminView('managementTools');
                    switchMgmtTab('users');
                    const detailsElement = editUserSelect.closest('details');
                    if (detailsElement) detailsElement.open = true;
                    editUserSelect.value = username;
                    handleEditUserSelect();
                    switchEditTab('extend');
                });
            });

            document.querySelectorAll('.list-copy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    const password = e.currentTarget.dataset.password;
                    const expiry = e.currentTarget.dataset.expiry;
                    const userType = e.currentTarget.dataset.usertype;

                    // ≈ûablonu olu≈ütur (WhatsApp bold: *metin*)
                    const template = 'üéâ *IPTV KULLANICI Bƒ∞LGƒ∞LERƒ∞Nƒ∞Z* üéâ\n\nT√ºm giri≈ü bilgileriniz a≈üaƒüƒ±dadƒ±r. L√ºtfen bu bilgileri cihazlarƒ±nƒ±zƒ±n kurulum ekranlarƒ±na eksiksiz giriniz: üëá\n\n*üîë Gƒ∞Rƒ∞≈û Bƒ∞LGƒ∞LERƒ∞Nƒ∞Zƒ∞N TAMAMI*\n\nüÜî *Kullanƒ±cƒ± Adƒ±:* ' + username + '\n\nüîí *≈ûifre:* ' + password + '\n\nüåê *Portal URL (Baƒülantƒ± Adresi):* http://kgms.xyz:8080\n\n*üí° NOT:*\n\nBu bilgileri yalnƒ±zca siz kullanabilirsiniz. üö´\n\nKurulum desteƒüi i√ßin bize ula≈üabilirsiniz. üì≤\n\n*Kurulum bilgileri ve videolarƒ±:* www.balkanpremiumtv.de\n\n*M√º≈üteri Merkezi:* Kullanƒ±cƒ± adƒ±nƒ±z ile giri≈ü yapabilirsiniz.\nhttps://balkantvpanel.web.app\n\nKeyifli seyirler! üì∫';

                    // Kopyala
                    navigator.clipboard.writeText(template).then(() => {
                        showMessage('Kullanƒ±cƒ± bilgileri kopyalandƒ±!', 'success');
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = template;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showMessage('Kullanƒ±cƒ± bilgileri kopyalandƒ±!', 'success');
                    });
                });
            });

            document.querySelectorAll('.list-delete-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const username = e.currentTarget.dataset.username;
                    deleteUserFromList(username);
                });
            });
        }
        
        /**
         * Sayfalama kontrollerini √ßizer
         */
        function renderPaginationControls(current, total) {
            
            if (total <= 1) {
                paginationControlsEl.innerHTML = '';
                return;
            }

            paginationControlsEl.innerHTML = `
                <button id="prevPageButton" 
                        class="py-1 px-3 bg-orange-500 text-white rounded-lg text-sm disabled:opacity-50 transition-colors"
                        ${current <= 1 ? 'disabled' : ''}>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    √ñnceki
                </button>
                <span class="text-sm font-semibold text-gray-700">
                    Sayfa ${current} / ${total}
                </span>
                <button id="nextPageButton" 
                        class="py-1 px-3 bg-orange-500 text-white rounded-lg text-sm disabled:opacity-50 transition-colors"
                        ${current >= total ? 'disabled' : ''}>
                    Sonraki
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </button>
            `;

            document.getElementById('prevPageButton').onclick = () => changePage(-1);
            document.getElementById('nextPageButton').onclick = () => changePage(1);
        }
        
        /**
         * Sayfayƒ± deƒüi≈ütirir ve listeyi yeniler
         */
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayFilteredUsers(allUsersData);
                // Listenin ba≈üƒ±na kaydƒ±r
                document.getElementById('userListContainer').scrollTop = 0;
            }
        }


        
        /**
         * √úyelik Uzatma Talebini Siler
         */
        async function deleteRenewalRequest(requestId) {
            try {
                // DOM'dan hemen kaldƒ±r (UI responsive yap)
                const requestElement = document.querySelector(`[data-request-id="${requestId}"]`);
                if (requestElement) {
                    requestElement.remove();
                }
                
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/renewal_requests`, requestId));
                showMessage('Talep ba≈üarƒ±yla silindi.', 'success');
                
                // Metriƒüi g√ºncelle
                const currentCount = parseInt(requestCountEl.textContent) - 1;
                requestCountEl.textContent = `${currentCount} Talep`;
                metricRenewalRequestsEl.textContent = currentCount;
                
            } catch (error) {
                console.error("Talep silme hatasƒ±:", error);
                showMessage('Talep silinirken bir hata olu≈ütu.', 'error');
                // Hata varsa listeyi yenile
                fetchRenewalRequests();
            }
        }

        /**
         * Hesap Uzatma Taleplerini √ßeker ve Admin UI'da listeler.
         */
        let isFetchingRenewalRequests = false;
        async function fetchRenewalRequests() {
             if (!isAdminUser) return;
             if (isFetchingRenewalRequests) return;
             isFetchingRenewalRequests = true;

            const requestStatusEl = document.getElementById('requestStatus');
            requestStatusEl.textContent = "Talepler y√ºkleniyor...";
            renewalRequestsList.innerHTML = '';
            requestCountEl.textContent = '0 Yeni';
            refreshRequestsButton.disabled = true;
            requestStatusEl.classList.remove('hidden');

            try {
                const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/renewal_requests`);
                const querySnapshot = await getDocs(requestsCollectionRef);

                let requests = [];
                querySnapshot.forEach((doc) => {
                    requests.push({ id: doc.id, ...doc.data() });
                });
                
                requests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

                const requestCount = requests.length;
                requestCountEl.textContent = `${requestCount} Talep`;
                metricRenewalRequestsEl.textContent = requestCount; 

                // Yeni talep varsa animasyon ekle
                if (requestCount > lastRenewalRequestCount) {
                    const renewalMetricCard = document.querySelector('[data-filter="renewal"]');
                    if (renewalMetricCard) {
                        renewalMetricCard.classList.add('animate-bounce');
                        setTimeout(() => {
                            renewalMetricCard.classList.remove('animate-bounce');
                        }, 2500); // Animasyonu 2.5 saniye sonra kaldƒ±r
                    }
                }
                lastRenewalRequestCount = requestCount; // Son sayƒ±yƒ± g√ºncelle


                if (requests.length === 0) {
                    requestStatusEl.textContent = "Mevcut √ºyelik uzatma talebi bulunmamaktadƒ±r.";
                    renewalRequestsList.appendChild(requestStatusEl);
                    return;
                }

                requestStatusEl.classList.add('hidden');
                
                const listHtml = requests.map(req => {
                    const statusClass = req.status === 'Beklemede' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800';
                    const typeClass = req.userTypeConfirmed === 'YURTDISI' ? 'bg-orange-200 text-orange-800' : 'bg-blue-200 text-blue-800';
                    const phoneDisplay = req.phoneNumber ? `<p class="text-xs text-gray-700 font-semibold">Tel: ${req.phoneNumber}</p>` : '';

                    return `
                        <div class="p-3 border-b border-gray-100 flex justify-between items-center hover:bg-gray-100 transition-colors duration-150" data-request-id="${req.id}">
                            <div>
                                <p class="font-bold text-gray-800">Kullanƒ±cƒ±: ${req.username}</p>
                                <p class="text-sm text-orange-600 font-semibold">S√ºre: ${req.requestDuration}</p>
                                ${phoneDisplay}
                                <p class="text-xs text-gray-500">${new Date(req.requestDate).toLocaleString('tr-TR')}</p>
                            </div>
                            <div class="text-right flex flex-col items-end space-y-1">
                                <span class="text-xs font-bold ${typeClass} px-2 py-0.5 rounded-full">${req.userTypeConfirmed || 'Bƒ∞Lƒ∞NMƒ∞YOR'}</span>
                                <span class="text-xs font-bold ${statusClass} px-2 py-0.5 rounded-full mb-2">${req.status}</span>
                                <button data-username="${req.username}" data-request-id="${req.id}" class="update-user-from-request-button py-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-semibold">
                                    G√ºncelle
                                </button>
                                <button data-request-id="${req.id}" class="delete-renewal-request-button py-1 px-3 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs font-semibold">
                                    Sil
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                renewalRequestsList.innerHTML = listHtml;

                // Guncelle butonlarina event listener ekle
                document.querySelectorAll('.update-user-from-request-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const username = e.currentTarget.dataset.username;
                        const requestId = e.currentTarget.dataset.requestId;

                        // Talebi daha sonra silmek i√ßin ID'sini sakla
                        currentRenewalRequestIdForUpdate = requestId;
                        
                        showAdminView('managementTools');
                        
                        const detailsElement = editUserSelect.closest('details');
                        if (detailsElement) {
                            detailsElement.open = true;
                        }
                        
                        editUserSelect.value = username;
                        handleEditUserSelect();
                    });
                });

                // Sil butonlarƒ±na event listener ekle
                document.querySelectorAll('.delete-renewal-request-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const requestId = e.currentTarget.dataset.requestId;
                        if (confirm('Bu uzatma talebini silmek istediƒüinizden emin misiniz?')) {
                            deleteRenewalRequest(requestId);
                        }
                    });
                });

            } catch (error) {
                console.error("Talep listesi √ßekme hatasƒ±:", error);
                requestStatusEl.textContent = `Liste y√ºklenirken bir hata olu≈ütu: ${error.message}`;
                requestStatusEl.classList.remove('hidden');
            } finally {
                refreshRequestsButton.disabled = false;
                isFetchingRenewalRequests = false;
            }
        }

        /**
         * Yeni Hesap Olu≈üturma Taleplerini √ßeker ve Admin UI'da listeler.
         */
        let isFetchingNewAccountRequests = false;
        async function fetchNewAccountRequests() {
             if (!isAdminUser) return;
             if (isFetchingNewAccountRequests) return;
             isFetchingNewAccountRequests = true;

            newAccountRequestStatusEl.textContent = "Talepler y√ºkleniyor...";
            newAccountRequestsList.innerHTML = '';
            newAccountRequestCountEl.textContent = '0 Yeni';
            refreshNewAccountRequestsButton.disabled = true;
            newAccountRequestStatusEl.classList.remove('hidden');
            newAccountRequestsData = [];

            try {
                const requestsCollectionRef = collection(db, `artifacts/${appId}/public/data/new_account_requests`);
                const querySnapshot = await getDocs(requestsCollectionRef);

                querySnapshot.forEach((doc) => {
                    newAccountRequestsData.push({ id: doc.id, ...doc.data() });
                });
                
                newAccountRequestsData.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

                newAccountRequestCountEl.textContent = `${newAccountRequestsData.length} Talep`;
                metricNewAccountRequestsEl.textContent = newAccountRequestsData.length; 

                if (newAccountRequestsData.length === 0) {
                    newAccountRequestStatusEl.textContent = "Yeni hesap olu≈üturma talebi bulunmamaktadƒ±r.";
                    newAccountRequestsList.appendChild(newAccountRequestStatusEl);
                    return;
                }

                newAccountRequestStatusEl.classList.add('hidden');
                
                const listHtml = newAccountRequestsData.map(req => {
                    const statusClass = req.status === 'Beklemede' ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800';
                    const typeClass = req.userType === 'YURTDISI' ? 'bg-orange-200 text-orange-800' : 'bg-blue-200 text-blue-800';
                    const nameDisplay = req.fullName ? `<p class="font-bold text-gray-800">${req.fullName}</p>` : '';
                    const contactInfo = `<p class="text-xs text-gray-700">üì± ${req.phoneNumber} | ‚úâÔ∏è ${req.email || 'Yok'}</p>`;
                    const credInfo = req.generatedUsername ? `<p class="text-xs text-green-700 font-semibold">üîë ${req.generatedUsername}</p>` : '';

                    return `
                        <div class="p-3 border-b border-gray-100 hover:bg-gray-50 transition-colors duration-150">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    ${nameDisplay}
                                    <p class="text-sm text-orange-600 font-semibold">S√ºre: ${req.requestDuration}</p>
                                    ${contactInfo}
                                    ${credInfo}
                                    <p class="text-xs text-gray-500">${new Date(req.requestDate).toLocaleString('tr-TR')}</p>
                                </div>
                                <div class="text-right flex flex-col items-end space-y-1.5 ml-3">
                                    <span class="text-xs font-bold ${typeClass} px-2 py-0.5 rounded-full">${req.userType === 'YURTDISI' ? 'üåç Yurtdƒ±≈üƒ±' : 'üáπüá∑ Yurti√ßi'}</span>
                                    <span class="text-xs font-bold ${statusClass} px-2 py-0.5 rounded-full">${req.status}</span>
                                    <button data-request-id="${req.id}" 
                                            data-phone="${req.phoneNumber}" 
                                            data-email="${req.email || ''}"
                                            data-duration="${req.requestDuration}"
                                            data-usertype="${req.userType}"
                                            data-fullname="${req.fullName || ''}"
                                            data-generated-username="${req.generatedUsername || ''}"
                                            data-generated-password="${req.generatedPassword || ''}"
                                            class="approve-button py-1.5 px-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-semibold flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                                        Onayla
                                    </button>
                                    <button data-request-id="${req.id}" 
                                            class="delete-new-request-button py-1 px-3 bg-red-500 hover:bg-red-600 text-white rounded-lg text-[10px] font-semibold">
                                        Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                newAccountRequestsList.innerHTML = listHtml;
                
                // Onay butonlarƒ±na dinleyici ekle
                document.querySelectorAll('.approve-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const data = e.currentTarget.dataset;
                        openAccountApprovalModal({
                            id: data.requestId,
                            fullName: data.fullname,
                            phoneNumber: data.phone,
                            email: data.email,
                            requestDuration: data.duration,
                            userType: data.usertype,
                            generatedUsername: e.currentTarget.dataset.generatedUsername || '',
                            generatedPassword: e.currentTarget.dataset.generatedPassword || ''
                        });
                    });
                });

                // Talep silme butonlarƒ±
                document.querySelectorAll('.delete-new-request-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const requestId = e.currentTarget.dataset.requestId;
                        if (!confirm('Bu hesap talebini silmek istediƒüinize emin misiniz?')) return;
                        try {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/new_account_requests`, requestId));
                            showMessage('Talep silindi.', 'success');
                            fetchNewAccountRequests();
                        } catch (err) {
                            showMessage(`Silme hatasƒ±: ${err.message}`, 'error');
                        }
                    });
                });

            } catch (error) {
                console.error("Yeni hesap talebi listesi √ßekme hatasƒ±:", error);
                newAccountRequestStatusEl.textContent = `Liste y√ºklenirken bir hata olu≈ütu: ${error.message}`;
                newAccountRequestStatusEl.classList.remove('hidden');
            } finally {
                refreshNewAccountRequestsButton.disabled = false;
                isFetchingNewAccountRequests = false;
            }
        }

        /**
         * Y√∂netici i√ßin g√∂nderilen mesajlarƒ± √ßeker ve listeler (YENƒ∞)
         */
        async function fetchAdminMessages() {
            adminMessagesList.innerHTML = '<p class="text-center p-4 text-gray-500">Mesajlar y√ºkleniyor...</p>';
            refreshMessagesButton.disabled = true;

            try {
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const querySnapshot = await getDocs(messagesCollectionRef);

                allMessages = [];
                querySnapshot.forEach((doc) => {
                    allMessages.push({ id: doc.id, ...doc.data() });
                });

                allMessages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (allMessages.length === 0) {
                    adminMessagesList.innerHTML = '<p class="text-center p-4 text-gray-500">Hen√ºz g√∂nderilmi≈ü mesaj yok.</p>';
                    return;
                }

                const listHtml = allMessages.map(msg => `
                    <div class="p-3 border-b border-gray-200 bg-white">
                        <div class="flex justify-between items-start">
                            <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                            <button data-message-id="${msg.id}" class="delete-message-button ml-4 p-1 text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path></svg>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">G√∂nderim: ${new Date(msg.timestamp).toLocaleString('tr-TR')}</p>
                    </div>
                `).join('');

                adminMessagesList.innerHTML = listHtml;

                // Silme butonlarƒ±na olay dinleyici ekle
                document.querySelectorAll('.delete-message-button').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const messageId = e.currentTarget.dataset.messageId;
                        if (confirm("Bu mesajƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?")) {
                            try {
                                await deleteDoc(doc(db, `artifacts/${appId}/public/data/messages`, messageId));
                                showMessage("Mesaj ba≈üarƒ±yla silindi.", 'success');
                                fetchAdminMessages(); // Listeyi yenile
                            } catch (error) {
                                console.error('Mesaj silme hatasƒ±:', error);
                                showMessage('Mesaj silinirken bir hata olu≈ütu.', 'error');
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("Mesaj ar≈üivi √ßekme hatasƒ±:", error);
                adminMessagesList.innerHTML = `<p class="text-center p-4 text-red-500">Mesajlar y√ºklenirken hata olu≈ütu.</p>`;
            } finally {
                refreshMessagesButton.disabled = false;
            }
        }

        /**
         * Kullanƒ±cƒ± i√ßin mesajlarƒ± √ßeker ve g√∂r√ºnt√ºler (YENƒ∞)
         */
        async function displayUserMessages() {
            if (!isAuthReady) return;

            try {
                const messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                const querySnapshot = await getDocs(messagesCollectionRef);

                const messages = [];
                querySnapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Kullanƒ±cƒ±nƒ±n sildiƒüi mesajlarƒ± Firestore'dan al
                let dismissedMessages = [];
                if (currentLoggedInUser && currentLoggedInUser.iptvUsername) {
                    const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, currentLoggedInUser.iptvUsername);
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        dismissedMessages = userSnap.data().dismissedMessages || [];
                    }
                }
                const unreadMessages = messages.filter(msg => !dismissedMessages.includes(msg.id));

                if (unreadMessages.length === 0) {
                    userMessagesContainer.innerHTML = '<p class="text-center p-4 text-gray-400 text-sm">Okunmamƒ±≈ü yeni mesajƒ±nƒ±z bulunmuyor.</p>';
                    return;
                }

                const messagesHtml = unreadMessages.map(msg => `
                    <div id="message-card-${msg.id}" class="p-4 bg-white border-l-4 border-blue-500 rounded-r-lg shadow-sm">
                        <p class="text-sm text-gray-800 whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                        <div class="flex justify-between items-center mt-3">
                            <p class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleString('tr-TR')}</p>
                            <button data-message-id="${msg.id}" class="delete-user-message-button py-1 px-3 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-semibold">Sil</button>
                        </div>
                    </div>
                `).join('');

                userMessagesContainer.innerHTML = messagesHtml;

                // "Sil" butonlarƒ±na olay dinleyici ekle
                document.querySelectorAll('.delete-user-message-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const messageId = e.currentTarget.dataset.messageId;
                        deleteUserMessage(messageId);
                    });
                });

            } catch (error) {
                console.error("Kullanƒ±cƒ± mesajlarƒ±nƒ± √ßekme hatasƒ±:", error);
            }
        }

        /**
         * Mesajƒ± kullanƒ±cƒ± i√ßin okundu olarak i≈üaretler ve gizler (YENƒ∞)
         */
        async function deleteUserMessage(messageId) {
            if (!currentLoggedInUser || !currentLoggedInUser.iptvUsername) return;

            try {
                const userRef = doc(db, `artifacts/${appId}/public/data/iptv_users`, currentLoggedInUser.iptvUsername);
                const userSnap = await getDoc(userRef);
                const dismissed = userSnap.exists() ? (userSnap.data().dismissedMessages || []) : [];
                if (!dismissed.includes(messageId)) {
                    dismissed.push(messageId);
                    await setDoc(userRef, { dismissedMessages: dismissed }, { merge: true });
                }
            } catch (err) {
                console.error('Mesaj silme hatasƒ±:', err);
            }

            const messageCard = document.getElementById(`message-card-${messageId}`);
            if (messageCard) {
                messageCard.remove();
            }
            if (userMessagesContainer.children.length === 0) {
                userMessagesContainer.innerHTML = '<p class="text-center p-4 text-gray-400 text-sm">Okunmamƒ±≈ü yeni mesajƒ±nƒ±z bulunmuyor.</p>';
            }
        }

        // ===============================================
        // KONU≈ûMA (CHAT) Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI
        // ===============================================

        /**
         * Kullanƒ±cƒ±nƒ±n konu≈ümasƒ±nƒ± y√ºkler veya olu≈üturur
         */
        async function loadUserConversation() {
            if (!currentLoggedInUser || !currentLoggedInUser.iptvUsername) return;
            
            const username = currentLoggedInUser.iptvUsername;
            
            try {
                const convRef = doc(db, `artifacts/${appId}/public/data/conversations`, username);
                const convSnap = await getDoc(convRef);
                
                if (convSnap.exists()) {
                    // Mevcut konu≈ümayƒ± y√ºkle
                    await renderUserChat(username);
                    // Kullanƒ±cƒ± a√ßtƒ±ƒüƒ±nda okundu i≈üaretle
                    await setDoc(convRef, { unreadByUser: 0 }, { merge: true });
                } else {
                    userChatMessages.innerHTML = '<p class="text-center text-sm text-gray-400 py-8">Hen√ºz mesaj yok. Y√∂neticiye bir mesaj g√∂nderin.</p>';
                }
            } catch (error) {
                console.error('Konu≈üma y√ºkleme hatasƒ±:', error);
            }
        }

        /**
         * Kullanƒ±cƒ±nƒ±n sohbet mesajlarƒ±nƒ± render eder
         */
        async function renderUserChat(username) {
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/conversations/${username}/messages`);
                const querySnapshot = await getDocs(messagesRef);
                
                const msgs = [];
                querySnapshot.forEach(d => msgs.push({ id: d.id, ...d.data() }));
                msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                if (msgs.length === 0) {
                    userChatMessages.innerHTML = '<p class="text-center text-sm text-gray-400 py-8">Hen√ºz mesaj yok. Y√∂neticiye bir mesaj g√∂nderin.</p>';
                    return;
                }
                
                userChatMessages.innerHTML = msgs.map(msg => {
                    const isUser = msg.sender === 'user';
                    const time = new Date(msg.timestamp).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] px-3 py-2 rounded-xl text-sm ${isUser ? 'bg-orange-500 text-white rounded-br-sm' : 'bg-gray-200 text-gray-800 rounded-bl-sm'}">
                                <p class="whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                                <p class="text-[10px] mt-1 ${isUser ? 'text-orange-100' : 'text-gray-500'} text-right">${time}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                userChatMessages.scrollTop = userChatMessages.scrollHeight;
            } catch (error) {
                console.error('Sohbet render hatasƒ±:', error);
            }
        }

        /**
         * Kullanƒ±cƒ± mesaj g√∂nderir
         */
        async function sendUserMessage() {
            if (!currentLoggedInUser || !currentLoggedInUser.iptvUsername) {
                showMessage('√ñnce giri≈ü yapmalƒ±sƒ±nƒ±z.', 'error');
                return;
            }
            
            const content = userMessageInput.value.trim();
            if (!content) {
                showMessage('L√ºtfen bir mesaj yazƒ±n.', 'info');
                return;
            }
            
            const username = currentLoggedInUser.iptvUsername;
            sendUserMessageButton.disabled = true;
            
            try {
                const convRef = doc(db, `artifacts/${appId}/public/data/conversations`, username);
                const now = new Date().toISOString();
                
                // Mevcut konu≈ümayƒ± oku
                const convSnap = await getDoc(convRef);
                const existingData = convSnap.exists() ? convSnap.data() : null;
                
                // Konu≈üma d√∂k√ºmanƒ±nƒ± olu≈ütur/g√ºncelle
                await setDoc(convRef, {
                    username: username,
                    fullName: currentLoggedInUser.fullName || username,
                    userType: currentLoggedInUser.userType || 'YURTICI',
                    lastMessageAt: now,
                    lastMessage: content.substring(0, 100),
                    lastSender: 'user',
                    unreadByAdmin: existingData ? (existingData.unreadByAdmin || 0) + 1 : 1,
                    unreadByUser: 0,
                    createdAt: existingData ? existingData.createdAt : now
                }, { merge: true });
                
                // Mesajƒ± kaydet
                const messagesRef = collection(db, `artifacts/${appId}/public/data/conversations/${username}/messages`);
                await addDoc(messagesRef, {
                    content: content,
                    sender: 'user',
                    timestamp: now
                });
                
                userMessageInput.value = '';
                showMessage('Mesajƒ±nƒ±z g√∂nderildi!', 'success');
                await renderUserChat(username);
                
            } catch (error) {
                console.error('Mesaj g√∂nderme hatasƒ±:', error);
                showMessage('Mesaj g√∂nderilemedi. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                sendUserMessageButton.disabled = false;
            }
        }

        /**
         * Admin: T√ºm konu≈ümalarƒ± listeler
         */
        async function fetchConversations() {
            if (!conversationsList) return;
            conversationsList.innerHTML = '<p class="text-center p-4 text-gray-400 text-sm">Y√ºkleniyor...</p>';
            
            try {
                const convsRef = collection(db, `artifacts/${appId}/public/data/conversations`);
                const querySnapshot = await getDocs(convsRef);
                
                const convs = [];
                querySnapshot.forEach(d => convs.push({ id: d.id, ...d.data() }));
                convs.sort((a, b) => new Date(b.lastMessageAt) - new Date(a.lastMessageAt));
                
                if (convs.length === 0) {
                    conversationsList.innerHTML = '<p class="text-center p-4 text-gray-500 text-sm">Hen√ºz kullanƒ±cƒ± mesajƒ± yok.</p>';
                    return;
                }
                
                conversationsList.innerHTML = convs.map(conv => {
                    const unread = conv.unreadByAdmin || 0;
                    const isActive = currentAdminConversationId === conv.id;
                    const time = conv.lastMessageAt ? new Date(conv.lastMessageAt).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';
                    const senderIcon = conv.lastSender === 'user' ? 'üë§' : 'üì§';
                    
                    return `
                        <div class="conversation-item p-3 cursor-pointer hover:bg-orange-50 transition-colors ${isActive ? 'bg-orange-100 border-l-4 border-orange-500' : ''}" data-conv-id="${conv.id}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <p class="font-bold text-sm text-gray-800 truncate">${conv.fullName || conv.username}</p>
                                    <p class="text-xs text-gray-500 truncate">@${conv.username}</p>
                                    <p class="text-xs text-gray-400 mt-1 truncate">${senderIcon} ${conv.lastMessage || ''}</p>
                                </div>
                                <div class="flex flex-col items-end ml-2">
                                    <span class="text-[10px] text-gray-400">${time}</span>
                                    ${unread > 0 ? `<span class="mt-1 inline-flex items-center justify-center w-5 h-5 text-[10px] font-bold text-white bg-red-500 rounded-full">${unread}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Konu≈üma tƒ±klama dinleyicisi
                document.querySelectorAll('.conversation-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const convId = item.dataset.convId;
                        openAdminConversation(convId);
                    });
                });
                
            } catch (error) {
                console.error('Konu≈ümalar √ßekme hatasƒ±:', error);
                conversationsList.innerHTML = '<p class="text-center p-4 text-red-500 text-sm">Y√ºkleme hatasƒ±.</p>';
            }
        }

        /**
         * Admin: Bir konu≈ümayƒ± a√ßar
         */
        async function openAdminConversation(username) {
            currentAdminConversationId = username;
            
            // Header g√ºncelle
            const convRef = doc(db, `artifacts/${appId}/public/data/conversations`, username);
            const convSnap = await getDoc(convRef);
            const convData = convSnap.exists() ? convSnap.data() : {};
            
            adminChatHeader.innerHTML = `
                <div class="flex items-center justify-between">
                    <div>
                        <p class="font-bold text-gray-800">${convData.fullName || username}</p>
                        <p class="text-xs text-gray-500">@${username} ¬∑ ${convData.userType === 'YURTDISI' ? 'üåç Yurtdƒ±≈üƒ±' : 'üáπüá∑ Yurti√ßi'}</p>
                    </div>
                    <button id="deleteConversationButton" class="py-1 px-3 bg-red-500 hover:bg-red-600 text-white rounded-lg text-xs font-semibold">Konu≈ümayƒ± Sil</button>
                </div>
            `;
            
            // Sil butonu dinleyicisi
            document.getElementById('deleteConversationButton').addEventListener('click', async () => {
                if (!confirm(`${username} ile olan t√ºm konu≈ümayƒ± silmek istediƒüinize emin misiniz?`)) return;
                try {
                    // Alt koleksiyondaki mesajlarƒ± sil
                    const msgsRef = collection(db, `artifacts/${appId}/public/data/conversations/${username}/messages`);
                    const msgsSnap = await getDocs(msgsRef);
                    const deletePromises = [];
                    msgsSnap.forEach(d => deletePromises.push(deleteDoc(doc(db, `artifacts/${appId}/public/data/conversations/${username}/messages`, d.id))));
                    await Promise.all(deletePromises);
                    // Ana d√∂k√ºmanƒ± sil
                    await deleteDoc(convRef);
                    showMessage('Konu≈üma silindi.', 'success');
                    currentAdminConversationId = null;
                    adminChatHeader.innerHTML = '<p class="text-sm font-bold text-gray-600">Bir konu≈üma se√ßin</p>';
                    adminChatMessages.innerHTML = '<p class="text-center text-sm text-gray-400 mt-10">‚Üê Soldan bir kullanƒ±cƒ± se√ßin</p>';
                    adminReplyArea.classList.add('hidden');
                    fetchConversations();
                } catch (err) {
                    showMessage(`Silme hatasƒ±: ${err.message}`, 'error');
                }
            });
            
            // Okundu i≈üaretle
            await setDoc(convRef, { unreadByAdmin: 0 }, { merge: true });
            
            // Mesajlarƒ± y√ºkle
            await renderAdminChat(username);
            
            // Cevap alanƒ±nƒ± g√∂ster
            adminReplyArea.classList.remove('hidden');
            
            // Listeyi g√ºncelle (okundu badge kaldƒ±r)
            fetchConversations();
        }

        /**
         * Admin: Sohbet mesajlarƒ±nƒ± render eder
         */
        async function renderAdminChat(username) {
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/conversations/${username}/messages`);
                const querySnapshot = await getDocs(messagesRef);
                
                const msgs = [];
                querySnapshot.forEach(d => msgs.push({ id: d.id, ...d.data() }));
                msgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                if (msgs.length === 0) {
                    adminChatMessages.innerHTML = '<p class="text-center text-sm text-gray-400 py-8">Bu konu≈ümada hen√ºz mesaj yok.</p>';
                    return;
                }
                
                adminChatMessages.innerHTML = msgs.map(msg => {
                    const isAdmin = msg.sender === 'admin';
                    const time = new Date(msg.timestamp).toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] px-3 py-2 rounded-xl text-sm ${isAdmin ? 'bg-orange-500 text-white rounded-br-sm' : 'bg-gray-200 text-gray-800 rounded-bl-sm'}">
                                <p class="text-[10px] font-bold mb-1 ${isAdmin ? 'text-orange-100' : 'text-gray-500'}">${isAdmin ? 'üë®‚Äçüíº Y√∂netici' : 'üë§ ' + escapeHtml(username)}</p>
                                <p class="whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                                <p class="text-[10px] mt-1 ${isAdmin ? 'text-orange-100' : 'text-gray-500'} text-right">${time}</p>
                            </div>
                        </div>
                    `;
                }).join('');
                
                adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            } catch (error) {
                console.error('Admin sohbet render hatasƒ±:', error);
            }
        }

        /**
         * Admin: Kullanƒ±cƒ±ya cevap g√∂nderir
         */
        async function sendAdminReply() {
            if (!currentAdminConversationId) {
                showMessage('√ñnce bir konu≈üma se√ßin.', 'info');
                return;
            }
            
            const content = adminReplyInput.value.trim();
            if (!content) {
                showMessage('L√ºtfen bir cevap yazƒ±n.', 'info');
                return;
            }
            
            sendAdminReplyButton.disabled = true;
            const username = currentAdminConversationId;
            
            try {
                const convRef = doc(db, `artifacts/${appId}/public/data/conversations`, username);
                const now = new Date().toISOString();
                
                // Konu≈üma d√∂k√ºmanƒ±nƒ± g√ºncelle
                const convSnap = await getDoc(convRef);
                const currentUnread = convSnap.exists() ? (convSnap.data().unreadByUser || 0) : 0;
                
                await setDoc(convRef, {
                    lastMessageAt: now,
                    lastMessage: content.substring(0, 100),
                    lastSender: 'admin',
                    unreadByUser: currentUnread + 1,
                    unreadByAdmin: 0
                }, { merge: true });
                
                // Mesajƒ± kaydet
                const messagesRef = collection(db, `artifacts/${appId}/public/data/conversations/${username}/messages`);
                await addDoc(messagesRef, {
                    content: content,
                    sender: 'admin',
                    timestamp: now
                });
                
                adminReplyInput.value = '';
                showMessage('Cevap g√∂nderildi!', 'success');
                await renderAdminChat(username);
                fetchConversations();
                
            } catch (error) {
                console.error('Admin cevap g√∂nderme hatasƒ±:', error);
                showMessage('Cevap g√∂nderilemedi. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                sendAdminReplyButton.disabled = false;
            }
        }


        // ===============================================
        // IYZICO √ñDEME Sƒ∞STEMƒ∞ FONKSƒ∞YONLARI
        // ===============================================
        
        let iyzicoSettings = {}; // iyzico ayarlarƒ±
        let selectedIyzicoPackage = null; // Se√ßilen √∂deme paketi
        let iyzicoAccordionOpen = false; // Accordion durumu
        
        /**
         * Kullanƒ±cƒ± tarafƒ±ndan iyzico durumunu kontrol eder ve UI'ƒ± g√ºnceller
         */
        async function loadIyzicoUserState() {
            try {
                const iyzicoRef = doc(db, `artifacts/${appId}/public/data/settings`, 'iyzico');
                const docSnap = await getDoc(iyzicoRef);
                
                const badge = document.getElementById('iyzicoUserStatusBadge');
                const disabledNotice = document.getElementById('iyzicoDisabledNotice');
                const activeArea = document.getElementById('iyzicoActivePaymentArea');
                
                let isEnabled = false;
                if (docSnap.exists()) {
                    iyzicoSettings = docSnap.data();
                    isEnabled = iyzicoSettings.enabled || false;
                }
                
                if (isEnabled) {
                    badge.innerHTML = '‚úÖ Aktif';
                    badge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-600 border border-green-200';
                    if (disabledNotice) disabledNotice.classList.add('hidden');
                    if (activeArea) activeArea.classList.remove('hidden');
                    renderIyzicoPackageCards();
                } else {
                    badge.innerHTML = '‚õî Devre Dƒ±≈üƒ±';
                    badge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-600 border border-red-200';
                    if (disabledNotice) disabledNotice.classList.remove('hidden');
                    if (activeArea) activeArea.classList.add('hidden');
                }
            } catch (error) {
                console.error('iyzico kullanƒ±cƒ± durumu hatasƒ±:', error);
            }
        }
        
        /**
         * Accordion a√ßma/kapatma
         */
        function toggleIyzicoAccordion() {
            const content = document.getElementById('iyzicoAccordionContent');
            const chevron = document.getElementById('iyzicoAccordionChevron');
            
            iyzicoAccordionOpen = !iyzicoAccordionOpen;
            
            if (iyzicoAccordionOpen) {
                content.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        /**
         * iyzico Ayarlarƒ±nƒ± Firestore'dan Y√ºkler
         */
        async function loadIyzicoSettings() {
            try {
                if (isAdminUser) {
                    // Admin: Cloud Function'dan maskelenmi≈ü key'leri al
                    const getIyzicoFn = httpsCallable(functions, 'getIyzicoSettings');
                    const result = await getIyzicoFn();
                    iyzicoSettings = result.data;
                } else {
                    // Kullanƒ±cƒ±: Sadece public bilgileri oku
                    const iyzicoRef = doc(db, `artifacts/${appId}/public/data/settings`, 'iyzico');
                    const docSnap = await getDoc(iyzicoRef);
                    if (docSnap.exists()) {
                        iyzicoSettings = docSnap.data();
                    }
                }
                
                // Admin UI'ƒ± g√ºncelle
                const apiKeyInput = document.getElementById('iyzicoApiKey');
                const secretKeyInput = document.getElementById('iyzicoSecretKey');
                const callbackInput = document.getElementById('iyzicoCallbackUrl');
                const enabledToggle = document.getElementById('iyzicoEnabledToggle');
                const statusText = document.getElementById('iyzicoStatusText');
                const modeBadge = document.getElementById('iyzicoModeBadge');
                const statusCard = document.getElementById('iyzicoStatusCard');
                const settingsStatus = document.getElementById('iyzicoSettingsStatus');
                
                if (apiKeyInput) apiKeyInput.value = iyzicoSettings.apiKey || '';
                if (secretKeyInput) secretKeyInput.value = iyzicoSettings.secretKey || '';
                if (callbackInput) callbackInput.value = iyzicoSettings.callbackUrl || 'https://balkantvpanel.web.app';
                if (enabledToggle) enabledToggle.checked = iyzicoSettings.enabled || false;
                
                // Mode radio
                const modeRadios = document.querySelectorAll('input[name="iyzicoMode"]');
                modeRadios.forEach(radio => {
                    radio.checked = radio.value === (iyzicoSettings.mode || 'sandbox');
                });
                
                if (iyzicoSettings.apiKey || iyzicoSettings.hasKeys) {
                    if (statusText) {
                        statusText.textContent = iyzicoSettings.enabled ? 'Aktif' : 'Pasif';
                        statusText.className = iyzicoSettings.enabled ? 'text-green-600' : 'text-red-600';
                    }
                    if (statusCard) statusCard.className = `p-4 rounded-xl ${iyzicoSettings.enabled ? 'bg-green-50 border border-green-300' : 'bg-red-50 border border-red-300'}`;
                    if (modeBadge) {
                        modeBadge.textContent = (iyzicoSettings.mode === 'live') ? 'Canlƒ±' : 'Sandbox';
                        modeBadge.className = `px-3 py-1 text-xs font-bold rounded-full ${iyzicoSettings.mode === 'live' ? 'text-green-800 bg-green-200' : 'text-yellow-800 bg-yellow-200'}`;
                    }
                    if (settingsStatus) settingsStatus.textContent = `Son g√ºncelleme: ${iyzicoSettings.updatedAt ? new Date(iyzicoSettings.updatedAt).toLocaleString('tr-TR') : 'Bilinmiyor'}`;
                }
                
                // √ñdeme istatistiklerini y√ºkle (sadece admin)
                if (isAdminUser) await loadIyzicoPaymentStats();
                
            } catch (error) {
                console.error('iyzico ayarlarƒ± y√ºkleme hatasƒ±:', error);
            }
        }
        
        /**
         * iyzico Ayarlarƒ±nƒ± Kaydeder
         */
        async function saveIyzicoSettings() {
            const apiKey = document.getElementById('iyzicoApiKey').value.trim();
            const secretKey = document.getElementById('iyzicoSecretKey').value.trim();
            const callbackUrl = document.getElementById('iyzicoCallbackUrl').value.trim();
            const enabled = document.getElementById('iyzicoEnabledToggle').checked;
            const mode = document.querySelector('input[name="iyzicoMode"]:checked')?.value || 'sandbox';
            
            if (!apiKey || !secretKey) {
                showMessage('API Key ve Secret Key zorunludur.', 'error');
                return;
            }
            
            const saveBtn = document.getElementById('saveIyzicoSettingsBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Kaydediliyor...';
            
            try {
                // Cloud Function ile g√ºvenli kaydetme
                const saveIyzicoFn = httpsCallable(functions, 'saveIyzicoSettings');
                const result = await saveIyzicoFn({ apiKey, secretKey, callbackUrl, enabled, mode });
                
                showMessage(result.data.message || 'iyzico ayarlarƒ± g√ºvenli ≈üekilde kaydedildi!', 'success');
                await loadIyzicoSettings();
                
            } catch (error) {
                console.error('iyzico ayarlarƒ± kaydetme hatasƒ±:', error);
                showMessage('Bilgiler kaydedilirken bir hata olu≈ütu.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'iyzico Ayarlarƒ±nƒ± Kaydet';
            }
        }
        
        /**
         * √ñdeme ƒ∞statistiklerini Y√ºkler
         */
        async function loadIyzicoPaymentStats() {
            try {
                const paymentsRef = collection(db, `artifacts/${appId}/public/data/payments`);
                const querySnapshot = await getDocs(paymentsRef);
                
                let totalPayments = 0;
                let totalRevenue = 0;
                let successfulPayments = 0;
                let lastPaymentDate = null;
                
                querySnapshot.forEach((doc) => {
                    const payment = doc.data();
                    totalPayments++;
                    if (payment.status === 'success') {
                        successfulPayments++;
                        totalRevenue += payment.amount || 0;
                    }
                    const payDate = new Date(payment.createdAt);
                    if (!lastPaymentDate || payDate > lastPaymentDate) {
                        lastPaymentDate = payDate;
                    }
                });
                
                document.getElementById('iyzicoTotalPayments').textContent = totalPayments;
                document.getElementById('iyzicoTotalRevenue').textContent = `${totalRevenue.toLocaleString('tr-TR')} ‚Ç∫`;
                document.getElementById('iyzicoSuccessRate').textContent = totalPayments > 0 ? `%${Math.round(successfulPayments / totalPayments * 100)}` : '%0';
                document.getElementById('iyzicoLastPayment').textContent = lastPaymentDate ? lastPaymentDate.toLocaleDateString('tr-TR') : '-';
                
            } catch (error) {
                console.error('√ñdeme istatistikleri y√ºkleme hatasƒ±:', error);
            }
        }
        
        /**
         * Kullanƒ±cƒ± √ñdeme Paket Kartlarƒ±nƒ± Olu≈üturur
         */
        function renderIyzicoPackageCards() {
            const container = document.getElementById('iyzicoPackageCards');
            if (!container || !currentLoggedInUser) return;
            
            const userType = currentLoggedInUser.userType?.toUpperCase();
            const isInternational = userType === 'YURTDISI';
            const prices = isInternational ? priceList.international : priceList.domestic;
            const symbol = isInternational ? '‚Ç¨' : '‚Ç∫';
            
            let packages = [];
            if (isInternational) {
                packages = [
                    { id: 'single12M', label: '12 Ay', duration: '12 Ay', price: prices.single12M, popular: true }
                ];
            } else {
                packages = [
                    { id: 'single3M', label: '3 Ay', duration: '3 Ay', price: prices.single3M },
                    { id: 'single6M', label: '6 Ay', duration: '6 Ay', price: prices.single6M },
                    { id: 'single12M', label: '12 Ay', duration: '12 Ay', price: prices.single12M },
                    { id: 'single15M', label: '15 Ay', duration: '15 Ay', price: prices.single15M, popular: true },
                    { id: 'double12M', label: '12 Ay √áift', duration: '12 Ay √áift', price: prices.double12M }
                ];
            }
            
            container.innerHTML = packages.map(pkg => `
                <div class="iyzico-pkg-card cursor-pointer border-2 ${pkg.popular ? 'border-green-500 bg-green-50' : 'border-gray-200 bg-white'} rounded-xl p-3 text-center transition-all hover:shadow-md hover:border-green-400 relative ${selectedIyzicoPackage?.id === pkg.id ? 'ring-2 ring-green-500 border-green-500 bg-green-50' : ''}"
                     data-pkg-id="${pkg.id}" data-pkg-duration="${pkg.duration}" data-pkg-price="${pkg.price}">
                    ${pkg.popular ? '<span class="absolute -top-2 left-1/2 -translate-x-1/2 px-2 py-0.5 text-[10px] font-bold text-white bg-green-500 rounded-full">Pop√ºler</span>' : ''}
                    <p class="font-bold text-sm text-gray-700">${pkg.label}</p>
                    <p class="font-bold text-xl text-green-600 mt-1">${pkg.price} ${symbol}</p>
                    ${selectedIyzicoPackage?.id === pkg.id ? '<svg class="w-5 h-5 text-green-600 mx-auto mt-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' : ''}
                </div>
            `).join('');
            
            // Kart tƒ±klama
            container.querySelectorAll('.iyzico-pkg-card').forEach(card => {
                card.addEventListener('click', () => {
                    const pkgId = card.dataset.pkgId;
                    const price = parseFloat(card.dataset.pkgPrice);
                    const duration = card.dataset.pkgDuration;
                    
                    selectedIyzicoPackage = { id: pkgId, price, duration, symbol };
                    
                    // Se√ßimi g√ºncelle
                    renderIyzicoPackageCards();
                    
                    // √ñzet ve form g√∂ster
                    document.getElementById('iyzicoSelectedSummary').classList.remove('hidden');
                    document.getElementById('iyzicoSelectedPackage').textContent = duration;
                    document.getElementById('iyzicoSelectedPrice').textContent = `${price} ${symbol}`;
                    document.getElementById('iyzicoCardForm').classList.remove('hidden');
                    document.getElementById('iyzicoPayButton').disabled = false;
                });
            });
        }
        
        /**
         * Kart numarasƒ±nƒ± formatlar (her 4 hanede bo≈üluk)
         */
        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
            value = value.replace(/(.{4})/g, '$1 ').trim();
            input.value = value;
        }
        
        /**
         * Son kullanma tarihini formatlar (AA/YY)
         */
        function formatCardExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }
        
        /**
         * √ñdeme ƒ∞≈ülemini Ba≈ülatƒ±r (Mock - iyzico aktif olunca ger√ßek entegrasyon yapƒ±lacak)
         */
        async function processIyzicoPayment() {
            if (!selectedIyzicoPackage || !currentLoggedInUser) {
                showMessage('L√ºtfen bir paket se√ßiniz.', 'error');
                return;
            }
            
            const cardName = document.getElementById('iyzicoCardName').value.trim();
            const cardNumber = document.getElementById('iyzicoCardNumber').value.replace(/\s/g, '');
            const cardExpiry = document.getElementById('iyzicoCardExpiry').value.trim();
            const cardCvv = document.getElementById('iyzicoCardCvv').value.trim();
            
            if (!cardName || !cardNumber || !cardExpiry || !cardCvv) {
                showMessage('L√ºtfen t√ºm kart bilgilerini doldurun.', 'error');
                return;
            }
            
            if (cardNumber.length < 15) {
                showMessage('Ge√ßerli bir kart numarasƒ± giriniz.', 'error');
                return;
            }
            
            const payBtn = document.getElementById('iyzicoPayButton');
            const statusEl = document.getElementById('iyzicoPaymentStatus');
            payBtn.disabled = true;
            payBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> √ñdeme ƒ∞≈üleniyor...`;
            statusEl.classList.remove('hidden');
            statusEl.textContent = '√ñdeme sunucuya iletiliyor...';
            statusEl.className = 'text-xs text-center text-blue-600 py-2';
            
            try {
                // iyzico hen√ºz aktif deƒüil - √∂deme kaydƒ±nƒ± Firestore'a yaz
                const paymentData = {
                    username: currentLoggedInUser.iptvUsername,
                    package: selectedIyzicoPackage.duration,
                    amount: selectedIyzicoPackage.price,
                    currency: selectedIyzicoPackage.symbol === '‚Ç¨' ? 'EUR' : 'TRY',
                    status: 'pending', // iyzico aktif olunca 'success' olarak g√ºncellenecek
                    cardLastFour: cardNumber.slice(-4),
                    createdAt: new Date().toISOString(),
                    userType: currentLoggedInUser.userType
                };
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/payments`), paymentData);
                
                // Admin'e bildirim
                try {
                    const mailData = {
                        to: ADMIN_NOTIFICATION_EMAIL,
                        message: {
                            subject: `üí≥ YENƒ∞ √ñDEME TALEBƒ∞ - ${currentLoggedInUser.iptvUsername}`,
                            text: `Online √∂deme talebi:\n\nKullanƒ±cƒ±: ${currentLoggedInUser.iptvUsername}\nPaket: ${selectedIyzicoPackage.duration}\nTutar: ${selectedIyzicoPackage.price} ${selectedIyzicoPackage.symbol}\nKart Sonu: **** ${cardNumber.slice(-4)}\nTarih: ${new Date().toLocaleString('tr-TR')}\n\nNOT: iyzico hen√ºz aktif deƒüil. √ñdeme talebi beklemede.`
                        }
                    };
                    await addDoc(collection(db, 'mail'), mailData);
                } catch (mailErr) {
                    console.warn('Mail hatasƒ±:', mailErr);
                }
                
                statusEl.textContent = '‚è≥ √ñdeme talebiniz alƒ±ndƒ±. iyzico entegrasyonu aktif edildikten sonra i≈üleme alƒ±nacaktƒ±r. Size bildirim yapƒ±lacaktƒ±r.';
                statusEl.className = 'text-xs text-center text-green-600 py-2 bg-green-50 rounded-lg p-3';
                showMessage('√ñdeme talebiniz ba≈üarƒ±yla kaydedildi!', 'success');
                
                // Formu temizle
                document.getElementById('iyzicoCardName').value = '';
                document.getElementById('iyzicoCardNumber').value = '';
                document.getElementById('iyzicoCardExpiry').value = '';
                document.getElementById('iyzicoCardCvv').value = '';
                selectedIyzicoPackage = null;
                
            } catch (error) {
                console.error('√ñdeme hatasƒ±:', error);
                statusEl.textContent = '√ñdeme i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu.';
                statusEl.className = 'text-xs text-center text-red-600 py-2';
                showMessage('√ñdeme i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu.', 'error');
            } finally {
                payBtn.disabled = false;
                payBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg> G√ºvenli √ñdeme Yap`;
            }
        }

        // Olay Dinleyicileri
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleMainLogin();
        }); 
        userLogoutButton.addEventListener('click', resetUI);
        adminLogoutButton.addEventListener('click', resetUI);
        
        // Yeni Hesap Talebi G√∂r√ºn√ºm√º Kontrolleri
        showNewAccountFormButton.addEventListener('click', () => {
            loginForm.style.display = 'none';
            newAccountRequestContainer.style.display = 'block';
        });
        hideNewAccountFormButton.addEventListener('click', () => {
            newAccountRequestContainer.style.display = 'none';
            loginForm.style.display = 'block';
            // Formu sƒ±fƒ±rla
            document.getElementById('newAccountNameInput').value = '';
            newAccountPhoneInput.value = '';
            newAccountEmailInput.value = '';
            newAccountTypeSelect.value = '';
            newAccountDurationSelect.value = '';
            document.getElementById('newAccountDurationWrapper').classList.add('hidden');
            document.getElementById('newAccountPhoneError').classList.add('hidden');
            // Credentials kutusunu gizle ve buton g√∂ster
            const credBox = document.getElementById('newAccountCredentialsBox');
            if (credBox) credBox.classList.add('hidden');
            submitNewAccountRequestButton.classList.remove('hidden');
        });
        submitNewAccountRequestButton.addEventListener('click', submitNewAccountRequest);

        // Kullanƒ±m Alanƒ± deƒüi≈ütiƒüinde √ºyelik s√ºresi se√ßeneklerini g√ºncelle
        newAccountTypeSelect.addEventListener('change', function() {
            const durationWrapper = document.getElementById('newAccountDurationWrapper');
            const durationSelect = document.getElementById('newAccountDurationSelect');
            
            durationWrapper.classList.remove('hidden');
            durationSelect.innerHTML = '<option value="" disabled selected>-- S√ºre Se√ßin --</option>';
            
            if (this.value === 'YURTDISI') {
                durationSelect.innerHTML += '<option value="12 Ay">12 Ay</option>';
            } else if (this.value === 'YURTICI') {
                durationSelect.innerHTML += `
                    <option value="3 Ay">3 Ay</option>
                    <option value="6 Ay">6 Ay</option>
                    <option value="12 Ay">12 Ay</option>
                    <option value="15 Ay">15 Ay</option>
                    <option value="12 Ay √áift">12 Ay √áift Kullanƒ±cƒ±</option>
                `;
            }
        });

        // Test Hesabƒ± toggle'ƒ± deƒüi≈ütiƒüinde biti≈ü tarihini g√ºncelle
        const modalTestToggle = document.getElementById('modalTestAccountToggle');
        if (modalTestToggle) {
            modalTestToggle.addEventListener('change', function() {
                if (this.checked) {
                    const testExpiry = new Date();
                    testExpiry.setHours(testExpiry.getHours() + 24);
                    modalExpiryDateInput.value = testExpiry.toISOString().substring(0, 10);
                    modalAccountTypeInput.value = 'Test Hesabƒ±';
                    modalSubscriptionPeriodInput.value = 'Test (24 Saat)';
                } else {
                    // Orijinal s√ºreye geri d√∂n
                    const duration = modalRequestDuration.textContent || '12 Ay';
                    let months = 12;
                    if (duration.includes('3')) months = 3;
                    else if (duration.includes('6')) months = 6;
                    else if (duration.includes('15')) months = 15;
                    const expiry = new Date();
                    expiry.setMonth(expiry.getMonth() + months);
                    modalExpiryDateInput.value = expiry.toISOString().substring(0, 10);
                    modalAccountTypeInput.value = 'Standart Paket';
                    modalSubscriptionPeriodInput.value = duration;
                }
            });
        }

        // Modal Olaylarƒ±
        closeModalButton.addEventListener('click', closeModal);
        
        // X butonu ile modal kapatma
        const modalCloseXButton = document.getElementById('modalCloseXButton');
        if (modalCloseXButton) modalCloseXButton.addEventListener('click', closeModal);
        
        // Overlay tƒ±klama ile modal kapatma
        accountApprovalModal.addEventListener('click', (e) => {
            if (e.target === accountApprovalModal) closeModal();
        });

        // WhatsApp modal kapatma
        const closeWhatsappModalBtn = document.getElementById('closeWhatsappModalButton');
        if (closeWhatsappModalBtn) {
            closeWhatsappModalBtn.addEventListener('click', () => {
                document.getElementById('whatsappMessageModal').classList.add('hidden');
            });
        }
        const copyWhatsappMessageBtn = document.getElementById('copyWhatsappMessageButton');
        if (copyWhatsappMessageBtn) {
            copyWhatsappMessageBtn.addEventListener('click', () => {
                const output = document.getElementById('whatsappMessageOutput');
                if (output) { output.select(); document.execCommand('copy'); showMessage('Mesaj kopyalandƒ±!', 'success'); }
            });
        }
        saveApprovedAccountButton.addEventListener('click', saveApprovedAccount);
        
        // Hƒ±zlƒ± Ekleme Butonu (YENƒ∞)
        quickAddUserButton.addEventListener('click', quickAddUser);
        
        // URL G√ºncelleme Butonlarƒ± (AYRI)
        updateDomesticUrlButton.addEventListener('click', () => updateSingleGlobalUrl('domestic'));
        updateInternationalUrlButton.addEventListener('click', () => updateSingleGlobalUrl('international'));

        // M3U Base URL G√ºncelleme Butonlarƒ±
        updateM3uDomesticButton.addEventListener('click', () => updateM3uBaseUrl('domestic'));
        updateM3uInternationalButton.addEventListener('click', () => updateM3uBaseUrl('international'));

        // Fiyat G√ºncelleme (YENƒ∞)
        updatePriceListButton.addEventListener('click', updatePriceList);

        // Kullanƒ±cƒ± Listesi Yenileme
        refreshUserListButton.addEventListener('click', () => {
            currentFilter = 'all';
            userSearchInput.value = '';
            fetchAllUsers(true);
        });
        exportToExcelButton.addEventListener('click', exportToExcel);

        // Kullanƒ±cƒ± Y√∂netimi
        singleAddUserButton.addEventListener('click', singleAddUser); 
        sendBulkMessageButton.addEventListener('click', sendBulkMessage);

        // Konu≈üma sistemi event listener'larƒ±
        if (sendUserMessageButton) {
            sendUserMessageButton.addEventListener('click', sendUserMessage);
        }
        if (userMessageInput) {
            userMessageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendUserMessage();
                }
            });
        }
        if (sendAdminReplyButton) {
            sendAdminReplyButton.addEventListener('click', sendAdminReply);
        }
        if (adminReplyInput) {
            adminReplyInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAdminReply();
                }
            });
        }
        if (refreshConversationsButton) {
            refreshConversationsButton.addEventListener('click', fetchConversations);
        }

        // ƒ∞√ßerik Y√∂netimi dropdown - tƒ±klanƒ±nca kapat
        const contentDropdown = document.getElementById('contentDropdownMenu');
        if (contentDropdown) {
            contentDropdown.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => contentDropdown.classList.add('hidden'));
            });
            // Sayfa dƒ±≈üƒ±na tƒ±klanƒ±nca kapat
            document.addEventListener('click', (e) => {
                const wrapper = document.getElementById('contentManagementDropdown');
                if (wrapper && !wrapper.contains(e.target)) {
                    contentDropdown.classList.add('hidden');
                }
            });
        }
        copyQuickTemplateButton.addEventListener('click', () => {
            quickAddTemplate.select();
            document.execCommand('copy');
            showMessage('≈ûablon kopyalandƒ±!', 'success');
        }); // YENƒ∞

        // Metrik kartlarƒ±na tƒ±klama olaylarƒ±
        // Metrik kartlarƒ±na tƒ±klama
        document.querySelectorAll('.metric-card').forEach(card => {
            card.addEventListener('click', () => {
                currentFilter = card.dataset.filter;
                if (card.dataset.filter === 'renewal') {
                    showAdminView('managementTools');
                } else if (card.dataset.filter === 'newaccount') {
                    showAdminView('managementTools');
                } else {
                    showAdminView('registeredUsers');
                }
            });
        });

        // Kullanƒ±cƒ± D√ºzenleme/Silme
        editUserSelect.addEventListener('change', handleEditUserSelect);
        if (updateUserInfoButton) updateUserInfoButton.addEventListener('click', updateUserInfo);
        if (extendUserButton) extendUserButton.addEventListener('click', extendUserSubscription);
        deleteUserButton.addEventListener('click', deleteSelectedUser);
        // Abonelik periyodu deƒüi≈üince √∂nizleme g√ºncelle
        if (editSubscriptionPeriodInput) editSubscriptionPeriodInput.addEventListener('change', updateExtendPreview);

        // Mesaj Y√∂netimi (YENƒ∞)
        refreshMessagesButton.addEventListener('click', fetchAdminMessages);

        
        // Kullanƒ±cƒ±lar (YENƒ∞ SEKME ƒ∞≈ûLEMLERƒ∞)
        quickAddInput.addEventListener('change', () => {
            quickAddCustomInput.value = quickAddInput.value;
        });
        
        // Talep Y√∂netimi
        sendRenewalRequestButton.addEventListener('click', sendRenewalRequest);
        refreshRequestsButton.addEventListener('click', fetchRenewalRequests);
        refreshNewAccountRequestsButton.addEventListener('click', fetchNewAccountRequests);
        
        // Test Hesaplarƒ± Event Listener'ƒ±
        const refreshTestAccountsButton = document.getElementById('refreshTestAccountsButton');
        if (refreshTestAccountsButton) {
            refreshTestAccountsButton.addEventListener('click', fetchTestAccounts);
        }

        // Navigasyon
        navDashboard.addEventListener('click', () => showAdminView('dashboard'));
        navRegisteredUsers.addEventListener('click', () => showAdminView('registeredUsers')); 
        navUserManagement.addEventListener('click', () => showAdminView('managementTools')); 
        navPriceManagement.addEventListener('click', () => showAdminView('priceManagement')); // YENƒ∞
        navMessages.addEventListener('click', () => showAdminView('messages')); // YENƒ∞
        navUserInfo.addEventListener('click', () => showUserView('info')); 
        navUserRenewal.addEventListener('click', () => showUserView('renewal')); 
        navPriceList.addEventListener('click', () => showUserView('priceList')); // YENƒ∞
        navUserMessages.addEventListener('click', () => showUserView('messages')); // YENƒ∞
        
        // Arama giri≈üinde filtreleme
        userSearchInput.addEventListener('input', () => {
             currentFilter = userSearchInput.value ? 'search' : 'all';
             currentPage = 1; // Sayfayƒ± sƒ±fƒ±rla
             displayFilteredUsers(allUsersData, currentFilter);
        });

        // Kullanƒ±cƒ± Tipi Filtreleme Butonlarƒ±
        const filterAllUsersBtn = document.getElementById('filterAllUsersBtn');
        const filterDomesticUsersBtn = document.getElementById('filterDomesticUsersBtn');
        const filterInternationalUsersBtn = document.getElementById('filterInternationalUsersBtn');

        if (filterAllUsersBtn) {
            filterAllUsersBtn.addEventListener('click', () => {
                currentFilter = 'all';
                currentPage = 1;
                userSearchInput.value = '';
                // Buton stil g√ºncellemesi
                filterAllUsersBtn.classList.add('bg-gray-600', 'font-bold');
                filterDomesticUsersBtn.classList.remove('font-bold');
                filterInternationalUsersBtn.classList.remove('font-bold');
                displayFilteredUsers(allUsersData, 'all');
            });
        }

        if (filterDomesticUsersBtn) {
            filterDomesticUsersBtn.addEventListener('click', () => {
                currentFilter = 'domestic';
                currentPage = 1;
                userSearchInput.value = '';
                // Buton stil g√ºncellemesi
                filterAllUsersBtn.classList.remove('bg-gray-600', 'font-bold');
                filterDomesticUsersBtn.classList.add('font-bold');
                filterInternationalUsersBtn.classList.remove('font-bold');
                const domesticUsers = allUsersData.filter(u => u.userType === 'YURTICI');
                displayFilteredUsers(domesticUsers, 'domestic');
            });
        }

        if (filterInternationalUsersBtn) {
            filterInternationalUsersBtn.addEventListener('click', () => {
                currentFilter = 'international';
                currentPage = 1;
                userSearchInput.value = '';
                // Buton stil g√ºncellemesi
                filterAllUsersBtn.classList.remove('bg-gray-600', 'font-bold');
                filterDomesticUsersBtn.classList.remove('font-bold');
                filterInternationalUsersBtn.classList.add('font-bold');
                const intlUsers = allUsersData.filter(u => u.userType === 'YURTDISI');
                displayFilteredUsers(intlUsers, 'international');
            });
        }
        

        // iyzico Event Listeners
        const iyzicoAccordionToggle = document.getElementById('iyzicoAccordionToggle');
        if (iyzicoAccordionToggle) iyzicoAccordionToggle.addEventListener('click', toggleIyzicoAccordion);
        
        const saveIyzicoSettingsBtn = document.getElementById('saveIyzicoSettingsBtn');
        if (saveIyzicoSettingsBtn) saveIyzicoSettingsBtn.addEventListener('click', saveIyzicoSettings);
        
        const refreshIyzicoPaymentsBtn = document.getElementById('refreshIyzicoPaymentsBtn');
        if (refreshIyzicoPaymentsBtn) refreshIyzicoPaymentsBtn.addEventListener('click', loadIyzicoPaymentStats);
        
        const navIyzico = document.getElementById('navIyzico');
        if (navIyzico) navIyzico.addEventListener('click', () => showAdminView('iyzico'));
        
        const iyzicoPayButton = document.getElementById('iyzicoPayButton');
        if (iyzicoPayButton) iyzicoPayButton.addEventListener('click', processIyzicoPayment);
        
        const iyzicoCardNumber = document.getElementById('iyzicoCardNumber');
        if (iyzicoCardNumber) iyzicoCardNumber.addEventListener('input', function() { formatCardNumber(this); });
        
        const iyzicoCardExpiry = document.getElementById('iyzicoCardExpiry');
        if (iyzicoCardExpiry) iyzicoCardExpiry.addEventListener('input', function() { formatCardExpiry(this); });
        
        const iyzicoCardCvv = document.getElementById('iyzicoCardCvv');
        if (iyzicoCardCvv) iyzicoCardCvv.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').substring(0, 4);
        });

        // Uygulamayƒ± Ba≈ülat
        // ===============================================
        // EVENT LISTENERS (OLAY Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞)
        // ===============================================

        // Flatpickr'ƒ± ba≈ülat
        flatpickr("#singleExpiryDate, #editExpiryDate, #modalExpiryDate", {
            dateFormat: "Y-m-d",
            allowInput: true,
            locale: "tr",
        });

        // ===============================================
        // DARK MODE TOGGLE
        // ===============================================
        const darkToggle = document.getElementById('darkModeToggle');
        const darkIcon = document.getElementById('darkModeIcon');
        const lightIcon = document.getElementById('lightModeIcon');
        function applyDarkMode(isDark) {
            // Ge√ßi≈ü animasyonu ekle
            document.documentElement.classList.add('dark-transition');
            
            if (isDark) {
                document.documentElement.classList.add('dark');
                if (darkIcon) darkIcon.classList.add('hidden');
                if (lightIcon) lightIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                if (darkIcon) darkIcon.classList.remove('hidden');
                if (lightIcon) lightIcon.classList.add('hidden');
            }
            
            // Dark mode meta theme-color g√ºncelle
            const themeMetaTag = document.querySelector('meta[name="theme-color"]');
            if (themeMetaTag) {
                themeMetaTag.content = isDark ? '#1a1a2e' : '#f97316';
            }
            
            // Animasyonu temizle (performans i√ßin)
            setTimeout(() => {
                document.documentElement.classList.remove('dark-transition');
            }, 500);
        }
        // Sayfa a√ßƒ±lƒ±nca localStorage'den oku
        applyDarkMode(localStorage.getItem('darkMode') === 'true');
        if (darkToggle) {
            darkToggle.addEventListener('click', () => {
                const isDark = !document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
                applyDarkMode(isDark);
            });
        }

        // ===============================================
        // Y√ñNETƒ∞M ARA√áLARI ALT SEKMELERƒ∞
        // ===============================================
        window.switchMgmtTab = function(tab) {
            document.querySelectorAll('.mgmt-tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.mgmt-tab').forEach(b => {
                b.classList.remove('bg-orange-600', 'text-white');
                b.classList.add('text-orange-600');
            });
            if (tab === 'users') {
                document.getElementById('mgmtUsersContent').classList.remove('hidden');
                document.getElementById('mgmtTabUsers').classList.add('bg-orange-600', 'text-white');
                document.getElementById('mgmtTabUsers').classList.remove('text-orange-600');
            } else if (tab === 'revenue') {
                document.getElementById('mgmtRevenueContent').classList.remove('hidden');
                document.getElementById('mgmtTabRevenue').classList.add('bg-orange-600', 'text-white');
                document.getElementById('mgmtTabRevenue').classList.remove('text-orange-600');
                calculateRevenue();
            }
        };

        // ===============================================
        // GELƒ∞R/Gƒ∞DER HESAPLAMA Sƒ∞STEMƒ∞
        // ===============================================
        let eurTryRate = 0;
        let revenueBarChart = null;
        let revenuePieChart = null;
        let monthlyRevenueChart = null;
        let currentRevenuePeriod = 'month'; // 'month','3month','6month','12month','all'

        // Kredi tablosu: {key: {label, credit, priceListKey, isInternational, isDouble}}
        const CREDIT_MAP = {
            '3 Ay':       { label: '3 Aylƒ±k', credit: 1.5, plKey: 'single3M', intl: false, double: false },
            '6 Ay':       { label: '6 Aylƒ±k', credit: 2,   plKey: 'single6M', intl: false, double: false },
            '12 Ay':      { label: '12 Aylƒ±k', credit: 4,   plKey: 'single12M', intl: false, double: false },
            '15 Ay':      { label: '15 Aylƒ±k', credit: 5,   plKey: 'single15M', intl: false, double: false },
            '12 Ay √áift': { label: '12 Ay √áift Cihaz', credit: 8, plKey: 'double12M', intl: false, double: true },
            'YURTDISI_12':{ label: 'Yurtdƒ±≈üƒ± 12 Ay', credit: 4,   plKey: 'single12M', intl: true, double: false },
        };
        const EUR_PER_CREDIT = 3;

        async function fetchEurTryRate() {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
                const data = await res.json();
                eurTryRate = data.rates?.TRY || 0;
                const el = document.getElementById('eurTryRateValue');
                if (el) el.textContent = eurTryRate > 0 ? `1‚Ç¨ = ${eurTryRate.toFixed(2)} ‚Ç∫` : 'Alƒ±namadƒ±';
            } catch(e) {
                console.error('EUR/TRY kuru alƒ±namadƒ±', e);
                eurTryRate = 38; // fallback
                const el = document.getElementById('eurTryRateValue');
                if (el) el.textContent = `1‚Ç¨ ‚âà ${eurTryRate.toFixed(2)} ‚Ç∫ (tahmini)`;
            }
        }

        function getUserCreditInfo(user) {
            const period = user.subscriptionPeriod || '12 Ay';
            const uType = user.userType || 'YURTICI';
            const aType = user.accountType || 'Standart Paket';

            // Yurtdƒ±≈üƒ± kullanƒ±cƒ±
            if (uType === 'YURTDISI') {
                return CREDIT_MAP['YURTDISI_12'];
            }
            // √áift cihaz
            if (period.includes('√áift') || aType.includes('√áift') || aType.includes('Premium')) {
                return CREDIT_MAP['12 Ay √áift'];
            }
            // Normal yurti√ßi
            return CREDIT_MAP[period] || CREDIT_MAP['12 Ay'];
        }

        function getUserSalePrice(user, creditInfo) {
            if (!priceList || !priceList.domestic) return 0;
            if (creditInfo.intl) {
                // Yurtdƒ±≈üƒ±: EUR cinsinden * kur
                const eurPrice = priceList.international?.single12M || 50;
                return eurPrice * eurTryRate;
            }
            if (creditInfo.plKey) {
                return priceList.domestic[creditInfo.plKey] || 0;
            }
            // 24 Ay gibi fiyat listesinde yoksa tahmini
            return 0;
        }

        function renderCreditCostTable() {
            const tbody = document.getElementById('creditCostTableBody');
            if (!tbody) return;

            const costPerCreditTL = EUR_PER_CREDIT * eurTryRate;
            let rows = '';

            const packages = [
                { key: '3 Ay', saleTL: priceList.domestic?.single3M || 0 },
                { key: '6 Ay', saleTL: priceList.domestic?.single6M || 0 },
                { key: '12 Ay', saleTL: priceList.domestic?.single12M || 0 },
                { key: '15 Ay', saleTL: priceList.domestic?.single15M || 0 },
                { key: '12 Ay √áift', saleTL: priceList.domestic?.double12M || 0 },
                { key: 'YURTDISI_12', saleTL: (priceList.international?.single12M || 50) * eurTryRate },
            ];

            packages.forEach(pkg => {
                const cm = CREDIT_MAP[pkg.key];
                if (!cm) return;
                const costEUR = cm.credit * EUR_PER_CREDIT;
                const costTL = costEUR * eurTryRate;
                const profit = pkg.saleTL - costTL;
                const isIntl = cm.intl;
                const saleDisplay = isIntl
                    ? `${(priceList.international?.single12M || 50).toFixed(0)}‚Ç¨ (${pkg.saleTL.toFixed(0)} ‚Ç∫)`
                    : `${pkg.saleTL.toFixed(0)} ‚Ç∫`;
                const profitColor = profit >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                rows += `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-800">${cm.label}</td>
                    <td class="px-4 py-3 text-center text-purple-600 font-bold">${cm.credit}</td>
                    <td class="px-4 py-3 text-center">${costEUR.toFixed(1)}‚Ç¨</td>
                    <td class="px-4 py-3 text-center">${costTL.toFixed(0)} ‚Ç∫</td>
                    <td class="px-4 py-3 text-center">${saleDisplay}</td>
                    <td class="px-4 py-3 text-center ${profitColor}">${profit.toFixed(0)} ‚Ç∫</td>
                </tr>`;
            });
            tbody.innerHTML = rows;
        }

        window.setRevenuePeriod = function(period) {
            currentRevenuePeriod = period;
            document.querySelectorAll('.period-btn').forEach(b => {
                b.classList.remove('bg-orange-600', 'text-white');
                b.classList.add('text-orange-600', 'border', 'border-orange-300');
            });
            const btn = document.getElementById('periodBtn' + (period === 'all' ? 'All' : period === 'month' ? 'Month' : period === '3month' ? '3month' : period === '6month' ? '6month' : '12month'));
            if (btn) {
                btn.classList.add('bg-orange-600', 'text-white');
                btn.classList.remove('text-orange-600', 'border', 'border-orange-300');
            }
            calculateRevenue();
        };

        function getRevenueDateRange(period) {
            const now = new Date();
            let start, end;
            if (period === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else if (period === '3month') {
                start = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else if (period === '6month') {
                start = new Date(now.getFullYear(), now.getMonth() - 5, 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else if (period === '12month') {
                start = new Date(now.getFullYear(), now.getMonth() - 11, 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            } else {
                start = new Date(2026, 1, 1); // 01.02.2026 ba≈ülangƒ±√ß
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }
            return { start, end };
        }

        function getUserDate(user) {
            // Sadece createdAt kullan - lastUpdate herhangi bir d√ºzenleme i√ßin deƒüi≈üir
            const dateStr = user.createdAt;
            if (!dateStr) return null;
            return new Date(dateStr);
        }

        function getMonthKey(date) {
            const months = ['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
            return `${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function getMonthSortKey(date) {
            return date.getFullYear() * 100 + date.getMonth();
        }

        window.calculateRevenue = calculateRevenue;
        async function calculateRevenue() {
            if (eurTryRate === 0) await fetchEurTryRate();

            // Kredi maliyet tablosu
            renderCreditCostTable();

            // D√∂nem filtresi
            const { start, end } = getRevenueDateRange(currentRevenuePeriod);
            const dateRangeEl = document.getElementById('periodDateRange');
            if (dateRangeEl) {
                dateRangeEl.textContent = `üìÖ Se√ßili D√∂nem: ${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')}`;
            }

            // Abonelik loglarƒ±nƒ± Firestore'dan √ßek
            let logs = [];
            try {
                const logsRef = collection(db, `artifacts/${appId}/public/data/subscription_logs`);
                const logsSnap = await getDocs(logsRef);
                logsSnap.forEach(docSnap => {
                    logs.push({ id: docSnap.id, ...docSnap.data() });
                });
            } catch(e) {
                console.error('subscription_logs okunamadƒ±:', e);
            }

            // Eƒüer hi√ß log yoksa mevcut kullanƒ±cƒ±lardan hesapla (geriye d√∂n√ºk uyumluluk)
            const useFallback = logs.length === 0;
            let items = [];

            if (useFallback) {
                const allUsers = allUsersData || [];
                items = allUsers.map(user => {
                    const ci = getUserCreditInfo(user);
                    const sale = getUserSalePrice(user, ci);
                    const costTL = ci.credit * EUR_PER_CREDIT * eurTryRate;
                    return {
                        username: user.iptvUsername || '-',
                        userType: user.userType || 'YURTICI',
                        subscriptionPeriod: user.subscriptionPeriod || '12 Ay',
                        label: ci.label,
                        credits: ci.credit,
                        saleTL: sale,
                        costTL: costTL,
                        profitTL: sale - costTL,
                        date: getUserDate(user),
                        type: 'legacy'
                    };
                });
            } else {
                items = logs.map(log => {
                    const d = log.createdAt ? new Date(log.createdAt) : null;
                    const ci = CREDIT_MAP[log.subscriptionPeriod] || CREDIT_MAP['12 Ay'];
                    return {
                        username: log.username || '-',
                        userType: log.userType || 'YURTICI',
                        subscriptionPeriod: log.subscriptionPeriod || '12 Ay',
                        label: ci?.label || log.subscriptionPeriod,
                        credits: log.credits || ci?.credit || 0,
                        saleTL: log.saleTL || 0,
                        costTL: log.costTL || 0,
                        profitTL: log.profitTL || 0,
                        date: d,
                        type: log.type || 'extension'
                    };
                });
            }

            // D√∂neme g√∂re filtrele
            const filtered = items.filter(item => {
                if (!item.date) return currentRevenuePeriod === 'all';
                return item.date >= start && item.date <= end;
            });

            let totalRevenue = 0; let totalCredits = 0; let totalCost = 0;
            const typeCounts = {}; const typeRevenues = {};
            const monthlyData = {};
            let detailRows = '';

            filtered.forEach(item => {
                totalRevenue += item.saleTL;
                totalCredits += item.credits;
                totalCost += item.costTL;

                const label = item.label;
                typeCounts[label] = (typeCounts[label] || 0) + 1;
                typeRevenues[label] = (typeRevenues[label] || 0) + item.saleTL;

                if (item.date) {
                    const mk = getMonthKey(item.date);
                    const sk = getMonthSortKey(item.date);
                    if (!monthlyData[mk]) monthlyData[mk] = { sortKey: sk, count: 0, revenue: 0, cost: 0 };
                    monthlyData[mk].count++;
                    monthlyData[mk].revenue += item.saleTL;
                    monthlyData[mk].cost += item.costTL;
                }

                const profitCls = item.profitTL >= 0 ? 'text-green-600' : 'text-red-600';
                const dateStr = item.date ? item.date.toLocaleDateString('tr-TR') : '-';
                const typeIcon = item.type === 'new' ? 'üÜï' : (item.type === 'extension' ? 'üîÑ' : 'üìã');
                detailRows += `<tr class="hover:bg-gray-50 text-xs">
                    <td class="px-4 py-2 font-medium text-gray-800">${typeIcon} ${item.username}</td>
                    <td class="px-4 py-2 text-center text-gray-500">${dateStr}</td>
                    <td class="px-4 py-2 text-center">${item.userType === 'YURTDISI' ? 'üåç' : 'üáπüá∑'} ${item.userType}</td>
                    <td class="px-4 py-2 text-center">${item.label}</td>
                    <td class="px-4 py-2 text-center font-semibold">${item.saleTL.toFixed(0)} ‚Ç∫</td>
                    <td class="px-4 py-2 text-center text-purple-600">${item.credits}</td>
                    <td class="px-4 py-2 text-center">${item.costTL.toFixed(0)} ‚Ç∫</td>
                    <td class="px-4 py-2 text-center font-bold ${profitCls}">${item.profitTL >= 0 ? '+' : ''}${item.profitTL.toFixed(0)} ‚Ç∫</td>
                </tr>`;
            });

            // Kart g√ºncelle
            const netProfit = totalRevenue - totalCost;
            const margin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
            document.getElementById('totalRevenueTL').textContent = `${totalRevenue.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫`;
            document.getElementById('totalCostTL').textContent = `${totalCost.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫`;
            document.getElementById('totalCostCredits').textContent = `${totalCredits} Kredi √ó 3‚Ç¨`;
            document.getElementById('netProfitTL').textContent = `${netProfit.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫`;
            document.getElementById('profitMargin').textContent = `Kar Marjƒ±: %${margin}`;

            const sourceLabel = useFallback ? ' (kullanƒ±cƒ± verisi)' : ' (abonelik loglarƒ±)';
            document.getElementById('totalRevenueEUR').textContent = eurTryRate > 0 ? `‚âà ${(totalRevenue / eurTryRate).toFixed(0)} ‚Ç¨ ¬∑ ${filtered.length} kayƒ±t${sourceLabel}` : `${filtered.length} kayƒ±t${sourceLabel}`;

            // Detay tablosu
            const detailTbody = document.getElementById('revenueDetailTableBody');
            if (detailTbody) detailTbody.innerHTML = detailRows || '<tr><td colspan="8" class="text-center p-4 text-gray-500">Se√ßili d√∂nemde kayƒ±t bulunamadƒ±</td></tr>';

            // Aylƒ±k tablo
            renderMonthlyTable(monthlyData);

            // Grafikleri √ßiz
            renderRevenueCharts(typeCounts, typeRevenues);
            renderMonthlyChart(monthlyData);
        }

        function renderMonthlyTable(monthlyData) {
            const tbody = document.getElementById('monthlyRevenueTableBody');
            if (!tbody) return;
            const sorted = Object.entries(monthlyData).sort((a, b) => b[1].sortKey - a[1].sortKey);
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">Se√ßili d√∂nemde veri yok</td></tr>';
                return;
            }
            let rows = '';
            let grandRevenue = 0, grandCost = 0, grandCount = 0;
            sorted.forEach(([month, data]) => {
                const profit = data.revenue - data.cost;
                const cls = profit >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                grandRevenue += data.revenue;
                grandCost += data.cost;
                grandCount += data.count;
                rows += `<tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium text-gray-800">üìÖ ${month}</td>
                    <td class="px-4 py-3 text-center font-semibold">${data.count}</td>
                    <td class="px-4 py-3 text-center text-green-600 font-semibold">${data.revenue.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
                    <td class="px-4 py-3 text-center text-red-500">${data.cost.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
                    <td class="px-4 py-3 text-center ${cls}">${profit >= 0 ? '+' : ''}${profit.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
                </tr>`;
            });
            // Toplam satƒ±rƒ±
            const grandProfit = grandRevenue - grandCost;
            const grandCls = grandProfit >= 0 ? 'text-green-700 font-extrabold' : 'text-red-700 font-extrabold';
            rows += `<tr class="bg-gray-100 border-t-2 border-gray-300">
                <td class="px-4 py-3 font-extrabold text-gray-800">Œ£ TOPLAM</td>
                <td class="px-4 py-3 text-center font-extrabold">${grandCount}</td>
                <td class="px-4 py-3 text-center text-green-700 font-extrabold">${grandRevenue.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
                <td class="px-4 py-3 text-center text-red-700 font-extrabold">${grandCost.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
                <td class="px-4 py-3 text-center ${grandCls}">${grandProfit >= 0 ? '+' : ''}${grandProfit.toLocaleString('tr-TR', {maximumFractionDigits:0})} ‚Ç∫</td>
            </tr>`;
            tbody.innerHTML = rows;
        }

        function renderMonthlyChart(monthlyData) {
            const sorted = Object.entries(monthlyData).sort((a, b) => a[1].sortKey - b[1].sortKey);
            const labels = sorted.map(([m]) => m);
            const revenues = sorted.map(([, d]) => Math.round(d.revenue));
            const costs = sorted.map(([, d]) => Math.round(d.cost));
            const profits = sorted.map(([, d]) => Math.round(d.revenue - d.cost));

            const chartCtx = document.getElementById('monthlyRevenueChart');
            if (chartCtx && typeof Chart !== 'undefined') {
                if (monthlyRevenueChart) monthlyRevenueChart.destroy();
                monthlyRevenueChart = new Chart(chartCtx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Gelir (‚Ç∫)', data: revenues, backgroundColor: '#10b981', borderRadius: 6 },
                            { label: 'Maliyet (‚Ç∫)', data: costs, backgroundColor: '#ef4444', borderRadius: 6 },
                            { label: 'Net Kar (‚Ç∫)', data: profits, backgroundColor: '#3b82f6', borderRadius: 6 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: { y: { beginAtZero: true, ticks: { callback: v => v.toLocaleString('tr-TR') + ' ‚Ç∫' } } }
                    }
                });
            }
        }

        function renderRevenueCharts(typeCounts, typeRevenues) {
            const labels = Object.keys(typeCounts);
            const counts = Object.values(typeCounts);
            const revenues = Object.values(typeRevenues).map(v => Math.round(v));

            const colors = ['#f97316','#3b82f6','#10b981','#8b5cf6','#ef4444','#06b6d4','#f59e0b'];

            // Bar chart
            const barCtx = document.getElementById('revenueByTypeChart');
            if (barCtx && typeof Chart !== 'undefined') {
                if (revenueBarChart) revenueBarChart.destroy();
                revenueBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Kullanƒ±cƒ± Sayƒ±sƒ±', data: counts, backgroundColor: colors.slice(0, labels.length), borderRadius: 8 },
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: { legend: { display: true, position: 'bottom' } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            }

            // Pie chart
            const pieCtx = document.getElementById('revenuePieChart');
            if (pieCtx && typeof Chart !== 'undefined') {
                if (revenuePieChart) revenuePieChart.destroy();
                revenuePieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels,
                        datasets: [{
                            data: revenues,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2, borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: true,
                        plugins: {
                            legend: { display: true, position: 'bottom' },
                            title: { display: true, text: 'Gelir Daƒüƒ±lƒ±mƒ± (‚Ç∫)', font: { size: 14, weight: 'bold' } }
                        }
                    }
                });
            }
        }

        // ===== PWA KURULUM Y√ñNETƒ∞Mƒ∞ (DOMContentLoaded dƒ±≈üƒ±nda - erken yakalama) =====
        let deferredPrompt = null;
        let pwaInstallReady = false;

        // beforeinstallprompt olayƒ±nƒ± en erken yakalamak i√ßin hemen dinle
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] beforeinstallprompt yakalandƒ±!');
            e.preventDefault();
            deferredPrompt = e;
            pwaInstallReady = true;
            showPWAInstallBanner();
        });

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] Uygulama kuruldu!');
            deferredPrompt = null;
            pwaInstallReady = false;
            const banner = document.getElementById('pwaInstallBanner');
            const mini = document.getElementById('pwaInstallMini');
            if (banner) banner.classList.add('hidden');
            if (mini) mini.classList.add('hidden');
            localStorage.setItem('pwaInstalled', 'true');
        });

        function showPWAInstallBanner() {
            // Zaten kuruluysa g√∂sterme
            if (localStorage.getItem('pwaInstalled') === 'true') return;
            // Standalone modda a√ßƒ±ksa zaten kurulu
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;

            const banner = document.getElementById('pwaInstallBanner');
            const mini = document.getElementById('pwaInstallMini');

            // Bu oturumda kapatƒ±lmƒ±≈üsa sadece mini butonu g√∂ster
            if (sessionStorage.getItem('pwaInstallDismissed')) {
                if (mini) mini.classList.remove('hidden');
                return;
            }

            // Banner'ƒ± g√∂ster
            if (banner) banner.classList.remove('hidden');
        }

        async function triggerPWAInstall() {
            if (!deferredPrompt) {
                console.log('[PWA] deferredPrompt yok');
                return;
            }
            deferredPrompt.prompt();
            const result = await deferredPrompt.userChoice;
            console.log('[PWA] Kurulum sonucu:', result.outcome);
            deferredPrompt = null;
            const banner = document.getElementById('pwaInstallBanner');
            const mini = document.getElementById('pwaInstallMini');
            if (banner) banner.classList.add('hidden');
            if (mini) mini.classList.add('hidden');
        }

        // ===============================================
        // HESAP S√úRESƒ∞ GERƒ∞ SAYIM Sƒ∞STEMƒ∞
        // ===============================================
        let countdownInterval = null;
        
        function startCountdown(expirationDate) {
            const widget = document.getElementById('countdownWidget');
            if (!widget || !expirationDate) return;
            
            widget.classList.remove('hidden');
            
            // Geri sayƒ±m interval'i temizle
            if (countdownInterval) clearInterval(countdownInterval);
            
            const expiryDate = expirationDate?.toDate ? expirationDate.toDate() : new Date(expirationDate);
            const cdDays = document.getElementById('cdDays');
            const cdHours = document.getElementById('cdHours');
            const cdMins = document.getElementById('cdMins');
            const cdSecs = document.getElementById('cdSecs');
            const cdMsg = document.getElementById('countdownMessage');
            const cdDate = document.getElementById('countdownDate');
            const cdBar = document.getElementById('countdownBar');
            
            if (cdDate) {
                cdDate.textContent = `Biti≈ü: ${expiryDate.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}`;
            }
            
            // Toplam s√ºre (1 yƒ±l max) ‚Äî ilerleme √ßubuƒüu i√ßin
            const totalDuration = 365 * 24 * 60 * 60 * 1000;
            
            function updateCountdown() {
                const now = new Date();
                const diff = expiryDate - now;
                
                if (diff <= 0) {
                    // S√ºre dolmu≈ü
                    widget.className = 'countdown-widget mt-4 mb-4 expired';
                    if (cdDays) cdDays.textContent = '0';
                    if (cdHours) cdHours.textContent = '0';
                    if (cdMins) cdMins.textContent = '0';
                    if (cdSecs) cdSecs.textContent = '0';
                    if (cdMsg) cdMsg.textContent = '‚ùå √úyelik s√ºreniz dolmu≈ütur. L√ºtfen yenileme talebi g√∂nderin.';
                    if (cdBar) cdBar.style.width = '0%';
                    clearInterval(countdownInterval);
                    return;
                }
                
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                if (cdDays) cdDays.textContent = days;
                if (cdHours) cdHours.textContent = hours.toString().padStart(2, '0');
                if (cdMins) cdMins.textContent = minutes.toString().padStart(2, '0');
                if (cdSecs) cdSecs.textContent = seconds.toString().padStart(2, '0');
                
                // ƒ∞lerleme √ßubuƒüu
                const progressPercent = Math.min(100, Math.max(0, (diff / totalDuration) * 100));
                if (cdBar) cdBar.style.width = `${progressPercent}%`;
                
                // Son 7 g√ºn kala uyarƒ±
                if (days <= 7) {
                    widget.className = 'countdown-widget mt-4 mb-4 expiring-soon';
                    if (cdMsg) cdMsg.textContent = `‚ö†Ô∏è Son ${days} g√ºn! Kesinti ya≈üamamak i√ßin ≈üimdi uzatma talebi g√∂nderin.`;
                } else if (days <= 30) {
                    widget.className = 'countdown-widget mt-4 mb-4';
                    if (cdMsg) cdMsg.textContent = `üìÖ ${days} g√ºn kaldƒ±. Zamanƒ±nda uzatma yapmanƒ±zƒ± √∂neririz.`;
                } else {
                    widget.className = 'countdown-widget mt-4 mb-4';
                    if (cdMsg) cdMsg.textContent = `‚úÖ Aktif aboneliƒüiniz sorunsuz devam ediyor.`;
                }
            }
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        // ===============================================
        // SKELETON LOADING HELPERS
        // ===============================================
        function showUserSkeleton() {
            const skeleton = document.getElementById('userDataSkeleton');
            const container = document.getElementById('resultContainer');
            if (skeleton) skeleton.classList.remove('hidden');
            if (container) container.classList.add('hidden');
        }
        
        function hideUserSkeleton() {
            const skeleton = document.getElementById('userDataSkeleton');
            const container = document.getElementById('resultContainer');
            if (skeleton) skeleton.classList.add('hidden');
            if (container) container.classList.remove('hidden');
        }
        
        function showAdminListSkeleton() {
            const skeleton = document.getElementById('adminListSkeleton');
            const status = document.getElementById('listStatus');
            if (skeleton) skeleton.classList.remove('hidden');
            if (status) status.classList.add('hidden');
        }
        
        function hideAdminListSkeleton() {
            const skeleton = document.getElementById('adminListSkeleton');
            if (skeleton) skeleton.classList.add('hidden');
        }

        // ===============================================
        // ONLINE/OFFLINE ALGILAMA
        // ===============================================
        function updateOnlineStatus() {
            const banner = document.getElementById('offlineBanner');
            if (!banner) return;
            
            if (!navigator.onLine) {
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
        }
        
        window.addEventListener('online', () => {
            updateOnlineStatus();
            showRealtimeToast('üåê ƒ∞nternet baƒülantƒ±sƒ± kuruldu', 'success');
        });
        
        window.addEventListener('offline', () => {
            updateOnlineStatus();
        });

        // ===============================================
        // GER√áEK ZAMANLI Bƒ∞LDƒ∞Rƒ∞M TOAST
        // ===============================================
        function showRealtimeToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('realtimeNotifications');
            if (!container) return;
            
            const colors = {
                info: 'bg-blue-600',
                success: 'bg-green-600',
                warning: 'bg-yellow-500',
                error: 'bg-red-600'
            };
            
            const toast = document.createElement('div');
            toast.className = `realtime-notification ${colors[type] || colors.info} text-white px-4 py-3 rounded-xl shadow-2xl text-sm font-medium flex items-center gap-2 max-w-sm`;
            toast.innerHTML = `
                <span class="flex-grow">${message}</span>
                <button class="opacity-70 hover:opacity-100 text-lg leading-none" onclick="this.parentElement.remove()">‚úï</button>
            `;
            
            container.appendChild(toast);
            
            // Otomatik kaldƒ±r
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s, transform 0.3s';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ===============================================
        // GER√áEK ZAMANLI FIRESTORE Dƒ∞NLEME (onSnapshot)
        // ===============================================
        let userSnapshotUnsubscribe = null;
        let requestsSnapshotUnsubscribe = null;
        let messagesSnapshotUnsubscribe = null;
        
        function startRealtimeListeners() {
            // Admin: Yeni talep dinleme
            if (isAdminUser) {
                startAdminRealtimeListeners();
            }
        }
        
        function startAdminRealtimeListeners() {
            // Yenileme talepleri dinle
            try {
                const renewalRef = collection(db, `artifacts/${appId}/public/data/renewal_requests`);
                const renewalQuery = query(renewalRef, where('status', '==', 'Beklemede'));
                
                if (requestsSnapshotUnsubscribe) requestsSnapshotUnsubscribe();
                
                let isFirstSnapshot = true;
                requestsSnapshotUnsubscribe = onSnapshot(renewalQuery, (snapshot) => {
                    if (isFirstSnapshot) {
                        isFirstSnapshot = false;
                        return; // ƒ∞lk y√ºkleme - bildirim g√∂sterme
                    }
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            showRealtimeToast(`üì¢ Yeni uzatma talebi: ${data.username || 'Bilinmeyen'}`, 'warning', 6000);
                            
                            // Push notification da g√∂nder (varsa)
                            if (Notification.permission === 'granted') {
                                new Notification('Yeni Uzatma Talebi', {
                                    body: `${data.username} - ${data.requestDuration}`,
                                    icon: '/icons/icon-192.png',
                                    tag: 'renewal-' + change.doc.id
                                });
                            }
                        }
                    });
                }, (error) => {
                    console.warn('Talep dinleme hatasƒ±:', error);
                });
                
                // Yeni hesap talepleri dinle
                const newAccountRef = collection(db, `artifacts/${appId}/public/data/new_account_requests`);
                const newAccountQuery = query(newAccountRef, where('status', '==', 'Beklemede'));
                
                let isFirstAccountSnapshot = true;
                const unsubNewAccount = onSnapshot(newAccountQuery, (snapshot) => {
                    if (isFirstAccountSnapshot) {
                        isFirstAccountSnapshot = false;
                        return;
                    }
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            showRealtimeToast(`üÜï Yeni hesap talebi: ${data.fullName || 'Bilinmeyen'}`, 'info', 6000);
                            
                            if (Notification.permission === 'granted') {
                                new Notification('Yeni Hesap Talebi', {
                                    body: `${data.fullName} - ${data.requestDuration}`,
                                    icon: '/icons/icon-192.png',
                                    tag: 'new-account-' + change.doc.id
                                });
                            }
                        }
                    });
                }, (error) => {
                    console.warn('Yeni hesap dinleme hatasƒ±:', error);
                });
                
                // Eski unsubscribe'ƒ± g√ºncelle
                const oldUnsub = requestsSnapshotUnsubscribe;
                requestsSnapshotUnsubscribe = () => {
                    oldUnsub();
                    unsubNewAccount();
                };
                
            } catch (err) {
                console.warn('Realtime listener ba≈ülatma hatasƒ±:', err);
            }
        }
        
        function startUserRealtimeListener(username) {
            // Kullanƒ±cƒ±: Kendi mesajlarƒ±nƒ± dinle
            try {
                const messagesRef = collection(db, `artifacts/${appId}/public/data/messages`);
                
                if (messagesSnapshotUnsubscribe) messagesSnapshotUnsubscribe();
                
                let isFirstMsgSnapshot = true;
                messagesSnapshotUnsubscribe = onSnapshot(messagesRef, (snapshot) => {
                    if (isFirstMsgSnapshot) {
                        isFirstMsgSnapshot = false;
                        return;
                    }
                    
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            showRealtimeToast(`üí¨ Yeni mesaj: ${data.title || 'Y√∂neticiden mesaj'}`, 'info', 5000);
                            
                            if (Notification.permission === 'granted') {
                                new Notification('Yeni Mesaj', {
                                    body: data.title || 'Y√∂neticiden yeni bir mesaj aldƒ±nƒ±z.',
                                    icon: '/icons/icon-192.png',
                                    tag: 'message-' + change.doc.id
                                });
                            }
                        }
                    });
                }, (error) => {
                    console.warn('Mesaj dinleme hatasƒ±:', error);
                });
            } catch (err) {
                console.warn('User realtime listener hatasƒ±:', err);
            }
        }
        
        function stopRealtimeListeners() {
            if (requestsSnapshotUnsubscribe) { requestsSnapshotUnsubscribe(); requestsSnapshotUnsubscribe = null; }
            if (messagesSnapshotUnsubscribe) { messagesSnapshotUnsubscribe(); messagesSnapshotUnsubscribe = null; }
            if (userSnapshotUnsubscribe) { userSnapshotUnsubscribe(); userSnapshotUnsubscribe = null; }
        }

        // ===============================================
        // PUSH NOTIFICATION ƒ∞Zƒ∞N ƒ∞STEME
        // ===============================================
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                console.log('Bu tarayƒ±cƒ± bildirimleri desteklemiyor.');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            
            return false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // Online/Offline algƒ±lama
            updateOnlineStatus();
            
            // Bildirim izni iste (kullanƒ±cƒ± etkile≈üimi sonrasƒ±)
            document.addEventListener('click', function requestNotifOnce() {
                requestNotificationPermission();
                document.removeEventListener('click', requestNotifOnce);
            }, { once: true });

            // Eski 24 saat cooldown'ƒ± temizle
            localStorage.removeItem('pwaInstallDismissed');

            // PWA Service Worker Kayƒ±t
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => {
                        console.log('[PWA] SW kayƒ±tlƒ±:', reg.scope);
                        // SW g√ºncelleme kontrol√º
                        reg.update();
                    })
                    .catch(err => console.warn('[PWA] SW kayƒ±t hatasƒ±:', err));
            }

            // PWA Install buton olaylarƒ±
            const pwaInstallAccept = document.getElementById('pwaInstallAccept');
            const pwaInstallDismiss = document.getElementById('pwaInstallDismiss');
            const pwaInstallMini = document.getElementById('pwaInstallMini');

            if (pwaInstallAccept) {
                pwaInstallAccept.addEventListener('click', () => triggerPWAInstall());
            }

            if (pwaInstallDismiss) {
                pwaInstallDismiss.addEventListener('click', () => {
                    const banner = document.getElementById('pwaInstallBanner');
                    if (banner) banner.classList.add('hidden');
                    // Sadece bu oturum i√ßin gizle, yeni ziyarette tekrar g√∂ster
                    sessionStorage.setItem('pwaInstallDismissed', 'true');
                    // Mini butonu g√∂ster
                    if (pwaInstallMini) pwaInstallMini.classList.remove('hidden');
                });
            }

            if (pwaInstallMini) {
                pwaInstallMini.addEventListener('click', () => triggerPWAInstall());
            }

            // Eƒüer beforeinstallprompt DOMContentLoaded'dan √∂nce ate≈ülendiyse banner'ƒ± g√∂ster
            if (pwaInstallReady) {
                showPWAInstallBanner();
            }
        });

    </script>
</body>
</html>